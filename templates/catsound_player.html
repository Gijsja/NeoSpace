{% extends "base.html" %}

{% block content %}
<div class="h-full flex flex-col p-6 overflow-y-auto bg-gray-50">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-4xl font-black uppercase tracking-tighter" style="font-family: 'Space Grotesk', sans-serif;">
            CAT ORCHESTRA
        </h1>
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
            <span class="font-mono text-xs uppercase">Live Connection</span>
        </div>
    </div>

    <!-- Main Player Card -->
    <div class="nb-card p-8 bg-white max-w-4xl mx-auto w-full relative overflow-hidden">
        <!-- Retro decorative elements -->
        <div class="absolute top-0 right-0 w-32 h-32 bg-acid-green opacity-20 rounded-bl-[100px] pointer-events-none">
        </div>
        <div class="absolute bottom-0 left-0 w-24 h-24 bg-purple-500 opacity-20 rounded-tr-[80px] pointer-events-none">
        </div>

        <div class="relative z-10 flex flex-col gap-8">

            <!-- Track Selection -->
            <div class="flex flex-col gap-2">
                <label class="font-bold uppercase text-sm tracking-wide">Select Composition</label>
                <div class="relative group">
                    <select id="track-select"
                        class="w-full bg-gray-100 border-2 border-black p-4 font-mono text-lg focus:outline-none focus:shadow-[4px_4px_0_0_#000] transition-all appearance-none cursor-pointer">
                        <option value="/static/catsounds/neobrutal_cat_orchestra.mid">Opus 1: Neobrutal Cat Orchestra
                        </option>
                        <option value="/static/catsounds/synthwave_neubrutalist_cat_WITH_DRUMS.mid">Opus 2: Synthwave
                            Neubrutalist Cat (With Drums)</option>
                        <option value="/static/audio/night_drive.mid">Opus 3: Night Drive</option>
                    </select>
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none">
                        <i class="ph-bold ph-caret-down text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Visualizer Placeholder -->
            <div class="h-32 bg-black border-2 border-black p-1 flex items-end justify-between gap-0.5" id="visualizer">
                <!-- Bars generated by JS -->
            </div>

            <!-- Controls -->
            <div class="flex items-center justify-between gap-4 flex-wrap">
                <!-- Transport -->
                <div class="flex items-center gap-4">
                    <button id="play-btn"
                        class="nb-button px-8 py-3 bg-acid-green hover:bg-black hover:text-white flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ph-fill ph-play"></i>
                        <span>PLAY TRACK</span>
                    </button>
                    <button id="stop-btn"
                        class="nb-button px-6 py-3 bg-white hover:bg-gray-100 flex items-center gap-2">
                        <i class="ph-fill ph-stop"></i>
                        <span>STOP</span>
                    </button>
                </div>

                <!-- Progress -->
                <div class="flex-1 min-w-[200px] flex flex-col gap-1">
                    <div class="flex justify-between font-mono text-xs">
                        <span id="current-time">0:00</span>
                        <span id="total-time">--:--</span>
                    </div>
                    <input type="range" id="seek-slider" min="0" max="100" value="0" step="0.1"
                        class="w-full h-4 appearance-none bg-white border-2 border-black cursor-pointer focus:outline-none [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-[14px] [&::-webkit-slider-thumb]:bg-purple-500 [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-black [&::-moz-range-thumb]:appearance-none [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-[14px] [&::-moz-range-thumb]:bg-purple-500 [&::-moz-range-thumb]:border-2 [&::-moz-range-thumb]:border-black rounded-none">
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-indicator"
                class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-20">
                <div class="flex flex-col items-center gap-4">
                    <i class="ph-bold ph-spinner animate-spin text-4xl"></i>
                    <span class="font-bold font-mono">LOADING SOUNDFONT...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="mt-8 max-w-4xl mx-auto w-full text-center">
        <p class="font-mono text-sm text-gray-500">
            Powered by <a href="#" class="underline">midi-player-js</a> and <a href="#"
                class="underline">soundfont-player</a>.
            <br>
            Warning: Neobrutalism may cause spontaneous dancing.
        </p>
    </div>
</div>

<!-- Scripts -->
<script src="/static/vendor/midi-player.js"></script>
<script src="/static/vendor/soundfont-player.min.js"></script>

<script>
    document.addEventListener('alpine:init', () => {
        // Init logic if needed
    });

    document.addEventListener('DOMContentLoaded', async () => {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ac = new AudioContext();

        const Player = window.MidiPlayer.Player;
        const Soundfont = window.Soundfont;

        let instrument = null;
        let player = null;
        let isPlaying = false;

        const playBtn = document.getElementById('play-btn');
        const stopBtn = document.getElementById('stop-btn');
        const trackSelect = document.getElementById('track-select');
        const seekSlider = document.getElementById('seek-slider');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const loadingIndicator = document.getElementById('loading-indicator');
        const visualizer = document.getElementById('visualizer');

        // Visualizer setup
        const barCount = 30;
        for (let i = 0; i < barCount; i++) {
            const bar = document.createElement('div');
            bar.className = 'flex-1 bg-acid-green transition-all duration-75 ease-out';
            bar.style.height = '0%';
            visualizer.appendChild(bar);
        }
        const visualizerBars = Array.from(visualizer.children);

        let isDragging = false;

        // Update Visualizer
        function updateVisualizer(timestamp) {
            if (!isPlaying) return;

            const activeNotes = player.getEvents().filter(e => e.name === 'Note on' && e.velocity > 0);
            const totalVelocity = activeNotes.reduce((sum, note) => sum + note.velocity, 0);
            const avgVelocity = activeNotes.length > 0 ? totalVelocity / activeNotes.length : 0;

            const baseHeight = 10; // Minimum height for bars
            const maxAddedHeight = 90; // Maximum additional height for bars

            visualizerBars.forEach((bar, index) => {
                // Simple sine wave based on index for variation
                const wave = Math.sin(timestamp / 200 + index * 0.5) * 0.5 + 0.5; // 0 to 1
                const dynamicHeight = (avgVelocity / 127) * maxAddedHeight * wave;
                const height = Math.min(100, baseHeight + dynamicHeight);
                bar.style.height = `${height}%`;
            });

            requestAnimationFrame(updateVisualizer);
        }

        // Initialize Player Function
        function createPlayer() {
            return new Player({
                output: (event) => {
                    if (event.name == 'Note on' && instrument) {
                        instrument.play(event.noteName, ac.currentTime, {
                            gain: event.velocity / 127
                        });
                    }
                }
            });
        }

        function setupPlayerEvents() {
            // Events
            player.on('playing', (event) => {
                isPlaying = true;
                playBtn.innerHTML = '<i class="ph-fill ph-pause"></i><span>PAUSE</span>';
                // Start visualizer loop
                updateVisualizer(performance.now());
            });

            player.on('fileLoaded', () => {
                totalTimeEl.textContent = formatTime(player.getSongTime());
            });

            player.on('endOfFile', () => {
                isPlaying = false;
                playBtn.innerHTML = '<i class="ph-fill ph-play"></i><span>PLAY TRACK</span>';
                seekSlider.value = 0;
            });
        }

        // Load Track
        async function loadTrack(url) {
            try {
                // Stop existing player if it exists
                if (player) {
                    player.stop();
                    isPlaying = false;
                }

                // Create fresh player instance
                player = createPlayer();
                setupPlayerEvents();

                // Reset UI
                playBtn.innerHTML = '<i class="ph-fill ph-play"></i><span>PLAY TRACK</span>';
                seekSlider.value = 0;
                currentTimeEl.textContent = "0:00";

                // Fetch with cache busting
                const fetchUrl = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
                console.log("Fetching track:", fetchUrl);

                const response = await fetch(fetchUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const arrayBuffer = await response.arrayBuffer();
                console.log("Loading into player, bytes:", arrayBuffer.byteLength);
                player.loadArrayBuffer(arrayBuffer);

                console.log("Track loaded. Duration:", player.getSongTime());
                // Event listener for fileLoaded will handle time update, but good to be safe
                totalTimeEl.textContent = formatTime(player.getSongTime());

            } catch (e) {
                console.error("Track load failed:", e);
                alert("Failed to load track: " + e.message);
            }
        }

        // Initial setup
        // We don't construct player here anymore, it happens in loadTrack

        // Load Soundfont
        loadingIndicator.classList.remove('hidden');
        Soundfont.instrument(ac, 'acoustic_grand_piano', {
            gain: 0.8
        }).then((synth) => {
            instrument = synth;
            loadingIndicator.classList.add('hidden');
            console.log("Soundfont loaded.");
        }).catch(e => {
            console.error("Soundfont load failed:", e);
            alert("Failed to load soundfont: " + e.message);
            loadingIndicator.classList.add('hidden');
        });

        // Initial Load
        await loadTrack(trackSelect.value);

        // Polling for progress (midi-player-js doesn't emit distinct 'progress' events optimally)
        setInterval(() => {
            if (player && player.isPlaying() && !isDragging) {
                const p = 100 - player.getSongPercentRemaining();
                seekSlider.value = p;
                currentTimeEl.textContent = formatTime(player.getSongTime() - player.getSongTimeRemaining());
            }
        }, 100);

        playBtn.addEventListener('click', async () => {
            if (ac.state === 'suspended') {
                await ac.resume();
            }

            if (!player) return;

            if (player.isPlaying()) {
                player.pause();
                isPlaying = false;
                playBtn.innerHTML = '<i class="ph-fill ph-play"></i><span>RESUME</span>';
            } else {
                try {
                    player.play();
                    isPlaying = true;
                    playBtn.innerHTML = '<i class="ph-fill ph-pause"></i><span>PAUSE</span>';
                    updateVisualizer(performance.now());
                } catch (e) {
                    console.error("Play error:", e);
                    alert("Playback error: " + e);
                }
            }
        });

        stopBtn.addEventListener('click', () => {
            player.stop();
            isPlaying = false;
            playBtn.innerHTML = '<i class="ph-fill ph-play"></i><span>PLAY TRACK</span>';
            seekSlider.value = 0;
            currentTimeEl.textContent = "0:00";
        });

        trackSelect.addEventListener('change', async (e) => {
            player.stop();
            isPlaying = false;
            playBtn.innerHTML = '<i class="ph-fill ph-play"></i><span>PLAY TRACK</span>';
            seekSlider.value = 0;
            currentTimeEl.textContent = "0:00";
            await loadTrack(e.target.value);
        });

        // Slider Events
        seekSlider.addEventListener('input', () => {
            isDragging = true;
            const percent = seekSlider.value;
            currentTimeEl.textContent = formatTime(player.getSongTime() * (percent / 100));
        });

        seekSlider.addEventListener('change', () => {
            isDragging = false;
            const percent = seekSlider.value;
            const wasPlaying = player.isPlaying();

            player.skipToPercent(percent);

            if (wasPlaying) {
                player.play();
                isPlaying = true;
                playBtn.innerHTML = '<i class="ph-fill ph-pause"></i><span>PAUSE</span>';
                updateVisualizer(performance.now());
            }
        });

        function formatTime(seconds) {
            if (!seconds) return "0:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }
    });
</script>
{% endblock %}