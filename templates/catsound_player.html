{% extends "base.html" %}

{% block content %}
<div class="h-full flex flex-col p-6 overflow-y-auto bg-gray-50">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-4xl font-black uppercase tracking-tighter" style="font-family: 'Space Grotesk', sans-serif;">
            CAT ORCHESTRA
        </h1>
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
            <span class="font-mono text-xs uppercase">Live Connection</span>
        </div>
    </div>

    <!-- Main Player Card -->
    <div class="nb-card p-8 bg-white max-w-4xl mx-auto w-full relative overflow-hidden">
        <!-- Retro decorative elements -->
        <div class="absolute top-0 right-0 w-32 h-32 bg-acid-green opacity-20 rounded-bl-[100px] pointer-events-none">
        </div>
        <div class="absolute bottom-0 left-0 w-24 h-24 bg-purple-500 opacity-20 rounded-tr-[80px] pointer-events-none">
        </div>

        <div class="relative z-10 flex flex-col gap-8">

            <!-- Track Selection -->
            <div class="flex flex-col gap-2">
                <label class="font-bold uppercase text-sm tracking-wide">Select Composition</label>
                <div class="relative group">
                    <select id="track-select"
                        class="w-full bg-gray-100 border-2 border-black p-4 font-mono text-lg focus:outline-none focus:shadow-[4px_4px_0_0_#000] transition-all appearance-none cursor-pointer">
                        <option value="/static/catsounds/neobrutal_cat_orchestra.mid">Opus 1: Neobrutal Cat Orchestra
                        </option>
                        <option value="/static/catsounds/synthwave_neubrutalist_cat_WITH_DRUMS.mid">Opus 2: Synthwave
                            Neubrutalist Cat (With Drums)</option>
                    </select>
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none">
                        <i class="ph-bold ph-caret-down text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Visualizer Placeholder -->
            <div class="h-32 bg-black border-2 border-black p-1 flex items-end justify-between gap-0.5" id="visualizer">
                <!-- Bars generated by JS -->
            </div>

            <!-- Controls -->
            <div class="flex items-center justify-between gap-4 flex-wrap">
                <!-- Transport -->
                <div class="flex items-center gap-4">
                    <button id="play-btn"
                        class="nb-button px-8 py-3 bg-acid-green hover:bg-black hover:text-white flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ph-fill ph-play"></i>
                        <span>PLAY TRACK</span>
                    </button>
                    <button id="stop-btn"
                        class="nb-button px-6 py-3 bg-white hover:bg-gray-100 flex items-center gap-2">
                        <i class="ph-fill ph-stop"></i>
                        <span>STOP</span>
                    </button>
                </div>

                <!-- Progress -->
                <div class="flex-1 min-w-[200px] flex flex-col gap-1">
                    <div class="flex justify-between font-mono text-xs">
                        <span id="current-time">0:00</span>
                        <span id="total-time">--:--</span>
                    </div>
                    <div class="h-4 border-2 border-black bg-white relative cursor-pointer group"
                        id="progress-container">
                        <div id="progress-bar" class="h-full bg-purple-500 w-0 transition-all duration-100 ease-linear">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-indicator"
                class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-20">
                <div class="flex flex-col items-center gap-4">
                    <i class="ph-bold ph-spinner animate-spin text-4xl"></i>
                    <span class="font-bold font-mono">LOADING SOUNDFONT...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="mt-8 max-w-4xl mx-auto w-full text-center">
        <p class="font-mono text-sm text-gray-500">
            Powered by <a href="#" class="underline">midi-player-js</a> and <a href="#"
                class="underline">soundfont-player</a>.
            <br>
            Warning: Neobrutalism may cause spontaneous dancing.
        </p>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/midi-player-js@2.0.16/browser/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>

<script>
    document.addEventListener('alpine:init', () => {
        // Init logic if needed
    });

    document.addEventListener('DOMContentLoaded', async () => {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ac = new AudioContext();

        const Player = window.MidiPlayer.Player;
        const Soundfont = window.Soundfont;

        let instrument = null;
        let player = null;
        let isPlaying = false;

        const playBtn = document.getElementById('play-btn');
        const stopBtn = document.getElementById('stop-btn');
        const trackSelect = document.getElementById('track-select');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const loadingIndicator = document.getElementById('loading-indicator');
        const visualizer = document.getElementById('visualizer');

        // Generate visualizer bars
        for (let i = 0; i < 32; i++) {
            const bar = document.createElement('div');
            bar.className = 'flex-1 bg-acid-green transition-all duration-75';
            bar.style.height = '10%';
            visualizer.appendChild(bar);
        }

        function updateVisualizer() {
            if (!isPlaying) return;
            const bars = visualizer.children;
            for (let i = 0; i < bars.length; i++) {
                bars[i].style.height = Math.random() * 100 + '%';
            }
            requestAnimationFrame(updateVisualizer);
        }

        // Initialize Player
        // We use Soundfont player to handle proper instrument synthesis
        loadingIndicator.classList.remove('hidden');

        try {
            // Load a basic soundfont instrument (e.g. acoustic_grand_piano or synth options)
            // Ideally we map MIDI programs to instruments, but for simplicity we load a general one or set of them
            // For this MVP, we'll try to use a "Musyng Kite" or similar if available, or just standard
            instrument = await Soundfont.instrument(ac, 'acoustic_grand_piano');

            loadingIndicator.classList.add('hidden');
        } catch (e) {
            console.error("Soundfont load error", e);
            alert("Failed to load soundfont");
        }

        player = new Player((event) => {
            if (event.name === 'Note on' && event.velocity > 0) {
                instrument.play(event.noteName, ac.currentTime, { gain: event.velocity / 100 });
            }
        });

        // Load Track
        async function loadTrack(url) {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            player.loadArrayBuffer(arrayBuffer);
            totalTimeEl.textContent = formatTime(player.getSongTime());
        }

        // Initial Load
        await loadTrack(trackSelect.value);

        // Events
        player.on('playing', (event) => {
            isPlaying = true;
            playBtn.innerHTML = '<i class="ph-fill ph-pause"></i><span>PAUSE</span>';
            // Start visualizer loop
            updateVisualizer();

            // Update time
            const p = 100 - event.remaining / player.getSongTime() * 100; // This logic depends on library
            // midi-player-js 'playing' event gives tick, needs conversion. 
            // Better to use setInterval for UI updates
        });

        // Polling for progress (midi-player-js doesn't emit distinct 'progress' events optimally)
        setInterval(() => {
            if (player && player.isPlaying()) {
                const p = 100 - player.getSongPercentRemaining();
                progressBar.style.width = `${p}%`;
                currentTimeEl.textContent = formatTime(player.getSongTime() - player.getSongTimeRemaining());
            }
        }, 100);

        player.on('fileLoaded', () => {
            totalTimeEl.textContent = formatTime(player.getSongTime());
        });

        player.on('endOfFile', () => {
            isPlaying = false;
            playBtn.innerHTML = '<i class="ph-fill ph-play"></i><span>PLAY TRACK</span>';
            progressBar.style.width = '0%';
        });

        playBtn.addEventListener('click', () => {
            if (player.isPlaying()) {
                player.pause();
                isPlaying = false;
                playBtn.innerHTML = '<i class="ph-fill ph-play"></i><span>RESUME</span>';
            } else {
                player.play();
                isPlaying = true;
                playBtn.innerHTML = '<i class="ph-fill ph-pause"></i><span>PAUSE</span>';
                updateVisualizer();
            }
        });

        stopBtn.addEventListener('click', () => {
            player.stop();
            isPlaying = false;
            playBtn.innerHTML = '<i class="ph-fill ph-play"></i><span>PLAY TRACK</span>';
            progressBar.style.width = '0%';
        });

        trackSelect.addEventListener('change', async (e) => {
            player.stop();
            isPlaying = false;
            playBtn.innerHTML = '<i class="ph-fill ph-play"></i><span>PLAY TRACK</span>';
            await loadTrack(e.target.value);
        });

        function formatTime(seconds) {
            if (!seconds) return "0:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }
    });
</script>
{% endblock %}