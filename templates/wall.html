{% extends "base.html" %}

{% block title %}My Wall - NeoSpace{% endblock %}
{% block page_title %}Identity Grid{% endblock %}

{% block head %}
<!-- Scripts needed for Wall features -->
<!-- Vendored Assets -->
<script src="/static/vendor/mobile-drag-drop.min.js"></script>
<script>
    if (typeof MobileDragDrop !== 'undefined') {
        MobileDragDrop.polyfill({
            dragImageTranslateOverride: MobileDragDrop.scrollBehaviourDragImageTranslateOverride
        });
        window.addEventListener('touchmove', function () { }, { passive: false });
    }
</script>
<script src="/static/vendor/marked.min.js"></script>
<script src="/static/vendor/purify.min.js"></script>
<link rel="stylesheet" href="/static/vendor/highlight-atom-one-dark.min.css">
<script src="/static/vendor/highlight.min.js"></script>

<!-- Theme Stylesheets -->
<link rel="stylesheet" href="/static/css/themes/hacker.css" id="theme-hacker-css" disabled>

<script>
    // Initialize highlight.js
    hljs.highlightAll();
</script>
{% endblock %}

{% block content %}
<!-- Loading State -->
<div id="loading" class="flex flex-col items-center justify-center py-20 min-h-[50vh]">
    <div class="animate-spin text-4xl mb-4">
        <i class="ph-bold ph-spinner"></i>
    </div>
    <span
        class="font-mono text-xl font-bold uppercase tracking-widest border-2 border-black p-2 bg-white shadow-hard">Loading
        Identity Matrix...</span>
</div>

<!-- Main Wall Container -->
<div id="wall-container" class="hidden animate-fade-in space-y-8 pb-20 pt-4">

    <!-- 1. Identity Header (Neubrutalist Card) -->
    <div class="nb-card p-0 relative group">
        <!-- Banner Pattern -->
        <div class="h-32 bg-slate-900 border-b-2 border-black relative overflow-hidden">
            <!-- Abstract Pattern -->
            <div class="absolute inset-0 opacity-20"
                style="background-image: repeating-linear-gradient(45deg, #000 0, #000 10px, transparent 10px, transparent 20px);">
            </div>
        </div>

        <div class="relative p-6 pt-16 md:pt-6 md:pl-48">
            <!-- Avatar Glitch (Square, Offset) -->
            <div class="absolute -top-12 left-6 md:left-8 group/avatar">
                <div
                    class="w-32 h-32 bg-black absolute top-2 left-2 z-0 transition-transform group-hover/avatar:translate-x-0 group-hover/avatar:translate-y-0">
                </div>
                <div id="avatar-container"
                    class="w-32 h-32 bg-white border-2 border-black relative z-10 flex items-center justify-center overflow-hidden">
                    <span id="avatar-initial" class="text-6xl font-black text-slate-200">?</span>
                </div>

                <!-- Online Dot (Square) -->
                <div id="online-indicator"
                    class="absolute -bottom-1 -right-1 w-6 h-6 bg-acid-green border-2 border-black hidden"
                    title="Online"></div>

                <!-- Edit Button -->
                <button id="edit-avatar-btn"
                    class="absolute bottom-2 right-2 p-1 bg-white border-2 border-black hover:bg-hot-pink transition opacity-0 group-hover/avatar:opacity-100 z-20 hidden pointer-events-auto shadow-hard-sm">
                    <i class="ph-bold ph-camera"></i>
                </button>
            </div>

            <!-- Identity Info -->
            <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                <div>
                    <h1 class="text-4xl md:text-5xl font-black uppercase tracking-tighter text-black mb-1"
                        id="display-name">Loading...</h1>
                    <div class="flex items-center gap-3">
                        <p class="text-lg font-mono font-bold bg-black text-white px-2" id="username-handle">@...</p>
                        <button id="edit-profile-btn"
                            class="px-3 py-1 bg-white border-2 border-black hover:bg-yellow-300 text-xs font-bold uppercase transition hidden flex items-center gap-2 shadow-hard-sm active:translate-x-[2px] active:translate-y-[2px] active:shadow-none">
                            <i class="ph-bold ph-pencil-simple"></i> Edit Identity
                        </button>
                        <!-- Follow Button (Sprint 20) -->
                        <button id="follow-btn"
                            class="px-3 py-1 bg-black text-white border-2 border-black hover:bg-neutral-800 text-xs font-bold uppercase transition hidden shadow-hard-sm active:translate-x-[2px] active:translate-y-[2px] active:shadow-none">
                            FOLLOW
                        </button>
                        <!-- Voice Intro Section -->
                        <div id="voice-intro-section" class="hidden"></div>
                    </div>
                </div>

                <!-- Status Line (Raw Input Style) -->
                <div
                    class="relative w-full md:w-auto max-w-lg bg-white border-2 border-black p-3 shadow-hard-sm group hover:bg-warm-beige transition-colors">
                    <div class="flex items-start gap-3">
                        <span id="status-emoji"
                            class="text-3xl pt-0.5 filter grayscale group-hover:grayscale-0 transition">üëã</span>
                        <div class="flex-1">
                            <p id="status-message" class="text-lg font-bold leading-snug font-mono">...</p>
                            <p class="text-xs text-slate-500 mt-1 font-mono uppercase tracking-wider border-t border-black pt-1 inline-block"
                                id="status-label">Signal</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anthem Controls -->
            <div id="anthem-toggle" class="hidden absolute top-4 right-4 cursor-pointer group">
                <div
                    class="w-10 h-10 bg-white border-2 border-black hover:bg-hot-pink flex items-center justify-center transition-colors shadow-hard-sm">
                    <i id="anthem-icon" class="ph-bold ph-speaker-high text-xl"></i>
                </div>
            </div>
            <audio id="anthem-player" preload="auto" loop></audio>
        </div>
    </div>

    <!-- 2. Grid Layout -->
    <div class="grid grid-cols-1 md:grid-cols-12 gap-8">

        <!-- LEFT COLUMN (Sidebar info) - 3 cols -->
        <div class="col-span-1 md:col-span-3 space-y-6">

            <!-- "Now" Block (Yellow Card) -->
            <div class="nb-card p-4 bg-yellow-300 relative">
                <div class="flex items-center justify-between mb-2 border-b-2 border-black pb-2">
                    <h3 class="text-xs font-black uppercase tracking-widest flex items-center gap-2">
                        The Now
                    </h3>
                    <span id="now-activity-type-icon" class="text-black text-lg">
                        <i class="ph-fill ph-star"></i>
                    </span>
                </div>

                <p id="now-activity" class="font-mono font-bold text-lg leading-relaxed italic">
                    Loading...
                </p>

                <button id="edit-now-btn"
                    class="w-full mt-4 py-1.5 text-xs font-bold bg-white border-2 border-black hover:bg-black hover:text-white transition hidden uppercase">
                    Update
                </button>
            </div>

            <!-- Top 8 Grid (Sprint 20) -->
            <div id="top8-section" class="hidden">
                <h3 class="font-black uppercase text-xs tracking-wider mb-2 flex items-center gap-2">
                    The Top 8
                    <span class="bg-black text-white text-[10px] px-1 rounded">FRIENDS</span>
                </h3>
                <div id="top8-grid" class="grid grid-cols-4 gap-2">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Info Stats -->
            <div class="nb-card p-4">
                <h3 class="text-xs font-black uppercase tracking-wide border-b-2 border-black pb-2 mb-3">
                    Metadata
                </h3>
                <div class="space-y-2 text-sm font-mono">
                    <div class="flex justify-between items-center">
                        <span>Joined</span>
                        <span id="member-since" class="font-bold">...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Status</span>
                        <span class="px-1 bg-acid-green border border-black text-xs font-bold uppercase">Verified</span>
                    </div>
                </div>
            </div>

            <!-- Top Friends (Grid) -->
            <div class="nb-card p-4">
                <h3 class="text-xs font-black uppercase tracking-wide mb-4 border-b-2 border-black pb-2">
                    Top 8
                </h3>
                <div class="grid grid-cols-4 gap-2">
                    <!-- 8 placeholders -->
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                </div>
            </div>

        </div>

        <!-- RIGHT COLUMN (Content) - 9 cols -->
        <div class="col-span-1 md:col-span-9 space-y-8">

            <!-- Sticker Board (Guestbook) -->
            <div class="nb-card min-h-[250px] relative overflow-hidden group border-2 border-dashed border-black bg-white hover:bg-gray-50 transition"
                id="sticker-canvas">
                <div
                    class="absolute top-0 left-0 bg-black text-white px-3 py-1 text-xs font-bold uppercase tracking-wide z-20">
                    <i class="ph-bold ph-sticker"></i> Sticker Board
                </div>
                <div class="absolute bottom-2 right-2 text-[10px] font-mono text-gray-400 uppercase">Drag & Drop Enabled
                </div>

                <!-- Palette -->
                <div id="sticker-palette"
                    class="hidden absolute bottom-4 left-4 right-4 bg-white border-2 border-black p-2 z-30 shadow-hard overflow-x-auto flex gap-4 scrollbar-hide">
                </div>
            </div>

            <!-- Wall Modules (Masonry) -->
            <div id="wall-modules-section" class="hidden">
                <h3 class="text-xl font-black uppercase tracking-tighter mb-4 flex items-center gap-2">
                    <span class="bg-black text-white px-2">Feed</span> Stream
                </h3>
                <!-- The Grid (Masonry handled by columns utility) -->
                <div id="wall-modules-grid" class="columns-1 md:columns-2 lg:columns-3 gap-6 space-y-6">
                    <!-- Modules injected here -->
                </div>

                <!-- Pagination Load More -->
                <div id="wall-load-more-container" class="py-8 flex justify-center hidden">
                    <button id="btn-load-more"
                        class="nb-button px-6 py-3 bg-white border-2 border-black hover:bg-black hover:text-white transition shadow-hard font-bold uppercase tracking-widest flex items-center gap-2">
                        <i class="ph-bold ph-arrow-down"></i> Load More
                    </button>
                    <div id="loader-more" class="hidden animate-spin text-2xl"><i class="ph-bold ph-spinner"></i></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modals (Neubrutalist Style) -->

    <!-- Edit Profile Modal -->
    <div id="edit-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white border-2 border-black w-full max-w-lg shadow-hard-xl overflow-hidden animate-pop">
            <div class="p-4 border-b-2 border-black flex justify-between items-center bg-acid-green">
                <h2 class="font-black text-black uppercase flex items-center gap-2">
                    Edit Identity
                </h2>
                <button type="button"
                    class="close-modal w-8 h-8 flex items-center justify-center border-2 border-black bg-white hover:bg-black hover:text-white transition">
                    <i class="ph-bold ph-x text-lg"></i>
                </button>
            </div>
            <form id="edit-form" class="p-6 space-y-6 max-h-[80vh] overflow-y-auto custom-scrollbar">

                <!-- Avatar & Intro Group -->
                <div class="flex gap-4">
                    <div class="w-20 h-20 bg-gray-100 border-2 border-black flex items-center justify-center overflow-hidden shrink-0"
                        id="preview-avatar"></div>
                    <div class="flex-1 space-y-2">
                        <label
                            class="block text-xs uppercase font-bold text-black bg-yellow-200 inline-block px-1">Avatar
                            Image</label>
                        <input type="file" id="avatar-input" accept="image/*"
                            class="block w-full text-xs file:mr-2 file:py-2 file:px-3 file:border-2 file:border-black file:text-xs file:font-bold file:bg-white file:text-black hover:file:bg-black hover:file:text-white transition" />
                    </div>
                </div>

                <!-- Status -->
                <div class="space-y-2">
                    <label class="block text-xs uppercase font-bold text-black">Status Signal</label>
                    <div class="flex gap-2">
                        <input type="text" name="status_emoji" id="input-status-emoji"
                            class="nb-input w-20 text-center text-xl" placeholder="üëã" maxlength="4" />
                        <input type="text" name="status_message" id="input-status-msg" class="nb-input flex-1"
                            placeholder="What's your vibe?" maxlength="100" />
                    </div>
                </div>

                <!-- Now Block -->
                <div class="bg-yellow-50 p-4 border-2 border-black space-y-2">
                    <label class="block text-xs uppercase font-bold text-black flex items-center gap-2">
                        <i class="ph-bold ph-clock"></i> The "Now" Block
                    </label>
                    <div class="grid grid-cols-3 gap-2">
                        <select name="now_activity_type" id="input-now-type"
                            class="col-span-1 bg-white border-2 border-black h-10 px-2 text-xs font-bold focus:outline-none">
                            <option value="thinking">Thinking</option>
                            <option value="listening">Listening</option>
                            <option value="working">Working</option>
                            <option value="playing">Playing</option>
                            <option value="reading">Reading</option>
                            <option value="watching">Watching</option>
                        </select>
                        <input type="text" name="now_activity" id="input-now-activity" class="col-span-2 nb-input h-10"
                            placeholder="e.g. Creating art..." maxlength="50" />
                    </div>
                </div>

                <!-- Basic Info -->
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-xs uppercase font-bold mb-1.5">Display Name</label>
                        <input type="text" name="display_name" id="input-name" class="nb-input" required
                            maxlength="50" />
                    </div>
                    <input type="hidden" name="bio" id="input-bio">
                </div>

                <!-- Anthem -->
                <div class="p-4 border-2 border-black bg-white space-y-2 shadow-hard-sm">
                    <label class="block text-xs uppercase font-bold flex items-center gap-2">
                        <i class="ph-bold ph-music-notes"></i> Anthem (MP3/URL)
                    </label>
                    <input type="url" name="anthem_url" id="input-anthem-url" class="nb-input"
                        placeholder="https://example.com/song.mp3" />
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="anthem_autoplay" id="input-anthem-autoplay"
                            class="w-4 h-4 border-2 border-black text-black focus:ring-0 rounded-none" />
                        <span class="text-xs font-bold uppercase">Autoplay</span>
                    </label>
                </div>

                <!-- Settings -->
                <div class="pt-4 border-t-2 border-black space-y-2">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" name="is_public" id="input-public"
                            class="w-4 h-4 border-2 border-black text-black focus:ring-0 rounded-none" />
                        <span class="text-sm font-bold">Public Profile</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" name="show_online_status" id="input-online"
                            class="w-4 h-4 border-2 border-black text-black focus:ring-0 rounded-none" />
                        <span class="text-sm font-bold">Show Online Indicator</span>
                    </label>
                    <input type="hidden" name="accent_color" id="input-accent" value="#a3e635">

                    <!-- Theme Selector -->
                    <div class="pt-4 border-t-2 border-black">
                        <label class="block text-xs uppercase font-bold mb-2 flex items-center gap-2">
                            <i class="ph-bold ph-paint-brush"></i> Wall Theme
                        </label>
                        <select name="theme_preset" id="input-theme" class="nb-input h-10 bg-white">
                            <option value="default">Default (Brutalist)</option>
                            <option value="hacker">üñ•Ô∏è Hacker Terminal</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button type="button"
                        class="close-modal px-4 py-2 text-sm font-bold uppercase border-2 border-transparent hover:border-black transition">Cancel</button>
                    <button type="submit"
                        class="nb-button px-6 py-2 bg-acid-green hover:bg-hot-pink flex items-center gap-2">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Module FAB (Brutalist Square) -->
    <button id="add-module-btn"
        class="fixed bottom-8 right-8 z-40 w-14 h-14 bg-electric-blue border-2 border-black hover:bg-hot-pink flex items-center justify-center shadow-hard transition-transform active:translate-x-[4px] active:translate-y-[4px] active:shadow-none group hidden">
        <i class="ph-bold ph-plus text-2xl"></i>
    </button>

    <!-- Add Module Modal -->
    <div id="add-module-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white border-2 border-black w-full max-w-md shadow-hard-xl overflow-hidden animate-pop">
            <div class="p-4 border-b-2 border-black flex justify-between items-center bg-electric-blue">
                <h2 class="font-black text-black uppercase flex items-center gap-2">
                    Add Content
                </h2>
                <button type="button"
                    class="close-add-modal w-8 h-8 flex items-center justify-center border-2 border-black bg-white hover:bg-black hover:text-white transition">
                    <i class="ph-bold ph-x text-lg"></i>
                </button>
            </div>

            <div class="grid grid-cols-4 gap-2 p-4 border-b-2 border-black bg-white" id="module-type-selector">
                <button data-type="text"
                    class="module-type-btn active flex flex-col items-center gap-1 p-2 border-2 border-transparent hover:border-black hover:shadow-hard-sm transition">
                    <i class="ph-duotone ph-text-t text-xl"></i>
                    <span class="text-[10px] font-bold uppercase">Text</span>
                </button>
                <button data-type="image"
                    class="module-type-btn flex flex-col items-center gap-1 p-2 border-2 border-transparent hover:border-black hover:shadow-hard-sm transition">
                    <i class="ph-duotone ph-image text-xl"></i>
                    <span class="text-[10px] font-bold uppercase">Image</span>
                </button>
                <button data-type="link"
                    class="module-type-btn flex flex-col items-center gap-1 p-2 border-2 border-transparent hover:border-black hover:shadow-hard-sm transition">
                    <i class="ph-duotone ph-link text-xl"></i>
                    <span class="text-[10px] font-bold uppercase">Link</span>
                </button>
                <button data-type="audio"
                    class="module-type-btn flex flex-col items-center gap-1 p-2 border-2 border-transparent hover:border-black hover:shadow-hard-sm transition">
                    <i class="ph-duotone ph-music-notes text-xl"></i>
                    <span class="text-[10px] font-bold uppercase">Audio</span>
                </button>
            </div>

            <form id="add-module-form" class="p-4 space-y-4">
                <input type="hidden" name="module_type" id="new-module-type" value="text">

                <div id="fields-text" class="space-y-2">
                    <label class="block text-xs uppercase font-bold">Content (Markdown)</label>
                    <textarea name="text_content" class="nb-input h-32 custom-scrollbar"
                        placeholder="# Hello World..."></textarea>
                </div>

                <div id="fields-image" class="space-y-2 hidden">
                    <label class="block text-xs uppercase font-bold">Image URL</label>
                    <input type="url" name="image_url" class="nb-input" placeholder="https://..." />
                </div>

                <div id="fields-link" class="space-y-2 hidden">
                    <label class="block text-xs uppercase font-bold">Link URL</label>
                    <input type="url" name="link_url" class="nb-input" placeholder="https://..." />
                    <label class="block text-xs uppercase font-bold">Title (Optional)</label>
                    <input type="text" name="link_title" class="nb-input" placeholder="Link Title" />

                    <label class="block text-xs uppercase font-bold">Thumbnail URL (Optional)</label>
                    <input type="url" name="link_thumb" class="nb-input" placeholder="https://example.com/image.jpg" />

                    <label class="block text-xs uppercase font-bold">Display Style</label>
                    <select name="link_style" class="nb-input h-10 bg-white border-2 border-black focus:outline-none">
                        <option value="simple">Simple Row</option>
                        <option value="button">Button</option>
                        <option value="card">Card (Large Image)</option>
                    </select>
                </div>

                <div id="fields-audio" class="space-y-2 hidden">
                    <label class="block text-xs uppercase font-bold">Audio URL (MP3)</label>
                    <input type="url" name="audio_url" class="nb-input" placeholder="https://..." />
                    <label class="block text-xs uppercase font-bold">Caption (Optional)</label>
                    <input type="text" name="audio_title" class="nb-input" placeholder="Song Title" />
                </div>

                <div class="flex justify-end pt-2">
                    <button type="submit"
                        class="nb-button px-6 py-2 bg-electric-blue hover:bg-hot-pink flex items-center gap-2">
                        <i class="ph-bold ph-plus"></i> Add
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<!-- Voice Support -->
<script src="/ui/js/voice.js"></script>
<!-- Wall Logic -->
<script src="/ui/js/friends.js"></script> <!-- Sprint 20 -->
<!-- <script src="/ui/js/wall.js"></script> -->
<script type="module" src="/ui/js/wall/WallMain.js"></script>

<script>
    // Force init
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof fetchProfile === 'function') fetchProfile();
    });

    // Module Type Toggle Logic (Brutalist Style)
    document.querySelectorAll('.module-type-btn').forEach(btn => {
        btn.onclick = (e) => {
            e.preventDefault();
            // styling
            document.querySelectorAll('.module-type-btn').forEach(b => {
                b.classList.remove('active', 'border-black', 'bg-acid-green', 'shadow-hard-sm');
                b.classList.add('border-transparent');
            });
            btn.classList.remove('border-transparent');
            btn.classList.add('active', 'border-black', 'bg-acid-green', 'shadow-hard-sm');

            // value
            const type = btn.dataset.type;
            document.getElementById('new-module-type').value = type;

            // fields
            ['text', 'image', 'link', 'audio'].forEach(t => {
                const el = document.getElementById(`fields-${t}`);
                if (el) {
                    if (t === type) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            });
        };
    });

    // Close Add Modal
    document.querySelectorAll('.close-add-modal').forEach(b => {
        b.onclick = () => {
            document.getElementById('add-module-modal').classList.add('hidden');
        };
    });

    // Open Add Modal bound to FAB
    document.getElementById('add-module-btn').addEventListener('click', () => {
        document.getElementById('add-module-form').reset();
        delete document.getElementById('add-module-form').dataset.editId;
        // Trigger click on text type to reset
        document.querySelector('.module-type-btn[data-type="text"]').click();
        document.getElementById('add-module-modal').classList.remove('hidden');
    });
</script>
{% endblock %}