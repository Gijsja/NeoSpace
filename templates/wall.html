{% extends "base.html" %}

{% block title %}My Wall - NeoSpace{% endblock %}
{% block page_title %}Identity Grid{% endblock %}

{% block head %}
<!-- Scripts needed for Wall features -->
<!-- Vendored Assets -->
<script src="/static/vendor/mobile-drag-drop.min.js"></script>
<script>
    if (typeof MobileDragDrop !== 'undefined') {
        MobileDragDrop.polyfill({
            dragImageTranslateOverride: MobileDragDrop.scrollBehaviourDragImageTranslateOverride
        });
        window.addEventListener('touchmove', function () { }, { passive: false });
    }
</script>
<script src="/static/vendor/marked.min.js"></script>
<script src="/static/vendor/purify.min.js"></script>
<link rel="stylesheet" href="/static/vendor/highlight-atom-one-dark.min.css">
<script src="/static/vendor/highlight.min.js"></script>

<!-- Theme Stylesheets -->
<link rel="stylesheet" href="/static/css/themes/hacker.css" id="theme-hacker-css" disabled>

<script>
    // Initialize highlight.js
    hljs.highlightAll();
</script>
{% endblock %}

{% block content %}
{% from "components/ui_macros.html" import button, input, card, badge, textarea, select %}
{% from "components/skeleton.html" import skeleton %}
<!-- Loading State -->
<!-- Loading State (Skeleton) -->
<div id="loading" class="animate-pulse space-y-8 pb-20 pt-4">
    <!-- Header Skeleton -->
    <div class="nb-card p-0 h-64 relative bg-gray-100 border-2 border-transparent">
        <div class="absolute bottom-6 left-8 md:left-48 space-y-2">
            {{ skeleton('h-10 w-64 bg-gray-300') }}
            {{ skeleton('h-6 w-32 bg-gray-300') }}
        </div>
        <div class="absolute -top-12 left-8 w-32 h-32 bg-gray-200 border-2 border-white"></div>
    </div>

    <!-- Grid Skeleton -->
    <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
        <div class="col-span-1 md:col-span-3 space-y-6">
            {{ skeleton('h-48 w-full') }}
            {{ skeleton('h-32 w-full') }}
        </div>
        <div class="col-span-1 md:col-span-9 space-y-6">
            {{ skeleton('h-32 w-full') }}
            {{ skeleton('h-64 w-full') }}
            {{ skeleton('h-64 w-full') }}
        </div>
    </div>
</div>

<!-- Main Wall Container -->
<div id="wall-container" class="hidden animate-fade-in space-y-8 pb-20 pt-4">

    <!-- 1. Identity Header (Neubrutalist Card) -->
    <div class="nb-card p-0 relative group">
        <!-- Banner Pattern -->
        <div class="h-32 bg-slate-900 border-b-2 border-black relative overflow-hidden">
            <!-- Abstract Pattern -->
            <div class="absolute inset-0 opacity-20"
                style="background-image: repeating-linear-gradient(45deg, #000 0, #000 10px, transparent 10px, transparent 20px);">
            </div>
        </div>

        <div class="relative p-6 pt-16 md:pt-6 md:pl-48">
            <!-- Avatar Glitch (Square, Offset) -->
            <div class="absolute -top-12 left-6 md:left-8 group/avatar">
                <div
                    class="w-32 h-32 bg-black absolute top-2 left-2 z-0 transition-transform group-hover/avatar:translate-x-0 group-hover/avatar:translate-y-0">
                </div>
                <div id="avatar-container"
                    class="w-32 h-32 bg-white border-2 border-black relative z-10 flex items-center justify-center overflow-hidden">
                    <span id="avatar-initial" class="text-6xl font-black text-slate-200">?</span>
                </div>

                <!-- Online Dot (Square) -->
                <div id="online-indicator"
                    class="absolute -bottom-1 -right-1 w-6 h-6 bg-acid-green border-2 border-black hidden"
                    title="Online"></div>

                <!-- Edit Button -->
                <button id="edit-avatar-btn"
                    class="absolute bottom-2 right-2 p-1 bg-white border-2 border-black hover:bg-hot-pink transition opacity-0 group-hover/avatar:opacity-100 z-20 hidden pointer-events-auto shadow-hard-sm">
                    <i class="ph-bold ph-camera"></i>
                </button>
            </div>

            <!-- Identity Info -->
            <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                <div>
                    <h1 class="text-4xl md:text-5xl font-black uppercase tracking-tighter text-black mb-1"
                        id="display-name">Loading...</h1>
                    <div class="flex items-center gap-3">
                        <p class="text-lg font-mono font-bold bg-black text-white px-2" id="username-handle">@...</p>
                        {{ button('Edit Identity', variant='secondary', size='sm', icon='ph-bold ph-pencil-simple',
                        attrs='id="edit-profile-btn"', class='hidden flex hover:bg-yellow-300') }}
                        <!-- Follow Button (Sprint 20) -->
                        {{ button('FOLLOW', variant='primary', size='sm', attrs='id="follow-btn"', class='bg-black
                        text-white hover:bg-neutral-800 hidden') }}
                        <!-- Voice Intro Section -->
                        <div id="voice-intro-section" class="hidden"></div>
                    </div>
                </div>

                <!-- Status Line (Raw Input Style) -->
                <div
                    class="relative w-full md:w-auto max-w-lg bg-white border-2 border-black p-3 shadow-hard-sm group hover:bg-warm-beige transition-colors">
                    <div class="flex items-start gap-3">
                        <span id="status-emoji"
                            class="text-3xl pt-0.5 filter grayscale group-hover:grayscale-0 transition">üëã</span>
                        <div class="flex-1">
                            <p id="status-message" class="text-lg font-bold leading-snug font-mono">...</p>
                            <p class="text-xs text-slate-500 mt-1 font-mono uppercase tracking-wider border-t border-black pt-1 inline-block"
                                id="status-label">Signal</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anthem Controls -->
            <div id="anthem-toggle" class="hidden absolute top-4 right-4 cursor-pointer group">
                <div
                    class="w-10 h-10 bg-white border-2 border-black hover:bg-hot-pink flex items-center justify-center transition-colors shadow-hard-sm">
                    <i id="anthem-icon" class="ph-bold ph-speaker-high text-xl"></i>
                </div>
            </div>
            <audio id="anthem-player" preload="auto" loop></audio>
        </div>
    </div>

    <!-- 2. Grid Layout -->
    <div class="grid grid-cols-1 md:grid-cols-12 gap-8">

        <!-- LEFT COLUMN (Sidebar info) - 3 cols -->
        <div class="col-span-1 md:col-span-3 space-y-6">

            <!-- "Now" Block (Yellow Card) -->
            <div class="nb-card p-4 bg-yellow-300 relative">
                <div class="flex items-center justify-between mb-2 border-b-2 border-black pb-2">
                    <h3 class="text-xs font-black uppercase tracking-widest flex items-center gap-2">
                        The Now
                    </h3>
                    <span id="now-activity-type-icon" class="text-black text-lg">
                        <i class="ph-fill ph-star"></i>
                    </span>
                </div>

                <p id="now-activity" class="font-mono font-bold text-lg leading-relaxed italic">
                    Loading...
                </p>

                {{ button('Update', variant='secondary', size='sm', attrs='id="edit-now-btn"', class='w-full mt-4 hidden
                hover:bg-black hover:text-white uppercase') }}
            </div>

            <!-- Top 8 Grid (Sprint 20) -->
            <div id="top8-section" class="hidden">
                <h3 class="font-black uppercase text-xs tracking-wider mb-2 flex items-center gap-2">
                    The Top 8
                    <span class="bg-black text-white text-[10px] px-1 rounded">FRIENDS</span>
                </h3>
                <div id="top8-grid" class="grid grid-cols-4 gap-2">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Info Stats -->
            <div class="nb-card p-4">
                <h3 class="text-xs font-black uppercase tracking-wide border-b-2 border-black pb-2 mb-3">
                    Metadata
                </h3>
                <div class="space-y-2 text-sm font-mono">
                    <div class="flex justify-between items-center">
                        <span>Joined</span>
                        <span id="member-since" class="font-bold">...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Status</span>
                        <span class="px-1 bg-acid-green border border-black text-xs font-bold uppercase">Verified</span>
                    </div>
                </div>
            </div>

            <!-- Top Friends (Grid) -->
            <div class="nb-card p-4">
                <h3 class="text-xs font-black uppercase tracking-wide mb-4 border-b-2 border-black pb-2">
                    Top 8
                </h3>
                <div class="grid grid-cols-4 gap-2">
                    <!-- 8 placeholders -->
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                    <div
                        class="aspect-square bg-gray-200 border-2 border-black hover:bg-hot-pink transition cursor-pointer">
                    </div>
                </div>
            </div>

        </div>

        <!-- RIGHT COLUMN (Content) - 9 cols -->
        <div class="col-span-1 md:col-span-9 space-y-8">

            <!-- Sticker Board (Guestbook) -->
            <div class="nb-card min-h-[250px] relative overflow-hidden group border-2 border-dashed border-black bg-white hover:bg-gray-50 transition"
                id="sticker-canvas">
                <div
                    class="absolute top-0 left-0 bg-black text-white px-3 py-1 text-xs font-bold uppercase tracking-wide z-20">
                    <i class="ph-bold ph-sticker"></i> Sticker Board
                </div>
                <div class="absolute bottom-2 right-2 text-[10px] font-mono text-gray-400 uppercase">Drag & Drop Enabled
                </div>

                <!-- Palette -->
                <div id="sticker-palette"
                    class="hidden absolute bottom-4 left-4 right-4 bg-white border-2 border-black p-2 z-30 shadow-hard overflow-x-auto flex gap-4 scrollbar-hide">
                </div>
            </div>

            <!-- Wall Modules (Masonry) -->
            <div id="wall-modules-section" class="hidden">
                <h3 class="text-xl font-black uppercase tracking-tighter mb-4 flex items-center gap-2">
                    <span class="bg-black text-white px-2">Feed</span> Stream
                </h3>
                <!-- The Grid (Masonry handled by columns utility) -->
                <div id="wall-modules-grid" class="columns-1 md:columns-2 lg:columns-3 gap-6 space-y-6">
                    <!-- Modules injected here -->
                </div>

                <!-- Pagination Load More -->
                <div id="wall-load-more-container" class="py-8 flex justify-center hidden">
                    <button id="btn-load-more"
                        class="nb-button px-6 py-3 bg-white border-2 border-black hover:bg-black hover:text-white transition shadow-hard font-bold uppercase tracking-widest flex items-center gap-2">
                        <i class="ph-bold ph-arrow-down"></i> Load More
                    </button>
                    <div id="loader-more" class="hidden animate-spin text-2xl"><i class="ph-bold ph-spinner"></i></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modals (Neubrutalist Style) -->

    <!-- Edit Profile Modal -->
    <div id="edit-modal" x-data="{ open: false }" x-show="open" style="display: none;"
        @open-edit-modal.window="open = true" @close-edit-modal.window="open = false"
        @keydown.escape.window="open = false" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white border-2 border-black w-full max-w-lg shadow-hard-xl overflow-hidden animate-pop">
            <div class="p-4 border-b-2 border-black flex justify-between items-center bg-acid-green">
                <h2 class="font-black text-black uppercase flex items-center gap-2">
                    Edit Identity
                </h2>
                <button type="button"
                    class="close-modal w-8 h-8 flex items-center justify-center border-2 border-black bg-white hover:bg-black hover:text-white transition">
                    <i class="ph-bold ph-x text-lg"></i>
                </button>
            </div>
            <form id="edit-form" class="p-6 space-y-6 max-h-[80vh] overflow-y-auto custom-scrollbar">

                <!-- Avatar & Intro Group -->
                <div class="flex gap-4">
                    <div class="w-20 h-20 bg-gray-100 border-2 border-black flex items-center justify-center overflow-hidden shrink-0"
                        id="preview-avatar"></div>
                    <div class="flex-1 space-y-2">
                        <label
                            class="block text-xs uppercase font-bold text-black bg-yellow-200 inline-block px-1">Avatar
                            Image</label>
                        <input type="file" id="avatar-input" accept="image/*"
                            class="block w-full text-xs file:mr-2 file:py-2 file:px-3 file:border-2 file:border-black file:text-xs file:font-bold file:bg-white file:text-black hover:file:bg-black hover:file:text-white transition" />
                    </div>
                </div>

                <!-- Status -->
                <div class="space-y-2">
                    <label class="block text-xs uppercase font-bold text-black">Status Signal</label>
                    <div class="flex gap-2">
                        <input type="text" name="status_emoji" id="input-status-emoji"
                            class="nb-input w-20 text-center text-xl" placeholder="üëã" maxlength="4" />
                        <input type="text" name="status_message" id="input-status-msg" class="nb-input flex-1"
                            placeholder="What's your vibe?" maxlength="100" />
                    </div>
                </div>

                <!-- Now Block -->
                <div class="bg-yellow-50 p-4 border-2 border-black space-y-2">
                    <label class="block text-xs uppercase font-bold text-black flex items-center gap-2">
                        <i class="ph-bold ph-clock"></i> The "Now" Block
                    </label>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="col-span-1">
                            {{ select('now_activity_type', [
                            ('thinking', 'Thinking'),
                            ('listening', 'Listening'),
                            ('working', 'Working'),
                            ('playing', 'Playing'),
                            ('reading', 'Reading'),
                            ('watching', 'Watching')
                            ], id='input-now-type', class='text-xs font-bold') }}
                        </div>
                        <div class="col-span-2">
                            {{ input('now_activity', id='input-now-activity', placeholder='e.g. Creating art...',
                            attrs='maxlength="50"') }}
                        </div>
                    </div>
                </div>

                <!-- Basic Info -->
                <div class="grid grid-cols-1 gap-4">
                    {{ input('display_name', 'Display Name', id='input-name', attrs='required maxlength="50"') }}
                    <input type="hidden" name="bio" id="input-bio">
                </div>

                <!-- Anthem -->
                <div class="p-4 border-2 border-black bg-white space-y-2 shadow-hard-sm">
                    {{ input('anthem_url', 'Anthem (MP3/URL)', id='input-anthem-url', type='url',
                    placeholder='https://example.com/song.mp3') }}
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="anthem_autoplay" id="input-anthem-autoplay"
                            class="w-4 h-4 border-2 border-black text-black focus:ring-0 rounded-none" />
                        <span class="text-xs font-bold uppercase">Autoplay</span>
                    </label>
                </div>

                <!-- Settings -->
                <div class="pt-4 border-t-2 border-black space-y-2">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" name="is_public" id="input-public"
                            class="w-4 h-4 border-2 border-black text-black focus:ring-0 rounded-none" />
                        <span class="text-sm font-bold">Public Profile</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" name="show_online_status" id="input-online"
                            class="w-4 h-4 border-2 border-black text-black focus:ring-0 rounded-none" />
                        <span class="text-sm font-bold">Show Online Indicator</span>
                    </label>
                    <input type="hidden" name="accent_color" id="input-accent" value="#a3e635">

                    <!-- Theme Selector -->
                    <div class="pt-4 border-t-2 border-black">
                        <label class="block text-xs uppercase font-bold mb-2 flex items-center gap-2">
                            <i class="ph-bold ph-paint-brush"></i> Wall Theme
                        </label>
                        {{ select('theme_preset', [
                        ('default', 'Default (Brutalist)'),
                        ('hacker', 'üñ•Ô∏è Hacker Terminal')
                        ], id='input-theme') }}
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    {{ button('Cancel', variant='ghost', class='close-modal border-2 border-transparent
                    hover:border-black', attrs='type="button"') }}
                    {{ button('Save Changes', variant='primary', class='hover:bg-hot-pink', icon='ph-bold ph-check',
                    attrs='type="submit"') }}
                </div>
            </form>
        </div>
    </div>

    <!-- Add Module FAB (Brutalist Square) -->
    {{ button(None, icon='ph-bold ph-plus', size='fab', attrs='id="add-module-btn"', class='fixed bottom-8 right-8 z-40
    bg-electric-blue hover:bg-hot-pink hidden group !text-black !border-black') }}

    <!-- Add Module Modal -->
    <div id="add-module-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white border-2 border-black w-full max-w-md shadow-hard-xl overflow-hidden animate-pop">
            <div class="p-4 border-b-2 border-black flex justify-between items-center bg-electric-blue">
                <h2 class="font-black text-black uppercase flex items-center gap-2">
                    Add Content
                </h2>
                <button type="button"
                    class="close-add-modal w-8 h-8 flex items-center justify-center border-2 border-black bg-white hover:bg-black hover:text-white transition">
                    <i class="ph-bold ph-x text-lg"></i>
                </button>
            </div>

            <div class="grid grid-cols-4 gap-2 p-4 border-b-2 border-black bg-white" id="module-type-selector">
                <button data-type="text"
                    class="module-type-btn active flex flex-col items-center gap-1 p-2 border-2 border-transparent hover:border-black hover:shadow-hard-sm transition">
                    <i class="ph-duotone ph-text-t text-xl"></i>
                    <span class="text-[10px] font-bold uppercase">Text</span>
                </button>
                <button data-type="image"
                    class="module-type-btn flex flex-col items-center gap-1 p-2 border-2 border-transparent hover:border-black hover:shadow-hard-sm transition">
                    <i class="ph-duotone ph-image text-xl"></i>
                    <span class="text-[10px] font-bold uppercase">Image</span>
                </button>
                <button data-type="link"
                    class="module-type-btn flex flex-col items-center gap-1 p-2 border-2 border-transparent hover:border-black hover:shadow-hard-sm transition">
                    <i class="ph-duotone ph-link text-xl"></i>
                    <span class="text-[10px] font-bold uppercase">Link</span>
                </button>
                <button data-type="audio"
                    class="module-type-btn flex flex-col items-center gap-1 p-2 border-2 border-transparent hover:border-black hover:shadow-hard-sm transition">
                    <i class="ph-duotone ph-music-notes text-xl"></i>
                    <span class="text-[10px] font-bold uppercase">Audio</span>
                </button>
            </div>

            <form id="add-module-form" class="p-4 space-y-4">
                <input type="hidden" name="module_type" id="new-module-type" value="text">

                <div id="fields-text" class="space-y-2">
                    {{ textarea('text_content', 'Content (Markdown)', class='h-32 custom-scrollbar', placeholder='#
                    Hello World...') }}
                </div>

                <div id="fields-image" class="space-y-2 hidden">
                    {{ input('image_url', 'Image URL', type='url', placeholder='https://...') }}
                </div>

                <div id="fields-link" class="space-y-2 hidden">
                    {{ input('link_url', 'Link URL', type='url', placeholder='https://...') }}
                    {{ input('link_title', 'Title (Optional)', placeholder='Link Title') }}
                    {{ input('link_thumb', 'Thumbnail URL (Optional)', type='url',
                    placeholder='https://example.com/image.jpg') }}

                    {{ select('link_style', [
                    ('simple', 'Simple Row'),
                    ('button', 'Button'),
                    ('card', 'Card (Large Image)')
                    ], label='Display Style') }}
                </div>

                <div id="fields-audio" class="space-y-2 hidden">
                    {{ input('audio_url', 'Audio URL (MP3)', type='url', placeholder='https://...') }}
                    {{ input('audio_title', 'Caption (Optional)', placeholder='Song Title') }}
                </div>

                <div class="flex justify-end pt-2">
                    {{ button('Add', variant='primary', class='bg-electric-blue hover:bg-hot-pink', icon='ph-bold
                    ph-plus', attrs='type="submit"') }}
                </div>
            </form>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<!-- Voice Support -->
<script src="/ui/js/voice.js"></script>
<!-- Wall Logic -->
<script src="/ui/js/friends.js"></script> <!-- Sprint 20 -->
<!-- <script src="/ui/js/wall.js"></script> -->
<script type="module" src="/ui/js/wall/WallMain.js"></script>

<script>
    // Force init
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof fetchProfile === 'function') fetchProfile();
    });

    // Module Type Toggle Logic (Brutalist Style)
    document.querySelectorAll('.module-type-btn').forEach(btn => {
        btn.onclick = (e) => {
            e.preventDefault();
            // styling
            document.querySelectorAll('.module-type-btn').forEach(b => {
                b.classList.remove('active', 'border-black', 'bg-acid-green', 'shadow-hard-sm');
                b.classList.add('border-transparent');
            });
            btn.classList.remove('border-transparent');
            btn.classList.add('active', 'border-black', 'bg-acid-green', 'shadow-hard-sm');

            // value
            const type = btn.dataset.type;
            document.getElementById('new-module-type').value = type;

            // fields
            ['text', 'image', 'link', 'audio'].forEach(t => {
                const el = document.getElementById(`fields-${t}`);
                if (el) {
                    if (t === type) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            });
        };
    });

    // Close Add Modal
    document.querySelectorAll('.close-add-modal').forEach(b => {
        b.onclick = () => {
            document.getElementById('add-module-modal').classList.add('hidden');
        };
    });

    // Open Add Modal bound to FAB
    document.getElementById('add-module-btn').addEventListener('click', () => {
        document.getElementById('add-module-form').reset();
        delete document.getElementById('add-module-form').dataset.editId;
        // Trigger click on text type to reset
        document.querySelector('.module-type-btn[data-type="text"]').click();
        document.getElementById('add-module-modal').classList.remove('hidden');
    });
</script>
{% endblock %}