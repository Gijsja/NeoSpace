{% extends "base.html" %}

{% block title %}Dashboard - NeoSpace{% endblock %}
{% block page_title %}Mission Control{% endblock %}

{% block content %}
{% from "components/ui_macros.html" import button, select %}
<!-- --- PHASE 6: CONCRETE DASHBOARD --- -->
<div class="grid grid-cols-1 lg:grid-cols-12 gap-6 pb-20 pt-4">

    <!-- Row 1: KPI Stats -->

    <!-- STAT 1: ACTIVE PERSONNEL -->
    <div class="lg:col-span-3 nb-card p-5 relative overflow-hidden group hover:bg-yellow-100 transition-colors">
        <div class="flex flex-col relative z-10">
            <span
                class="text-xs font-black text-black uppercase tracking-widest mb-1 border-b-2 border-black pb-1 inline-block w-max">Active
                Personnel</span>
            <div class="flex items-baseline gap-2 mt-2">
                <span class="text-4xl font-black text-black tracking-tighter">{{ metrics.users_total }}</span>
                <span
                    class="text-xs font-bold text-black bg-acid-green px-1 border border-black flex items-center gap-1">
                    TOTAL
                </span>
            </div>
        </div>
        <svg class="absolute bottom-2 right-2 w-24 h-12 text-black opacity-20 group-hover:opacity-100 transition-opacity"
            viewBox="0 0 100 40" preserveAspectRatio="none">
            <path vector-effect="non-scaling-stroke" d="M0,40 Q25,10 50,30 T100,5" fill="none" stroke="currentColor"
                stroke-width="4" stroke-linecap="square" />
        </svg>
    </div>

    <!-- STAT 2: BANNED USERS -->
    <div class="lg:col-span-3 nb-card p-5 relative overflow-hidden group hover:bg-pink-100 transition-colors">
        <div class="flex flex-col relative z-10">
            <span
                class="text-xs font-black text-black uppercase tracking-widest mb-1 border-b-2 border-black pb-1 inline-block w-max">Mitigated
                Risks</span>
            <div class="flex items-baseline gap-2 mt-2">
                <span class="text-4xl font-black text-black tracking-tighter">{{ metrics.users_banned }}</span>
                <span class="text-xs font-bold text-white bg-red-600 px-1 border border-black flex items-center gap-1">
                    BANNED
                </span>
            </div>
        </div>
        <svg class="absolute bottom-2 right-2 w-24 h-12 text-black opacity-20 group-hover:opacity-100 transition-opacity"
            viewBox="0 0 100 40" preserveAspectRatio="none">
            <path vector-effect="non-scaling-stroke" d="M0,35 L20,25 L40,30 L60,10 L80,20 L100,5" fill="none"
                stroke="currentColor" stroke-width="4" stroke-linejoin="bevel" />
        </svg>
    </div>

    <!-- STAT 3: PENDING REPORTS -->
    <div class="lg:col-span-3 nb-card p-5 relative overflow-hidden group hover:bg-blue-100 transition-colors">
        <div class="flex flex-col relative z-10">
            <span
                class="text-xs font-black text-black uppercase tracking-widest mb-1 border-b-2 border-black pb-1 inline-block w-max">Incidents</span>
            <div class="flex items-baseline gap-2 mt-2">
                <span class="text-4xl font-black text-black tracking-tighter">{{ metrics.pending_reports }}</span>
                <span
                    class="text-xs font-bold text-black {{ 'bg-acid-green' if metrics.pending_reports == 0 else 'bg-orange-400' }} px-1 border border-black flex items-center gap-1">
                    PENDING
                </span>
            </div>
        </div>
        <svg class="absolute bottom-2 right-2 w-24 h-12 text-black opacity-20 group-hover:opacity-100 transition-opacity"
            viewBox="0 0 100 40" preserveAspectRatio="none">
            <path vector-effect="non-scaling-stroke" d="M0,20 Q40,40 100,10" fill="none" stroke="currentColor"
                stroke-width="4" />
        </svg>
    </div>

    <!-- STAT 4: DB SIZE -->
    <div class="lg:col-span-3 nb-card p-5 relative overflow-hidden group hover:bg-orange-100 transition-colors">
        <div class="flex flex-col relative z-10">
            <span
                class="text-xs font-black text-black uppercase tracking-widest mb-1 border-b-2 border-black pb-1 inline-block w-max">Persistence</span>
            <div class="flex items-baseline gap-2 mt-2">
                <span class="text-4xl font-black text-black tracking-tighter">{{ metrics.db_size_mb }} MB</span>
                <span
                    class="text-xs font-bold text-black bg-acid-green px-1 border border-black flex items-center gap-1">
                    SQLITE
                </span>
            </div>
        </div>
        <div
            class="absolute -right-6 -bottom-6 w-24 h-24 rounded-none border-4 border-black opacity-10 group-hover:opacity-100 transition-opacity rotate-12">
        </div>
    </div>


    <!-- Row 2: Charts & Feed -->

    <!-- CHART 1 - TRAFFIC (Real-ish) -->
    <div class="lg:col-span-8 nb-card p-6 flex flex-col">
        <div class="flex items-center justify-between mb-4 border-b-2 border-black pb-2">
            <h3 class="text-sm font-black text-black uppercase flex items-center gap-2">
                <i class="ph-bold ph-activity"></i> Pulse Monitoring
            </h3>
            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Synthetic Visualization</span>
        </div>
        <div class="flex-1 w-full min-h-[300px]" x-data x-init="
                const options = {
                    series: [{
                        name: 'Traffic',
                        data: Array.from({length: 24}, () => Math.floor(Math.random() * 100))
                    }],
                    chart: {
                        height: '100%',
                        type: 'line',
                        toolbar: { show: false },
                        background: 'transparent',
                        fontFamily: 'monospace'
                    },
                    colors: ['#000000'],
                    dataLabels: { enabled: false },
                    stroke: { curve: 'stepline', width: 4 },
                    xaxis: {
                        axisBorder: { show: true, color: '#000' },
                        axisTicks: { show: true, color: '#000' },
                        labels: { show: false }
                    },
                    yaxis: {
                        labels: { style: { colors: '#000', fontFamily: 'monospace', fontWeight: 700 } }
                    },
                    grid: {
                        borderColor: '#000',
                        strokeDashArray: 0,
                        position: 'back',
                        xaxis: { lines: { show: true } } 
                    }
                };
                new ApexCharts($el, options).render();
             ">
        </div>
    </div>

    <!-- RIGHT COLUMN: CPU & Audit Log -->
    <div class="lg:col-span-4 flex flex-col gap-6">

        <!-- SECURITY STATUS -->
        <div class="nb-card p-6 bg-black text-white">
            <h3 class="text-sm font-black uppercase flex items-center gap-2 mb-4 border-b border-white/20 pb-2">
                <i class="ph-bold ph-shield-check"></i> Security Protocol
            </h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-xs font-mono">STAFF ACCESS</span>
                    <span class="text-xs font-bold bg-green-500 text-black px-2">ENFORCED</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-xs font-mono">ENCRYPTION (DMs)</span>
                    <span class="text-xs font-bold bg-green-500 text-black px-2">ACTIVE</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-xs font-mono">XSS FILTERING</span>
                    <span class="text-xs font-bold bg-green-500 text-black px-2">ACTIVE</span>
                </div>
                <div class="flex items-center justify-between opacity-50">
                    <span class="text-xs font-mono">RATE LIMITING</span>
                    <span class="text-xs font-bold bg-gray-500 text-black px-2">DEFERRED</span>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t border-white/10">
                <p class="text-[10px] text-gray-400 font-mono leading-tight">Sentinel v1.0 // Watching the signals.
                    Maintaining the perimeter.</p>
            </div>
        </div>

        <!-- REAL AUDIT LOG -->
        <div class="nb-card p-0 flex-1 flex flex-col overflow-hidden max-h-[500px]">
            <div class="p-4 border-b-2 border-black flex items-center justify-between bg-white">
                <h3 class="text-sm font-black text-black uppercase">Security Audit Log</h3>
                <span class="w-3 h-3 bg-acid-green border-4 border-black animate-pulse"></span>
            </div>
            <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
                <div class="flex flex-col">
                    {% if not audit_logs %}
                    <div class="p-8 text-center text-gray-500 font-mono text-xs uppercase">
                        No activity recorded
                    </div>
                    {% endif %}
                    {% for log in audit_logs %}
                    <div
                        class="flex items-start gap-4 p-4 border-b-2 border-black hover:bg-yellow-50 transition-colors group">
                        <div class="w-3 h-3 mt-1.5 bg-black z-10 box-content group-hover:bg-hot-pink transition-colors">
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <span class="text-sm font-black text-black uppercase">{{ log.admin_name }}</span>
                                <span
                                    class="text-[10px] text-black font-mono font-bold bg-gray-200 px-1 border border-black">
                                    {{ log.created_at.split(' ')[1][:5] if ' ' in log.created_at else '' }}
                                </span>
                            </div>
                            <p class="text-xs text-black font-mono mt-1">
                                <span class="font-bold text-hot-pink">{{ log.action.replace('_', ' ').upper() }}</span>
                                Target: {{ log.target }}
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>

    <!-- Row 3: Quick Actions -->
    <div class="lg:col-span-12 nb-card p-6 flex items-center justify-between bg-black text-white">
        <h3 class="text-sm font-black uppercase tracking-wider text-white">Security Controls</h3>
        <div class="flex gap-4">
            {{ button('Manage Reports', variant='secondary', href='/admin/', class='border-white shadow-none
            hover:shadow-hard hover:bg-hot-pink hover:border-black', icon='ph-bold ph-flag') }}
            {{ button('Admin Dashboard', variant='outline', href='/admin', class='text-white border-white hover:bg-white
            hover:text-black', icon='ph-bold ph-shield-star') }}
        </div>
    </div>

</div>
{% endblock %}