{% extends "base.html" %}

{% block content %}
{% from "components/ui_macros.html" import button, card, badge %}

<div class="h-full flex flex-col p-6 overflow-y-auto w-full">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-black uppercase tracking-widest text-black text-shadow-glow">
            System Administration
        </h1>
        <div class="flex gap-4">
            {% call card(class="!p-2 flex items-center justify-between w-32") %}
            <div>
                <span class="text-xs text-gray-500 uppercase font-bold">Pending</span>
                <span class="block text-xl font-bold text-black">{{ pending_count }}</span>
            </div>
            {% endcall %}
            {% call card(class="!p-2 flex items-center justify-between w-32") %}
            <div>
                <span class="text-xs text-gray-500 uppercase font-bold">Users</span>
                <span class="block text-xl font-bold text-black">{{ users_count }}</span>
            </div>
            {% endcall %}
        </div>
    </div>

    <!-- Reports Table -->
    {% call card(title="Report Log", class="flex-1 overflow-hidden flex flex-col") %}
    <div class="flex-1 overflow-auto -mx-4 -mb-4">
        <!-- Negative margin to counteract card padding for full width table -->
        <table class="w-full text-left border-collapse">
            <thead class="bg-black text-white text-xs uppercase font-mono sticky top-0 z-10">
                <tr>
                    <th class="p-3 border-b-2 border-black">ID</th>
                    <th class="p-3 border-b-2 border-black">Reporter</th>
                    <th class="p-3 border-b-2 border-black">Type</th>
                    <th class="p-3 border-b-2 border-black">Target ID</th>
                    <th class="p-3 border-b-2 border-black">Reason</th>
                    <th class="p-3 border-b-2 border-black">Status</th>
                    <th class="p-3 border-b-2 border-black text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="text-sm font-mono divide-y-2 divide-black">
                {% for r in reports %}
                <tr class="hover:bg-acid-green/10 transition group">
                    <td class="p-3 text-black font-bold">#{{ r.id }}</td>
                    <td class="p-3 text-black font-bold">{{ r.reporter_name }}</td>
                    <td class="p-3">
                        {% if r.content_type == 'post' %}
                        {{ badge(r.content_type, variant='outline', class='bg-cyan-100') }}
                        {% elif r.content_type == 'script' %}
                        {{ badge(r.content_type, variant='outline', class='bg-purple-100') }}
                        {% else %}
                        {{ badge(r.content_type, variant='outline', class='bg-yellow-100') }}
                        {% endif %}
                    </td>
                    <td class="p-3 text-gray-600">{{ r.content_id }}</td>
                    <td class="p-3 text-black max-w-xs truncate" title="{{ r.reason }}">{{ r.reason }}</td>
                    <td class="p-3">
                        {% if r.status == 'pending' %}
                        {{ badge('PENDING', variant='primary') }} <!-- Acid Green for pending/active -->
                        {% elif r.status == 'resolved' %}
                        {{ badge('RESOLVED', variant='secondary') }}
                        {% else %}
                        {{ badge('DISMISSED', variant='outline') }}
                        {% endif %}
                    </td>
                    <td class="p-3 text-right">
                        <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition">
                            {% if r.status == 'pending' %}
                            {{ button(None, variant='ghost', icon='ph-bold ph-x',
                            class='p-1 h-8 w-8 text-gray-500 hover:text-black hover:bg-gray-200 rounded-none border-none
                            shadow-none',
                            attrs='onclick="resolveReport(' ~ r.id ~ ', \'dismiss\')"', title='Dismiss') }}

                            {% if r.content_type in ['post', 'script'] %}
                            {{ button(None, variant='ghost', icon='ph-bold ph-trash',
                            class='p-1 h-8 w-8 text-red-500 hover:text-white hover:bg-red-500 rounded-none border-none
                            shadow-none',
                            attrs='onclick="resolveReport(' ~ r.id ~ ', \'delete_content\')"', title='Delete Content')
                            }}
                            {% endif %}

                            {{ button(None, variant='ghost', icon='ph-bold ph-hand-palm',
                            class='p-1 h-8 w-8 text-red-500 hover:text-white hover:bg-red-500 rounded-none border-none
                            shadow-none',
                            attrs='onclick="resolveReport(' ~ r.id ~ ', \'ban_user\')"', title='Ban User') }}
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endcall %}
</div>

<script>
    async function resolveReport(id, action) {
        if (!confirm(`Are you sure you want to ${action.replace('_', ' ')}?`)) return;

        try {
            const res = await fetch('/admin/resolve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    report_id: id,
                    action: action,
                    note: "Admin action via dashboard"
                })
            });
            const data = await res.json();
            if (data.success) {
                window.location.reload();
            } else {
                alert(data.error || "Failed");
            }
        } catch (e) {
            alert("Network error");
        }
    }
</script>
{% endblock %}