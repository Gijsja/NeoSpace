<!DOCTYPE html>
<html lang="en" x-data="{ sidebarOpen: true, doctorOpen: false }"
    @keydown.window.ctrl.b.prevent="sidebarOpen = !sidebarOpen"
    @keydown.window.meta.b.prevent="sidebarOpen = !sidebarOpen"
    @keydown.window.ctrl.shift.d.prevent="doctorOpen = !doctorOpen"
    @keydown.window.meta.shift.d.prevent="doctorOpen = !doctorOpen">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}NeoSpace{% endblock %}</title>

    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />

    <!-- Tailwind CSS (Vendored) -->
    <script src="/static/vendor/tailwindcss.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'], // Keep Inter but will use heavier weights
                        mono: ['monospace'], // For that raw feel
                    },
                    colors: {
                        'bbs-bg': '#FFFAF0', // Floral White
                        'bbs-surface': '#FFFFFF',
                        'bbs-border': '#000000', // Hard Black
                        'bbs-shadow': '#000000',

                        // Accents (Clashing)
                        'acid-green': '#a3e635',
                        'hot-pink': '#ff6b6b',
                        'construction-orange': '#fb923c',
                        'electric-blue': '#22d3ee',
                        'warm-beige': '#f5f5dc',

                        // Penguin UI / Neo-Brutalism Palette
                        'neo-bg': '#0a0f1a',
                        'neo-surface': 'rgba(30, 41, 59, 0.85)',
                        'neo-border': 'rgba(71, 85, 105, 0.5)',
                        'neo-accent': '#60a5fa',
                        'neo-accent-glow': 'rgba(96, 165, 250, 0.4)',
                        'neo-yellow': '#F3F722', // Acid Yellow
                        'neo-pink': '#FF69B4',   // Hot Pink
                        'neo-green': '#A3E635',  // Lime Green
                        'neo-black': '#000000',
                        'neo-white': '#FFFFFF',
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px #000000',
                        'hard-sm': '2px 2px 0px 0px #000000',
                        'hard-xl': '8px 8px 0px 0px #000000',
                        'glow': '0 0 20px rgba(96, 165, 250, 0.5)',
                    },
                    animation: {
                        'marquee': 'marquee 20s linear infinite',
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'pop': 'pop 0.2s ease-out',
                        'glitch': 'glitch 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite',
                    },
                    keyframes: {
                        marquee: {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(-100%)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(15px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pop: {
                            '0%': { transform: 'scale(0.95)' },
                            '50%': { transform: 'scale(1.02)' },
                            '100%': { transform: 'scale(1)' },
                        },
                        glitch: {
                            '0%': { transform: 'translate(0)' },
                            '20%': { transform: 'translate(-2px, 2px)' },
                            '40%': { transform: 'translate(-2px, -2px)' },
                            '60%': { transform: 'translate(2px, 2px)' },
                            '80%': { transform: 'translate(2px, -2px)' },
                            '100%': { transform: 'translate(0)' },
                        },
                    }
                }
            }
        }
    </script>

    <!-- Alpine.js -->
    <script defer src="/static/vendor/alpine.min.js"></script>

    <!-- Phosphor Icons -->
    <link rel="stylesheet" href="/static/vendor/phosphor/phosphor-regular.css">
    <link rel="stylesheet" href="/static/vendor/phosphor/phosphor-bold.css">
    <link rel="stylesheet" href="/static/vendor/phosphor/phosphor-fill.css">

    <!-- ApexCharts -->
    <script src="/static/vendor/apexcharts.min.js"></script>
    <!-- HTMX -->
    <script src="/static/vendor/htmx.min.js"></script>

    <style>
        /* --- PROJECT CONCRETE: NEUBRUTALISM --- */
        /* Custom Brutalist Scrollbar */
        ::-webkit-scrollbar {
            width: 16px;
            height: 16px;
            background: #f0f0f0;
            border-left: 2px solid black;
        }

        ::-webkit-scrollbar-track {
            background: #fff;
            border-left: 2px solid black;
        }

        ::-webkit-scrollbar-thumb {
            background: #000;
            border: 2px solid black;
            /* Creates a padding effect if background is white, but here we want blocky */
            box-shadow: inset 2px 2px 0px 0px #fff;
            /* Inner highlight */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #FF00FF;
            /* Hot Pink on hover */
        }

        ::-webkit-scrollbar-corner {
            background: #000;
        }

        /* Selection */
        ::selection {
            background: #a3e635;
            /* Acid Green */
            color: black;
        }

        body {
            background-color: #FFFAF0;
            /* bbs-bg */
            color: #000000;
            overflow: hidden;
        }

        /* Utilities */
        .nb-card {
            background-color: #FFFFFF;
            border: 2px solid #000000;
            box-shadow: 4px 4px 0px 0px #000000;
        }

        .nb-button {
            border: 2px solid #000000;
            box-shadow: 4px 4px 0px 0px #000000;
            transition: all 0.1s;
            font-weight: 700;
            text-transform: uppercase;
        }

        .nb-button:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }

        .nb-input {
            background-color: #FFFFFF;
            border: 2px solid #000000;
            padding: 0.5rem 1rem;
            width: 100%;
            font-family: monospace;
            box-shadow: 4px 4px 0px 0px #000000;
            transition: all 0.2s;
        }

        .nb-input:focus {
            outline: none;
            background-color: #fff1f2;
            /* pink-50 */
            box-shadow: 6px 6px 0px 0px #000000;
        }

        /* Custom Brutalist Scrollbar */
        ::-webkit-scrollbar {
            width: 16px;
            height: 16px;
            background: #fff;
            border-left: 2px solid black;
        }

        ::-webkit-scrollbar-track {
            background: #fff;
            border-left: 2px solid black;
        }

        ::-webkit-scrollbar-thumb {
            background: #000;
            border: 2px solid black;
            box-shadow: inset 2px 2px 0px 0px #fff;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #FF00FF;
        }

        ::-webkit-scrollbar-corner {
            background: #000;
        }

        /* Selection */
        ::selection {
            background: #a3e635;
            color: black;
        }

        /* Animation: Equalizer */
        @keyframes equalize {
            0% {
                height: 30%;
            }

            50% {
                height: 100%;
            }

            100% {
                height: 30%;
            }
        }

        /* Sidebar Hover Slide */
        .sidebar-link:hover {
            padding-left: 1.5rem;
        }

        /* --- SPRINT 21: VISUAL POLISH ANIMATIONS --- */

        /* 1. Glitch Effect on Hover */
        .animate-glitch:hover {
            animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite;
            color: #FF00FF;
            /* Hot Pink */
        }

        @keyframes glitch {
            0% {
                transform: translate(0);
            }

            20% {
                transform: translate(-2px, 2px);
            }

            40% {
                transform: translate(-2px, -2px);
            }

            60% {
                transform: translate(2px, 2px);
            }

            80% {
                transform: translate(2px, -2px);
            }

            100% {
                transform: translate(0);
            }
        }

        /* 2. Button Spring Physics */
        .btn-spring {
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .btn-spring:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 6px 6px 0px 0px #000000;
        }

        .btn-spring:active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 1px 1px 0px 0px #000000;
        }

        /* 3. Page Transitions (Fade) */
        .page-transition-enter {
            opacity: 0;
            transform: translateY(10px);
        }

        .page-transition-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms, transform 300ms;
        }

        .page-transition-exit {
            opacity: 1;
        }

        .page-transition-exit-active {
            opacity: 0;
            transition: opacity 300ms;
        }

        /* Apply to main content */
        #app-main>div {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    {% block head %}{% endblock %}
</head>

<body class="flex flex-col h-screen overflow-hidden selection:bg-hot-pink selection:text-white font-sans bg-bbs-bg"
    hx-boost="true" hx-target="#app-main" hx-select="#app-main" hx-swap="outerHTML">

    <!-- Marquee Header -->
    <div class="h-8 bg-yellow-400 border-b-2 border-black overflow-hidden flex items-center shrink-0 relative z-50">
        <div
            class="animate-marquee whitespace-nowrap font-mono font-bold text-xs uppercase tracking-widest px-4 border-r-2 border-black">
            *** WELCOME TO NEOSPACE *** 24 USERS ONLINE *** DON'T BE EVIL *** PROJECT CONCRETE v2.0 *** SYSTEM NOMINAL
            ***
        </div>
        <div
            class="animate-marquee whitespace-nowrap font-mono font-bold text-xs uppercase tracking-widest px-4 border-r-2 border-black absolute top-0 left-full">
            *** WELCOME TO NEOSPACE *** 24 USERS ONLINE *** DON'T BE EVIL *** PROJECT CONCRETE v2.0 *** SYSTEM NOMINAL
            ***
        </div>
    </div>

    <div class="flex flex-1 h-full overflow-hidden relative">

        <!-- Sidebar ("Index Card Stack") -->
        <aside class="w-64 bg-white border-r-2 border-black flex flex-col z-40 relative shadow-[4px_0_0_0_#000]">

            <!-- Logo Section -->
            <div class="h-16 flex items-center justify-center shrink-0 border-b-2 border-black bg-white">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 bg-black text-white flex items-center justify-center font-bold border-2 border-transparent">
                        N
                    </div>
                    <span
                        class="text-xl font-black tracking-tighter uppercase italic transform -skew-x-6">NeoSpace</span>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 overflow-y-auto py-4 px-4 space-y-2 font-mono">
                <!-- Helper Macro -->
                {% macro nav_link(href, icon, label, badge=None, class='') %}
                <a href="{{ href }}"
                    class="{{ class }} group flex items-center gap-3 px-3 py-2 border-2 border-transparent hover:border-black hover:bg-acid-green hover:shadow-hard-sm hover:-translate-y-1 hover:-translate-x-1 transition-all duration-100 text-black font-bold text-sm uppercase">
                    <i class="{{ icon }} text-lg"></i>
                    <span>{{ label }}</span>
                    {% if badge %}
                    <span class="ml-auto w-2 h-2 bg-red-500 rounded-full border border-black"></span>
                    {% endif %}
                </a>
                {% endmacro %}

                {{ nav_link('/wall', 'ph-bold ph-user-square', 'Identity', class='sidebar-link') }}
                {{ nav_link('/codeground', 'ph-bold ph-code', 'Codeground', class='sidebar-link') }}
                {{ nav_link('/components', 'ph-bold ph-paint-brush', 'Edit Wall Style', class='sidebar-link') }}
                {{ nav_link('/penguin', 'ph-bold ph-bird', 'Penguin UI', class='sidebar-link') }}

                <!-- Room Category -->
                <div class="px-4 py-2 mt-4 mb-1 flex items-center justify-between">
                    <span class="text-[10px] font-black uppercase tracking-widest text-gray-500">Room</span>
                </div>

                <!-- Regular Chat (Channels) -->
                <div x-data="{ 
                    rooms: [],
                    currentRoom: new URLSearchParams(window.location.search).get('room') || 'general',
                    init() {
                        fetch('/rooms').then(r => r.json()).then(data => {
                            if(data.rooms) this.rooms = data.rooms;
                        });
                    }
                }" class="mb-2">
                    <template x-for="room in rooms" :key="room.id">
                        <a :href="'/app?room=' + room.name"
                            class="sidebar-link group flex items-center gap-2 px-4 py-1.5 border-l-4 transition-all font-mono font-bold text-sm"
                            :class="currentRoom === room.name 
                               ? 'border-black bg-black text-white' 
                               : 'border-transparent hover:border-black hover:bg-black/5 text-black'">
                            <i class="ph-bold ph-hash"
                                :class="currentRoom === room.name ? 'text-white' : 'text-gray-400 group-hover:text-black'"></i>
                            <span x-text="room.name"></span>
                        </a>
                    </template>
                </div>

                {{ nav_link('/feed/home', 'ph-bold ph-waves', 'Stream Listening', class='sidebar-link') }}
                {{ nav_link('#', 'ph-bold ph-microphone-stage', 'Voice', class='sidebar-link opacity-50
                cursor-not-allowed', badge=False) }}

                <div class="h-0.5 bg-black my-4 opacity-10 mx-4"></div>

                <!-- System / Network / Dashboard -->
                {{ nav_link('/dashboard', 'ph-bold ph-squares-four', 'Dashboard', class='sidebar-link') }}
                {{ nav_link('/directory', 'ph-bold ph-users', 'Network', class='sidebar-link') }}
                {{ nav_link('/ui/views/internals.html', 'ph-bold ph-cpu', 'System', badge=True, class='sidebar-link') }}
            </nav>

            <!-- Sidebar Footer (Music Player & Profile) -->
            <div class="p-4 border-t-2 border-black flex flex-col gap-4 bg-white">

                <!-- Music Player (Tape Deck Style) -->
                <div class="nb-card p-2 flex items-center gap-3 bg-red-50" x-data="{ 
                    playing: false, 
                    audio: new Audio('https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3'),
                    init() { this.audio.loop = true; this.audio.volume = 0.5; },
                    toggle() { this.playing = !this.playing; this.playing ? this.audio.play() : this.audio.pause(); }
                }">
                    <button @click="toggle()"
                        class="w-8 h-8 border-2 border-black flex items-center justify-center transition-colors"
                        :class="playing ? 'bg-acid-green' : 'bg-white hover:bg-gray-100'">
                        <i class="ph-bold text-lg" :class="playing ? 'ph-pause' : 'ph-play'"></i>
                    </button>
                    <div class="flex-1 min-w-0">
                        <span class="text-[10px] font-bold uppercase tracking-widest block mb-1">Frequency</span>
                        <div class="flex gap-0.5 items-end h-3">
                            <div class="w-1 bg-black"
                                :style="{ height: playing ? '100%' : '30%', animation: 'equalize 0.8s infinite', animationPlayState: playing ? 'running' : 'paused' }">
                            </div>
                            <div class="w-1 bg-black"
                                :style="{ height: playing ? '100%' : '50%', animation: 'equalize 1.1s infinite', animationPlayState: playing ? 'running' : 'paused', animationDelay: '0.1s' }">
                            </div>
                            <div class="w-1 bg-black"
                                :style="{ height: playing ? '100%' : '40%', animation: 'equalize 0.9s infinite', animationPlayState: playing ? 'running' : 'paused', animationDelay: '0.2s' }">
                            </div>
                            <div class="w-1 bg-black"
                                :style="{ height: playing ? '100%' : '20%', animation: 'equalize 1.2s infinite', animationPlayState: playing ? 'running' : 'paused', animationDelay: '0.3s' }">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile -->
                <div class="flex items-center gap-3 p-2 border-2 border-transparent hover:border-black transition-colors cursor-pointer"
                    x-data="{ 
                         user: { username: 'Loading...', id: '---' }, 
                         avatar: null,
                         init() {
                             fetch('/auth/me').then(r => r.json()).then(d => {
                                 if(d.logged_in) {
                                     this.user = d;
                                     // Fetch avatar
                                     fetch('/profile?user_id=' + d.id).then(r => r.json()).then(p => {
                                         if(p.avatar_path) this.avatar = p.avatar_path;
                                     });
                                 }
                             });
                         }
                     }">
                    <div class="w-8 h-8 bg-black text-white flex items-center justify-center font-bold text-xs border-2 border-black shadow-hard-sm bg-cover bg-center"
                        :style="avatar ? 'background-image: url(' + avatar + '); color: transparent;' : ''">
                        <span x-text="user.username ? user.username.charAt(0).toUpperCase() : 'U'"></span>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-xs font-bold text-black uppercase truncate" x-text="user.username"></p>
                        <p class="text-[10px] text-gray-500 font-mono truncate">ID: <span x-text="user.id"></span></p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Wrapper -->
        <main id="app-main" class="flex-1 flex flex-col min-w-0 h-full relative z-20">

            <!-- Header (Brutalist Top Bar) -->
            <header class="h-16 flex items-center justify-between px-6 shrink-0 border-b-2 border-black bg-white">
                <!-- Title / Breadcrumbs -->
                <div class="flex flex-col justify-center">
                    <h1 class="text-2xl font-black text-black uppercase tracking-tighter">{% block page_title %}Command
                        Center{% endblock %}</h1>
                </div>

                <!-- Right Actions -->
                <div class="flex items-center gap-4">
                    <!-- Brutalist Search -->
                    <div class="relative group">
                        <input type="text" class="nb-input h-10 w-64" placeholder="SEARCH DATABASE...">
                    </div>

                    <!-- Action Icons -->
                    <button id="notification-bell-btn"
                        class="w-10 h-10 border-2 border-black flex items-center justify-center bg-white hover:bg-acid-green transition-colors shadow-hard-sm active:translate-x-[2px] active:translate-y-[2px] active:shadow-none relative">
                        <i class="ph-bold ph-bell"></i>
                        <span id="notification-badge"
                            class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 border border-black text-white text-[10px] font-bold flex items-center justify-center rounded-full hidden">0</span>
                    </button>
                    <button
                        class="w-10 h-10 border-2 border-black flex items-center justify-center bg-white hover:bg-yellow-400 transition-colors shadow-hard-sm active:translate-x-[2px] active:translate-y-[2px] active:shadow-none">
                        <i class="ph-bold ph-gear"></i>
                    </button>
                </div>
            </header>

            <!-- Page Content Scroll Area -->
            {% block main_container %}
            <div class="flex-1 overflow-y-auto px-8 pb-8 custom-scrollbar">
                {% block content %}{% endblock %}
            </div>
            {% endblock %}

            {% block scripts %}{% endblock %}
        </main>

    </div>

    <!-- Scripts Block Moved Inside Main for Re-Execution -->

    <script src="/ui/js/notifications.js"></script>

    <!-- Init Toast Container -->
    <div id="toast-container" class="fixed top-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- Cat Companion Widget -->
    {% from "components/cat_widget.html" import cat_widget %}
    {{ cat_widget() }}

    <!-- System Internals Overlay -->
    {% include "components/connection_doctor.html" %}

</body>

</html>