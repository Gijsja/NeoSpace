{% extends "base.html" %}

{% block title %}Codeground v2.0 - NeoSpace{% endblock %}
{% block page_title %}CODEGROUND v2.0{% endblock %}

{% block head %}
<style>
    /* Editor Gutter & Overlay */
    .editor-wrapper {
        position: relative;
        counter-reset: line;
        display: flex;
        height: 100%;
        background-color: #0f172a;
        color: #e2e8f0;
        font-family: 'Courier New', Courier, monospace;
    }

    .line-numbers {
        width: 3rem;
        padding: 1rem 0.5rem;
        background-color: #1e293b;
        color: #64748b;
        text-align: right;
        border-right: 1px solid #334155;
        user-select: none;
        font-size: 0.875rem;
        line-height: 1.5rem;
        overflow: hidden;
    }

    .line-numbers div {
        height: 1.5rem;
    }

    #code-input {
        flex: 1;
        background: transparent;
        color: inherit;
        border: none;
        padding: 1rem;
        line-height: 1.5rem;
        font-size: 0.875rem;
        resize: none;
        white-space: pre;
        outline: none;
        overflow: auto;
        tab-size: 2;
    }

    /* Syntax Highlighting (Poor man's) */
    .syntax-layer {
        position: absolute;
        top: 0;
        left: 3rem;
        right: 0;
        bottom: 0;
        pointer-events: none;
        padding: 1rem;
        line-height: 1.5rem;
        font-size: 0.875rem;
        white-space: pre;
        color: transparent;
        /* Text is transparent, we show background highlights/tokens? No, too complex for raw html. */
        /* For v2.0 we stick to raw text but better DX */
    }

    /* Sidebar Transitions */
    .sidebar-panel-enter {
        transform: translateX(-100%);
    }

    .sidebar-panel-active {
        transform: translateX(0);
    }
</style>
{% endblock %}

{% block main_container %}
{% from "components/ui_macros.html" import button, input, textarea %}
<div class="flex h-full overflow-hidden bg-bbs-bg" x-data="codeground()">

    <!-- LEFT: Script Manager Sidebar -->
    <div class="w-64 flex flex-col border-r-2 border-black bg-white shrink-0 transform transition-transform duration-200"
        :class="sidebarOpen ? 'translate-x-0' : '-translate-x-64 absolute z-50 h-full shadow-hard-xl'">

        <div class="h-10 flex items-center justify-between px-3 bg-black text-white shrink-0">
            <span class="font-bold uppercase text-xs tracking-widest">My Scripts</span>
            <button @click="createNewsScript()" class="hover:text-acid-green" title="New Script"><i
                    class="ph-bold ph-plus"></i></button>
        </div>

        <!-- Script List -->
        <div class="flex-1 overflow-y-auto p-2 space-y-2">
            <template x-if="loadingScripts">
                <div class="text-center py-4 text-xs text-gray-500 font-mono animate-pulse">Loading...</div>
            </template>

            <template x-for="script in scripts" :key="script.id">
                <div @click="loadScript(script.id)"
                    class="p-2 border-2 border-transparent hover:border-black hover:bg-gray-50 cursor-pointer group transition-all"
                    :class="currentScriptId === script.id ? 'bg-acid-green border-black shadow-hard-sm' : ''">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-sm truncate w-32" x-text="script.title || 'Untitled'"></span>
                        <span class="text-[10px] font-mono text-gray-500"
                            x-text="formatDate(script.last_modified)"></span>
                    </div>
                </div>
            </template>
        </div>

        <!-- Toggle Handle (When closed) -->
        <button x-show="!sidebarOpen" @click="sidebarOpen = true"
            class="absolute -right-8 top-10 w-8 h-10 bg-black text-white flex items-center justify-center border-y-2 border-r-2 border-white cursor-pointer hover:bg-acid-green hover:text-black">
            <i class="ph-bold ph-caret-right"></i>
        </button>
    </div>

    <!-- CENTER: Main Area -->
    <div class="flex-1 flex flex-col min-w-0 relative">

        <!-- Toolbar -->
        <div class="h-12 border-b-2 border-black bg-bbs-surface flex items-center justify-between px-4 shrink-0">
            <div class="flex items-center gap-3">
                <button @click="sidebarOpen = !sidebarOpen"
                    class="w-8 h-8 border-2 border-black flex items-center justify-center hover:bg-yellow-300 transition-colors"
                    :class="sidebarOpen ? 'bg-black text-white' : 'bg-white'">
                    <i class="ph-bold ph-sidebar-simple"></i>
                </button>

                {{ input('currentTitle', attrs='x-model="currentTitle" @input="docDirty = true"', wrapper_class='w-64',
                class='h-8 font-bold text-sm', placeholder='Untitled Script') }}

                <span x-show="docDirty" class="text-xs font-mono text-red-500 animate-pulse font-bold uppercase">*
                    Unsaved</span>
            </div>

            <div class="flex items-center gap-2">
                <!-- Save Draft -->
                {% call button(None, variant='secondary', class='border-black hover:bg-acid-green shadow-hard-sm',
                attrs='@click="saveScript()" :disabled="isSaving" type="button"') %}
                <i class="ph-bold ph-floppy-disk"></i>
                <span x-text="isSaving ? 'Saving...' : 'Save Draft'"></span>
                {% endcall %}

                <!-- Run -->
                {{ button('Run', variant='primary', class='bg-electric-blue hover:bg-cyan-300 shadow-hard-sm',
                icon='ph-bold ph-play', attrs='@click="runCode()"') }}

                <!-- Publish -->
                {{ button('Publish', variant='primary', class='bg-purple-600 text-white hover:bg-purple-500
                shadow-hard-sm', icon='ph-bold ph-upload-simple', attrs='@click="openPublishModal()"') }}
            </div>
        </div>

        <!-- Editor / Preview Split -->
        <div class="flex-1 flex overflow-hidden">
            <!-- IDE -->
            <div class="w-1/2 flex flex-col relative border-r-2 border-black">
                <div class="editor-wrapper group">
                    <div class="line-numbers font-mono text-xs opacity-50" id="line-numbers">1</div>
                    <textarea id="code-input" x-model="codeContent" @input="updateLines(); docDirty = true"
                        @scroll="syncScroll($event)" @keydown.tab.prevent="insertTab($event)"
                        spellcheck="false"></textarea>
                </div>
            </div>

            <!-- Preview -->
            <div class="w-1/2 bg-black flex flex-col relative">
                <iframe id="preview-frame" class="flex-1 border-none bg-white"></iframe>

                <!-- Console Overlay -->
                <div class="h-32 bg-gray-900 border-t-2 border-white/20 text-green-400 font-mono text-xs p-2 overflow-y-auto"
                    id="console-logs">
                    <div class="text-gray-500 mb-1 border-b border-gray-700 pb-1 flex justify-between">
                        <span>CONSOLE OUTPUT</span>
                        <span class="cursor-pointer hover:text-white" @click="clearConsole()">CLEAR</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Publish Modal -->
    <div x-show="showPublishModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80"
        style="display: none;">
        <div class="bg-white border-2 border-black p-6 w-96 shadow-hard-xl" @click.away="showPublishModal = false">
            <h2 class="text-xl font-black uppercase mb-4">Publish to Wall</h2>
            <div class="space-y-3">
                {{ input('publishTitle', attrs='x-model="currentTitle"', placeholder='Title') }}
                {{ textarea('publishDesc', attrs='x-model="publishDesc"', class='h-24', placeholder='Description...') }}
                <div class="flex gap-2 pt-2">
                    {{ button('CANCEL', variant='secondary', class='flex-1 border-black hover:bg-gray-100',
                    attrs='@click="showPublishModal = false"') }}
                    {{ button('PUBLISH', variant='primary', class='flex-1 bg-black text-white hover:bg-gray-800',
                    attrs='@click="publishToWall()"') }}
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('codeground', () => ({
            sidebarOpen: true,
            scripts: [],
            loadingScripts: false,
            currentScriptId: null,
            currentTitle: 'Untitled Script',
            codeContent: `const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight);
camera.position.z = 5;

const renderer = new THREE.WebGLRenderer({ alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const geometry = new THREE.IcosahedronGeometry(1.5, 0);
const material = new THREE.MeshBasicMaterial({ color: 0xa3e635, wireframe: true });
const cube = new THREE.Mesh(geometry, material);
scene.add(cube);

function animate() {
    requestAnimationFrame(animate);
    cube.rotation.x += 0.01;
    cube.rotation.y += 0.01;
    renderer.render(scene, camera);
}
animate();`,
            docDirty: false,
            isSaving: false,
            showPublishModal: false,
            publishDesc: '',

            init() {
                this.updateLines();
                this.fetchScripts();
                this.runCode(); // Initial run

                // Add keyboard shortcut for save
                window.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        this.saveScript();
                    }
                });

                // Listen for iframe logs
                window.addEventListener('message', (e) => {
                    if (e.data.type === 'log') this.logToConsole(e.data.msg);
                    if (e.data.type === 'error') this.logToConsole(e.data.msg, 'error');
                });
            },

            async fetchScripts() {
                this.loadingScripts = true;
                const res = await fetch('/scripts/list');
                const data = await res.json();
                if (data.ok) this.scripts = data.scripts;
                this.loadingScripts = false;
            },

            async createNewsScript() {
                this.currentScriptId = null;
                this.currentTitle = "Untitled Script";
                this.codeContent = "// New Script\n";
                this.docDirty = false;
                this.runCode();
            },

            async loadScript(id) {
                if (this.docDirty && !confirm("Unsaved changes! Discard?")) return;

                const res = await fetch('/scripts/get?id=' + id);
                const data = await res.json();
                if (data.ok) {
                    this.currentScriptId = data.script.id;
                    this.currentTitle = data.script.title;
                    this.codeContent = data.script.content;
                    this.docDirty = false;
                    this.runCode();
                    this.updateLines();
                }
            },

            async saveScript() {
                this.isSaving = true;
                const payload = {
                    id: this.currentScriptId,
                    title: this.currentTitle,
                    content: this.codeContent,
                    script_type: 'p5', // or threejs, auto-detect later
                    is_public: 1
                };

                const res = await fetch('/scripts/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.ok) {
                    this.currentScriptId = data.id;
                    this.docDirty = false;
                    this.fetchScripts(); // Refresh list
                    this.logToConsole("Saved successfully.", 'system');
                } else {
                    alert("Error saving: " + data.error);
                }
                this.isSaving = false;
            },

            runCode() {
                const frame = document.getElementById('preview-frame');
                const html = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>body { margin: 0; overflow: hidden; background: white; }</style>
                        <script src="/static/vendor/three.min.js"><\/script>
                        <script src="/static/vendor/p5.min.js"><\/script>
                    </head>
                    <body>
                        <script>
                            window.console.log = (...args) => window.parent.postMessage({type: 'log', msg: args.join(' ')}, '*');
                            window.console.error = (...args) => window.parent.postMessage({type: 'error', msg: args.join(' ')}, '*');
                            window.onerror = (msg) => window.parent.postMessage({type: 'error', msg}, '*');
                            try { ${this.codeContent} } catch(e) { console.error(e); }
                        <\/script>
                    </body>
                    </html>
                `;
                const blob = new Blob([html], { type: 'text/html' });
                frame.src = URL.createObjectURL(blob);
                this.clearConsole();
                this.logToConsole("Running...", 'system');
            },

            openPublishModal() {
                if (this.docDirty) {
                    alert("Please save content first!");
                    this.saveScript();
                    return;
                }
                this.showPublishModal = true;
            },

            async publishToWall() {
                if (!this.currentScriptId) { alert("Save the script first!"); return; }

                const payload = {
                    module_type: 'script',
                    content: {
                        script_id: this.currentScriptId, // Link to the real script!
                        title: this.currentTitle,
                        description: this.publishDesc,
                        code: this.codeContent // Snapshot for fallback
                    },
                    style: { theme: 'dark' }
                };

                const res = await fetch('/wall/post/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content },
                    body: JSON.stringify(payload)
                });

                if ((await res.json()).ok) {
                    alert("Published to Wall!");
                    this.showPublishModal = false;
                } else {
                    alert("Publish failed");
                }
            },

            // Editor Utils
            updateLines() {
                const lines = this.codeContent.split('\n').length;
                document.getElementById('line-numbers').innerHTML = Array(lines).fill(0).map((_, i) => `<div>${i + 1}</div>`).join('');
            },

            syncScroll(e) {
                document.getElementById('line-numbers').scrollTop = e.target.scrollTop;
            },

            insertTab(e) {
                const start = e.target.selectionStart;
                const end = e.target.selectionEnd;
                this.codeContent = this.codeContent.substring(0, start) + "  " + this.codeContent.substring(end);
                // Vue/Alpine reactivity might jerk cursor, need nextTick fix usually, but manual set works for basic
                this.$nextTick(() => {
                    e.target.selectionStart = e.target.selectionEnd = start + 2;
                });
            },

            logToConsole(msg, type = 'info') {
                const div = document.createElement('div');
                div.textContent = `> ${msg}`;
                if (type === 'error') div.className = "text-red-500 font-bold";
                else if (type === 'system') div.className = "text-yellow-400";

                const consoleLogs = document.getElementById('console-logs');
                consoleLogs.appendChild(div);
                consoleLogs.scrollTop = consoleLogs.scrollHeight;
            },

            clearConsole() {
                document.getElementById('console-logs').innerHTML = '';
            },

            formatDate(iso) {
                if (!iso) return '';
                return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            }
        }))
    });
</script>
{% endblock %}