{% extends "base.html" %}

{% block title %}Codeground v2.0 - NeoSpace{% endblock %}
{% block page_title %}CODEGROUND v2.0{% endblock %}

{% block head %}
<style>
    /* Editor Gutter & Overlay */
    .editor-wrapper {
        position: relative;
        counter-reset: line;
        display: flex;
        height: 100%;
        background-color: #0f172a;
        color: #e2e8f0;
        font-family: 'Courier New', Courier, monospace;
    }

    .line-numbers {
        width: 3rem;
        padding: 1rem 0.5rem;
        background-color: #1e293b;
        color: #64748b;
        text-align: right;
        border-right: 1px solid #334155;
        user-select: none;
        font-size: 0.875rem;
        line-height: 1.5rem;
        overflow: hidden;
    }

    .line-numbers div {
        height: 1.5rem;
    }

    #code-input {
        flex: 1;
        background: transparent;
        color: inherit;
        border: none;
        padding: 1rem;
        line-height: 1.5rem;
        font-size: 0.875rem;
        resize: none;
        white-space: pre;
        outline: none;
        overflow: auto;
        tab-size: 2;
    }

    /* Syntax Highlighting (Poor man's) */
    .syntax-layer {
        position: absolute;
        top: 0;
        left: 3rem;
        right: 0;
        bottom: 0;
        pointer-events: none;
        padding: 1rem;
        line-height: 1.5rem;
        font-size: 0.875rem;
        white-space: pre;
        color: transparent;
        /* Text is transparent, we show background highlights/tokens? No, too complex for raw html. */
        /* For v2.0 we stick to raw text but better DX */
    }

    /* Sidebar Transitions */
    .sidebar-panel-enter {
        transform: translateX(-100%);
    }

    .sidebar-panel-active {
        transform: translateX(0);
    }
</style>
{% endblock %}

{% block main_container %}
{% from "components/ui_macros.html" import button, input, textarea %}
{% from "components/skeleton.html" import skeleton %}
{% from "components/dialog.html" import dialog %}
<div class="flex h-full overflow-hidden bg-bbs-bg" x-data="codeground()">

    <!-- LEFT: Script Manager Sidebar -->
    <div class="w-64 flex flex-col border-r-2 border-black bg-white shrink-0 transform transition-transform duration-200"
        :class="sidebarOpen ? 'translate-x-0' : '-translate-x-64 absolute z-50 h-full shadow-hard-xl'">

        <div class="h-10 flex items-center justify-between px-3 bg-black text-white shrink-0">
            <span class="font-bold uppercase text-xs tracking-widest">My Scripts</span>
            <button @click="createNewsScript()" class="hover:text-acid-green" title="New Script"><i
                    class="ph-bold ph-plus"></i></button>
        </div>

        <!-- Script List -->
        <div class="flex-1 overflow-y-auto p-2 space-y-2">
            <template x-if="loadingScripts">
                <div class="space-y-3 mt-2">
                    <div class="p-2 border-2 border-transparent">
                        <div class="flex justify-between items-start mb-1">
                            {{ skeleton('h-4 w-24') }}
                            {{ skeleton('h-3 w-12') }}
                            <div class="flex flex-col gap-2 p-2">
                                <div class="h-8 bg-gray-200 animate-pulse rounded"></div>
                                <div class="h-8 bg-gray-200 animate-pulse rounded"></div>
                                <div class="h-8 bg-gray-200 animate-pulse rounded"></div>
                            </div>
            </template>
            <template x-for="script in scripts" :key="script.id">
                <div @click="loadScript(script.id)"
                    class="p-3 border-2 border-transparent hover:border-black hover:bg-acid-green/20 cursor-pointer mb-1 group transition-all"
                    :class="currentScriptId === script.id ? 'bg-acid-green border-black shadow-[4px_4px_0_0_#000]' : ''">
                    <div class="flex justify-between items-start">
                        <span class="font-bold text-sm truncate" x-text="script.title || 'Untitled'"></span>
                        <span class="text-[10px] bg-black text-white px-1 font-mono" x-text="script.script_type"></span>
                    </div>
                    <div class="text-xs text-gray-500 font-mono mt-1 flex justify-between">
                        <span x-text="formatDate(script.last_modified)"></span>
                        <span x-show="!script.parent_id" class="opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="ph-bold ph-trash hover:text-red-600" @click.stop="deleteScript(script.id)"></i>
                        </span>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Toggle Handle (When closed) -->
    <button x-show="!sidebarOpen" @click="sidebarOpen = true" x-transition.opacity
        class="absolute -right-8 top-10 w-8 h-10 bg-black text-white flex items-center justify-center border-y-2 border-r-2 border-white cursor-pointer hover:bg-acid-green hover:text-black active:scale-95 origin-left transition-transform">
        <i class="ph-bold ph-caret-right"></i>
    </button>

    {% call dialog('publish-modal', 'Release Script') %}
    <div class="flex flex-col gap-4">
        <p class="text-sm text-gray-600">Prepare your script for public release.</p>

        <div class="flex flex-col gap-1">
            <label class="font-bold text-xs uppercase">Title</label>
            <input type="text" x-model="currentTitle"
                class="border-2 border-black p-2 font-mono text-sm focus:outline-none focus:bg-acid-green/10">
        </div>

        <div class="flex flex-col gap-1">
            <label class="font-bold text-xs uppercase">Description</label>
            <textarea x-model="publishDesc" rows="3"
                class="border-2 border-black p-2 font-mono text-sm focus:outline-none focus:bg-acid-green/10"
                placeholder="What does this script do?"></textarea>
        </div>

        <div class="bg-gray-100 p-3 border border-gray-300 text-xs font-mono text-gray-500">
            <p><strong>Note:</strong> This will post to your Wall and the public Feed. Code is viewable by everyone.</p>
        </div>
    </div>

    <!-- Custom Footer -->
    <div class="flex justify-end gap-3 pt-4 border-t-2 border-black/10 mt-4">
        {{ button('Cancel', variant='ghost', class='border-2 border-transparent hover:border-black',
        attrs='@click="$dispatch(\'close-dialog-publish-modal\')"') }}
        {{ button('Publish to Wall', variant='primary', icon='ph-bold ph-paper-plane-tilt', class='bg-black text-white
        hover:bg-mid-blue hover:text-black', attrs='@click="publishToWall()"') }}
    </div>
    {% endcall %}

    <!-- Rest of the CodeGround Implementation -->
    <!-- ... -->

    <!-- CENTER: Main Area -->
    <div class="flex-1 flex flex-col min-w-0 relative">

        <!-- Toolbar -->
        <div class="h-12 border-b-2 border-black bg-bbs-surface flex items-center justify-between px-4 shrink-0">
            <div class="flex items-center gap-3">
                <button @click="sidebarOpen = !sidebarOpen"
                    class="w-8 h-8 border-2 border-black flex items-center justify-center hover:bg-yellow-300 transition-colors"
                    :class="sidebarOpen ? 'bg-black text-white' : 'bg-white'">
                    <i class="ph-bold ph-sidebar-simple"></i>
                </button>

                {{ input('currentTitle', attrs='x-model="currentTitle" @input="docDirty = true"', wrapper_class='w-64',
                class='h-8 font-bold text-sm', placeholder='Untitled Script') }}

                <span x-show="docDirty" class="text-xs font-mono text-red-500 animate-pulse font-bold uppercase">*
                    Unsaved</span>
            </div>

            <div class="flex items-center gap-2">
                <!-- Fork -->
                <button @click="forkScript()"
                    class="flex items-center gap-2 px-3 py-1.5 border-2 border-black bg-white hover:bg-yellow-300 transition-all shadow-hard-sm"
                    title="Fork this script">
                    <i class="ph-bold ph-git-fork"></i>
                    <span class="font-bold text-sm">FORK</span>
                </button>

                <!-- Save Draft (Only if owner) -->
                <button x-show="isOwner" @click="saveScript()"
                    class="flex items-center gap-2 px-3 py-1.5 border-2 border-transparent hover:border-black hover:bg-acid-green transition-all"
                    :class="{'opacity-50': isSaving}" :disabled="isSaving">
                    <i class="ph-bold ph-floppy-disk"></i>
                    <span class="font-bold text-sm" x-text="isSaving ? 'Saving...' : 'SAVE DRAFT'"></span>
                </button>

                <!-- Save as Fork (If NOT owner) -->
                <button x-show="!isOwner" @click="forkScript(); saveScript()"
                    class="flex items-center gap-2 px-3 py-1.5 border-2 border-black bg-acid-green hover:bg-acid-green-dark transition-all shadow-hard-sm">
                    <i class="ph-bold ph-floppy-disk"></i>
                    <span class="font-bold text-sm">SAVE TO MY SCRIPTS</span>
                </button>

                <div class="h-6 w-px bg-gray-300 mx-2"></div>

                <!-- Run -->
                {{ button('Run', variant='primary', class='bg-electric-blue hover:bg-cyan-300 shadow-hard-sm',
                icon='ph-bold ph-play', attrs='@click="runCode()"') }}

                <!-- Publish -->
                {{ button('Publish', variant='primary', class='bg-purple-600 text-white hover:bg-purple-500
                shadow-hard-sm', icon='ph-bold ph-upload-simple', attrs='@click="openPublishModal()"') }}
            </div>
        </div>

        <!-- Editor / Preview Split -->
        <div class="flex-1 flex overflow-hidden">
            <!-- IDE -->
            <div class="w-1/2 flex flex-col relative border-r-2 border-black">
                <div class="editor-wrapper group">
                    <div class="line-numbers font-mono text-xs opacity-50" id="line-numbers">1</div>
                    <textarea id="code-input" x-model="codeContent" @input="updateLines(); docDirty = true"
                        @scroll="syncScroll($event)" @keydown.tab.prevent="insertTab($event)"
                        spellcheck="false"></textarea>
                </div>
            </div>

            <!-- Preview -->
            <div class="w-1/2 bg-black flex flex-col relative">
                <iframe id="preview-frame" class="flex-1 border-none bg-white"></iframe>

                <!-- Console Overlay -->
                <div class="h-32 bg-gray-900 border-t-2 border-white/20 text-green-400 font-mono text-xs p-2 overflow-y-auto"
                    id="console-logs">
                    <div class="text-gray-500 mb-1 border-b border-gray-700 pb-1 flex justify-between">
                        <span>CONSOLE OUTPUT</span>
                        <span class="cursor-pointer hover:text-white" @click="clearConsole()">CLEAR</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    window.initCodeground = window.initCodeground || (() => {
        Alpine.data('codeground', () => ({
            userId: {{ g.user.id if g.user else 'null' }},
        sidebarOpen: true,
            scripts: [],
                loadingScripts: false,
                    currentScriptId: null,
                        currentTitle: 'Untitled Script',
                            codeContent: `const scene = new THREE.Scene();\nconst camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight);\ncamera.position.z = 5;\n\nconst renderer = new THREE.WebGLRenderer({ alpha: true });\nrenderer.setSize(window.innerWidth, window.innerHeight);\ndocument.body.appendChild(renderer.domElement);\n\nconst geometry = new THREE.IcosahedronGeometry(1.5, 0);\nconst material = new THREE.MeshBasicMaterial({ color: 0xa3e635, wireframe: true });\nconst cube = new THREE.Mesh(geometry, material);\nscene.add(cube);\n\nfunction animate() {\n    requestAnimationFrame(animate);\n    cube.rotation.x += 0.01;\n    cube.rotation.y += 0.01;\n    renderer.render(scene, camera);\n}\nanimate();`,
                                docDirty: false,
                                    isSaving: false,
                                        showPublishModal: false,
                                            publishDesc: '',
                                                isOwner: true,
                                                    parentId: null,

                                                        init() {
        this.updateLines();
        this.fetchScripts();
        this.runCode();

        window.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                this.saveScript();
            }
        });

        window.addEventListener('message', (e) => {
            if (e.data.type === 'log') this.logToConsole(e.data.msg);
            if (e.data.type === 'error') this.logToConsole(e.data.msg, 'error');
        });
    },

            async forkScript() {
        if (!this.currentScriptId) return;
        this.parentId = this.currentScriptId;
        this.currentScriptId = null;
        this.currentTitle = "Fork of " + this.currentTitle;
        this.isOwner = true;
        this.docDirty = true;
        window.dispatchEvent(new CustomEvent('toast', { detail: { title: 'Forked', message: 'Created a local copy. Save to persist.', type: 'info' } }));
    },

            async fetchScripts() {
        this.loadingScripts = true;
        const res = await fetch('/scripts/list');
        const data = await res.json();
        if (data.ok) this.scripts = data.scripts;
        this.loadingScripts = false;
    },

            async createNewsScript() {
        this.currentScriptId = null;
        this.currentTitle = "Untitled Script";
        this.codeContent = "// New Script\n";
        this.docDirty = false;
        this.runCode();
    },

            async loadScript(id) {
        if (this.docDirty && !confirm("Unsaved changes! Discard?")) return;

        const res = await fetch('/scripts/get?id=' + id);
        const data = await res.json();
        if (data.ok) {
            this.currentScriptId = data.script.id;
            this.currentTitle = data.script.title;
            this.codeContent = data.script.content;
            this.isOwner = (data.script.user_id === this.userId);
            this.parentId = data.script.parent_id;
            this.docDirty = false;
            this.runCode();
            this.updateLines();
        }
    },

            async saveScript() {
        this.isSaving = true;
        const payload = {
            id: this.currentScriptId,
            title: this.currentTitle,
            content: this.codeContent,
            script_type: 'p5',
            is_public: 1,
            parent_id: this.parentId
        };

        const res = await fetch('/scripts/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content },
            body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (data.ok) {
            this.currentScriptId = data.id;
            this.isOwner = true; // After saving (either new or update), I am the owner
            this.parentId = null; // Lineage is saved in DB now
            this.docDirty = false;
            this.fetchScripts(); // Refresh list
            this.logToConsole("Saved successfully.", 'system');
            window.dispatchEvent(new CustomEvent('toast', { detail: { title: 'Saved', message: 'Script saved successfully.', type: 'success' } }));
        } else {
            window.dispatchEvent(new CustomEvent('toast', { detail: { title: 'Error', message: 'Error saving: ' + data.error, type: 'error' } }));
            this.logToConsole("Error saving: " + data.error, 'error');
        }
        this.isSaving = false;
    },

            async deleteScript(id) {
        if (!confirm("Are you sure?")) return;
        const res = await fetch('/scripts/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content },
            body: JSON.stringify({ id })
        });
        if ((await res.json()).ok) {
            this.fetchScripts();
            if (this.currentScriptId === id) this.createNewsScript();
        }
    },

    runCode() {
        const frame = document.getElementById('preview-frame');
        const html = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>body { margin: 0; overflow: hidden; background: white; }</style>
                        <script src="/static/vendor/three.min.js"><\/script>
                        <script src="/static/vendor/p5.min.js"><\/script>
                    </head>
                    <body>
                        <script>
                            window.console.log = (...args) => window.parent.postMessage({type: 'log', msg: args.join(' ')}, '*');
                            window.console.error = (...args) => window.parent.postMessage({type: 'error', msg: args.join(' ')}, '*');
                            window.onerror = (msg) => window.parent.postMessage({type: 'error', msg}, '*');
                            try { ${this.codeContent} } catch(e) { console.error(e); }
                        <\/script>
                    </body>
                    </html>
                `;
        const blob = new Blob([html], { type: 'text/html' });
        frame.src = URL.createObjectURL(blob);
        this.clearConsole();
        this.logToConsole("Running...", 'system');
    },

    openPublishModal() {
        if (this.docDirty) {
            window.dispatchEvent(new CustomEvent('toast', { detail: { title: 'Unsaved Changes', message: 'Please save your script before publishing.', type: 'warning' } }));
            this.saveScript();
            return;
        }
        window.dispatchEvent(new CustomEvent('open-dialog-publish-modal'));
    },

            async publishToWall() {
        if (!this.currentScriptId) {
            window.dispatchEvent(new CustomEvent('toast', { detail: { title: 'Error', message: 'Save the script first!', type: 'error' } }));
            return;
        }

        const payload = {
            module_type: 'script',
            content: {
                script_id: this.currentScriptId,
                title: this.currentTitle,
                description: this.publishDesc,
                code: this.codeContent
            },
            style: { theme: 'dark' }
        };

        const res = await fetch('/wall/post/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content },
            body: JSON.stringify(payload)
        });

        if ((await res.json()).ok) {
            window.dispatchEvent(new CustomEvent('toast', { detail: { title: 'Published', message: 'Script published to your Wall!', type: 'success' } }));
        } else {
            window.dispatchEvent(new CustomEvent('toast', { detail: { title: 'Failed', message: 'Could not publish script.', type: 'error' } }));
        }
    },

    // Editor Utils
    updateLines() {
        const lines = this.codeContent.split('\n').length;
        const lineNumbers = document.getElementById('line-numbers');
        if (lineNumbers) {
            lineNumbers.innerHTML = Array(lines).fill(0).map((_, i) => `<div>${i + 1}</div>`).join('');
        }
    },

    syncScroll(e) {
        const lineNumbers = document.getElementById('line-numbers');
        if (lineNumbers) {
            lineNumbers.scrollTop = e.target.scrollTop;
        }
    },

    insertTab(e) {
        const start = e.target.selectionStart;
        const end = e.target.selectionEnd;
        this.codeContent = this.codeContent.substring(0, start) + "  " + this.codeContent.substring(end);
        this.$nextTick(() => {
            e.target.selectionStart = e.target.selectionEnd = start + 2;
        });
    },

    logToConsole(msg, type = 'info') {
        const div = document.createElement('div');
        div.textContent = `> ${msg}`;
        if (type === 'error') div.className = "text-red-500 font-bold";
        else if (type === 'system') div.className = "text-yellow-400";

        const consoleLogs = document.getElementById('console-logs');
        if (consoleLogs) {
            consoleLogs.appendChild(div);
            consoleLogs.scrollTop = consoleLogs.scrollHeight;
        }
    },

    clearConsole() {
        const consoleLogs = document.getElementById('console-logs');
        if (consoleLogs) {
            consoleLogs.innerHTML = '';
        }
    },

    formatDate(iso) {
        if (!iso) return '';
        return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
}));
    });

    if (window.Alpine) {
        window.initCodeground();
    } else {
        document.addEventListener('alpine:init', window.initCodeground);
    }

</script>
{% endblock %}