{% extends "base.html" %}

{% block title %}CatPool OS - NeoSpace{% endblock %}

{% block head %}
<style>
    :root {
        --pool-bg: #ece9d8;
        --pool-window: #f0f0f0;
        --pool-border: #000;
        --pool-accent: #008080;
        --pool-title: #000080;
    }

    [x-cloak] {
        display: none !important;
    }

    body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        user-select: none;
    }

    /* Desktop Environment */
    .cat-desktop {
        position: fixed;
        inset: 0;
        background-color: var(--pool-bg);
        background-image:
            linear-gradient(45deg, rgba(0, 0, 0, 0.05) 25%, transparent 25%, transparent 75%, rgba(0, 0, 0, 0.05) 75%, rgba(0, 0, 0, 0.05)),
            linear-gradient(45deg, rgba(0, 0, 0, 0.05) 25%, transparent 25%, transparent 75%, rgba(0, 0, 0, 0.05) 75%, rgba(0, 0, 0, 0.05));
        background-size: 4px 4px;
        background-position: 0 0, 2px 2px;
        font-family: 'Chicago', 'Inter', monospace;
    }

    /* Top Navigation Bar */
    .cat-topbar {
        height: 28px;
        background: white;
        border-bottom: 2px solid black;
        display: flex;
        align-items: center;
        padding: 0 10px;
        justify-content: space-between;
        font-weight: 900;
        text-transform: uppercase;
        font-size: 13px;
        z-index: 1000;
        position: relative;
    }

    .cat-menu-item {
        padding: 0 8px;
        cursor: pointer;
    }

    .cat-menu-item:hover {
        background: black;
        color: white;
    }

    /* Window System */
    .cat-window {
        position: absolute;
        background: var(--pool-window);
        border: 2px solid black;
        box-shadow: 4px 4px 0 0 rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        min-width: 200px;
        min-height: 100px;
    }

    .cat-window.active {
        box-shadow: 8px 8px 0 0 rgba(0, 0, 0, 0.2);
    }

    .cat-window-header {
        height: 24px;
        background: repeating-linear-gradient(0deg,
                #ccc,
                #ccc 2px,
                #fff 2px,
                #fff 4px);
        border-bottom: 2px solid black;
        display: flex;
        align-items: center;
        padding: 0 4px;
        cursor: move;
    }

    .cat-window.active .cat-window-header {
        background: repeating-linear-gradient(0deg,
                #000,
                #000 2px,
                #333 2px,
                #333 4px);
        color: white;
    }

    .cat-window-title {
        flex: 1;
        text-align: center;
        font-weight: 900;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .cat-window-btn {
        width: 16px;
        height: 16px;
        border: 2px solid black;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .cat-window-btn:active {
        transform: translate(1px, 1px);
    }

    .cat-window-content {
        flex: 1;
        overflow: auto;
        padding: 8px;
        background: white;
        margin: 4px;
        border: 2px solid black;
    }

    /* Dock / Taskbar */
    .cat-dock {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        height: 60px;
        background: white;
        border: 2px solid black;
        display: flex;
        align-items: center;
        padding: 0 10px;
        gap: 10px;
        box-shadow: 4px 4px 0 0 rgba(0, 0, 0, 1);
        z-index: 1000;
    }

    .dock-item {
        width: 44px;
        height: 44px;
        border: 2px solid black;
        background: #f0f0f0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        position: relative;
    }

    .dock-item:hover {
        background: var(--pool-bg);
        transform: translateY(-2px);
    }

    .dock-item.active::after {
        content: '';
        position: absolute;
        bottom: -6px;
        width: 6px;
        height: 6px;
        background: black;
        border-radius: 50%;
    }

    /* Specific Window Content */
    .cat-player-video {
        width: 100%;
        aspect-ratio: 16/9;
        background: black;
        position: relative;
        overflow: hidden;
    }

    .grain {
        position: absolute;
        inset: 0;
        background-color: transparent;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        opacity: 0.1;
        pointer-events: none;
        animation: grain-animation 1s infinite steps(10);
    }

    @keyframes grain-animation {

        0%,
        100% {
            transform: translate(0, 0)
        }

        10% {
            transform: translate(-5%, -10%)
        }

        20% {
            transform: translate(-15%, 5%)
        }

        30% {
            transform: translate(7%, -25%)
        }

        40% {
            transform: translate(-5%, 25%)
        }

        50% {
            transform: translate(-15%, 10%)
        }

        60% {
            transform: translate(15%, 0%)
        }

        70% {
            transform: translate(0%, 15%)
        }

        80% {
            transform: translate(3%, 35%)
        }

        90% {
            transform: translate(-10%, 10%)
        }
    }

    /* Modals / Themes */
    .theme-martini {
        --pool-bg: #e6dada;
        --pool-window: #f5f5f5;
        --pool-accent: #ff69b4;
    }

    .theme-acid {
        --pool-bg: #000;
        --pool-window: #fff;
        --pool-accent: #a3e635;
        background-image: none !important;
    }

    .theme-acid .cat-desktop {
        background: black;
    }

    .theme-inverted {
        filter: invert(1) hue-rotate(180deg);
    }

    /* CYBERPUNK ANIMATIONS */
    @keyframes scanline {
        0% {
            transform: translateY(-100%);
        }

        100% {
            transform: translateY(100vh);
        }
    }

    @keyframes glitch {
        0% {
            transform: translate(0);
        }

        20% {
            transform: translate(-2px, 2px);
        }

        40% {
            transform: translate(-2px, -2px);
        }

        60% {
            transform: translate(2px, 2px);
        }

        80% {
            transform: translate(2px, -2px);
        }

        100% {
            transform: translate(0);
        }
    }

    @keyframes equalizer {
        0% {
            height: 10%;
        }

        50% {
            height: 100%;
        }

        100% {
            height: 10%;
        }
    }

    .scanline {
        animation: scanline 8s linear infinite;
    }

    .glitch-active {
        animation: glitch 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
    }

    .neon-text {
        text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor;
    }

    .brutal-shadow {
        box-shadow: 8px 8px 0px rgba(0, 0, 0, 1);
    }

    .brutal-shadow-sm {
        box-shadow: 4px 4px 0px rgba(0, 0, 0, 1);
    }

    /* ASCII CAT ANIMATIONS */
    .ascii-cat {
        font-family: monospace;
        line-height: 1;
        white-space: pre;
        display: block;
    }

    @keyframes purr-glow {
        0% {
            color: #00ff66;
            text-shadow: none;
        }

        50% {
            color: #66ff99;
            text-shadow: 0 0 6px #00ff66;
        }

        100% {
            color: #00ff66;
            text-shadow: none;
        }
    }

    .cat-purr {
        animation: purr-glow 1.6s infinite ease-in-out;
    }

    @keyframes hiss-flicker {

        0%,
        100% {
            color: #ff3333;
            opacity: 1;
        }

        45% {
            opacity: 0.4;
        }

        50% {
            opacity: 1;
        }

        52% {
            opacity: 0.6;
        }
    }

    .cat-hiss {
        animation: hiss-flicker 0.9s infinite steps(1);
    }

    @keyframes chaos-surge {
        0% {
            color: #ff00ff;
            text-shadow: none;
        }

        25% {
            color: #00ffff;
            text-shadow: 0 0 8px #ff00ff;
        }

        50% {
            color: #ffffff;
            text-shadow: 0 0 12px #00ffff;
        }

        75% {
            color: #ff00ff;
        }

        100% {
            color: #ff00ff;
            text-shadow: none;
        }
    }

    .cat-chaos {
        animation: chaos-surge 0.6s infinite;
    }

    /* Abstract Skin Pattern */
    .bg-dots {
        background-image: radial-gradient(#000 15%, transparent 16%), radial-gradient(#000 15%, transparent 16%);
        background-size: 10px 10px;
        background-position: 0 0, 5px 5px;
    }
</style>
{% endblock %}

{% block main_container %}
<div class="cat-desktop" :class="theme" x-data="catPoolOS()" @mousedown="focusDesktop()" x-init="init()">

    <!-- Top Bar -->
    <div class="cat-topbar">
        <div class="cat-menu-item font-black" @click="toggleWindow('About')">ï£¿ CatPool</div>
        <div class="cat-menu-item" @click="toggleWindow('Explorer')">File</div>
        <div class="cat-menu-item" @click="toggleWindow('Settings')">Edit</div>
        <div class="cat-menu-item">View</div>
        <div class="cat-menu-item">Special</div>
    </div>
    <div class="flex gap-4 items-center">
        <div class="font-mono text-xs" x-text="time"></div>
    </div>
</div>

<!-- Windows Container -->
<template x-for="(win, index) in windows" :key="win.id">
    <div class="cat-window" x-show="win.open" :class="{ 'active': activeWindow === win.id }"
        :style="`top: ${win.y}px; left: ${win.x}px; z-index: ${win.z}; width: ${win.width}px; height: ${win.height}px;`"
        @mousedown.stop="bringToFront(win.id)">

        <!-- Window Title Bar -->
        <div class="cat-window-header" @mousedown="startDrag($event, win)">
            <div class="cat-window-btn" @click.stop="closeWindow(win.id)">
                <i class="ph-bold ph-x text-[8px]"></i>
            </div>
            <div class="cat-window-title" x-text="win.title"></div>
            <div class="cat-window-btn" @click.stop="toggleCollapse(win.id)">
                <i class="ph-bold ph-minus text-[8px]"></i>
            </div>
        </div>

        <!-- Window Content -->
        <div class="cat-window-content flex flex-col" x-show="!win.collapsed">
            <template x-if="win.id === 'Player'">
                <div class="flex flex-col h-full overflow-hidden">

                    <!-- CLASSIC SKIN (Original) -->
                    <template x-if="playerSkin === 'classic'">
                        <div class="flex flex-col h-full">
                            <div class="cat-player-video flex-1">
                                <div class="grain"></div>
                                <img src="/static/images/cats/beans_playful.png"
                                    class="w-full h-full object-cover grayscale contrast-125 brightness-75">
                                <div class="absolute bottom-2 left-2 text-[10px] text-white font-mono bg-black/50 px-1">
                                    NOW PLAYING: MEOW_MIX_VOL1.VHS
                                </div>
                            </div>
                            <div class="p-2 border-t-2 border-black flex items-center justify-between mt-auto">
                                <div class="flex gap-2">
                                    <button class="nb-button p-1"><i class="ph-bold ph-skip-back"></i></button>
                                    <button class="nb-button p-1" @click="playing = !playing">
                                        <i class="ph-bold" :class="playing ? 'ph-pause' : 'ph-play'"></i>
                                    </button>
                                    <button class="nb-button p-1"><i class="ph-bold ph-skip-forward"></i></button>
                                </div>
                                <div class="flex-1 px-4">
                                    <div class="h-2 bg-gray-200 border-2 border-black relative">
                                        <div class="h-full bg-black w-1/3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- NEUBRUTALIST SKIN (Player 1) -->
                    <template x-if="playerSkin === 'neobrutalist'">
                        <div
                            class="relative bg-white border-4 border-black p-4 shadow-[4px_4px_0_0_#000] h-full flex flex-col">
                            <div class="flex justify-between items-center mb-2 border-b-4 border-black pb-1">
                                <h2 class="font-black text-lg uppercase italic tracking-tighter">PLAYER_01</h2>
                                <div class="h-3 w-3 bg-red-500 border-2 border-black rounded-full"></div>
                            </div>
                            <div class="relative mb-2 flex-1 overflow-hidden">
                                <img src="/static/images/cats/neon.png"
                                    class="w-full h-full object-cover border-4 border-black grayscale transition-all duration-300"
                                    :class="playing ? 'grayscale-0' : 'grayscale'">
                                <div
                                    class="absolute bottom-1 right-1 bg-yellow-400 border-2 border-black px-1 font-bold text-[10px] shadow-[2px_2px_0_0_#000]">
                                    HI-FI
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-auto pt-2">
                                <button
                                    class="w-10 h-10 bg-yellow-400 border-4 border-black flex items-center justify-center shadow-[2px_2px_0_0_#000] active:translate-x-1 active:translate-y-1 active:shadow-none"
                                    @click="playing = !playing">
                                    <i class="ph-bold" :class="playing ? 'ph-pause' : 'ph-play'"></i>
                                </button>
                                <div class="font-black text-lg leading-none text-right">
                                    <div>NEON CITY</div>
                                    <div class="text-[10px] bg-black text-white inline-block px-1">SYNTHWAVE</div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- MATRIX SKIN (Player 2) -->
                    <template x-if="playerSkin === 'matrix'">
                        <div
                            class="relative bg-zinc-900 border-2 border-green-500 p-4 font-mono shadow-[4px_4px_0_0_#22c55e] h-full flex flex-col overflow-hidden">
                            <div class="flex justify-between text-[10px] text-green-500/60 mb-2 tracking-widest">
                                <span>SYS: AUDIO_OUT</span>
                                <span x-text="playing ? 'STATUS: RUN' : 'STATUS: IDLE'"></span>
                            </div>
                            <div
                                class="relative w-full flex-1 bg-zinc-800 border border-green-500 mb-2 p-1 overflow-hidden">
                                <div
                                    class="absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] z-10 pointer-events-none bg-[length:100%_4px,6px_100%]">
                                </div>
                                <img src="/static/images/cats/root.png"
                                    class="w-full h-full object-cover sepia hue-rotate-90 contrast-125 brightness-75">
                            </div>
                            <div class="grid grid-cols-3 gap-1 mt-auto">
                                <button
                                    class="border border-green-500 text-green-500 hover:bg-green-500 hover:text-black py-1 text-[10px] uppercase transition-colors">[
                                    < ]</button>
                                        <button @click="playing = !playing"
                                            class="border border-green-500 text-green-500 hover:bg-green-500 hover:text-black py-1 text-[10px] uppercase font-bold transition-colors">
                                            <span x-text="playing ? '[ || ]' : '[ > ]'"></span>
                                        </button>
                                        <button
                                            class="border border-green-500 text-green-500 hover:bg-green-500 hover:text-black py-1 text-[10px] uppercase transition-colors">[
                                            > ]</button>
                            </div>
                        </div>
                    </template>

                    <!-- ABSTRACT SKIN (Player 3) -->
                    <template x-if="playerSkin === 'abstract'">
                        <div class="relative mt-2 mx-auto w-64">
                            <div
                                class="absolute inset-0 bg-indigo-600 border-4 border-black translate-x-2 translate-y-2 z-0">
                            </div>
                            <div
                                class="relative z-10 bg-white border-4 border-black p-0 overflow-visible h-full flex flex-col">
                                <div
                                    class="h-10 bg-dots border-b-4 border-black flex items-center justify-center overflow-hidden shrink-0">
                                    <span
                                        class="bg-black text-white px-2 py-0.5 font-black text-lg -rotate-2">MUSIC!</span>
                                </div>
                                <div class="p-4 pt-8 text-center relative flex-1 flex flex-col">
                                    <div
                                        class="absolute -top-10 left-1/2 -translate-x-1/2 w-16 h-16 rounded-full border-4 border-black overflow-hidden bg-yellow-300 z-20 shadow-[4px_4px_0_0_#000]">
                                        <img src="/static/images/cats/tofu.png" class="w-full h-full object-cover">
                                    </div>
                                    <h3 class="font-black text-xl mt-2 leading-none">NEON CITY</h3>
                                    <p class="font-bold text-indigo-600 text-xs">The Synthwaves</p>

                                    <div
                                        class="mt-4 relative h-6 bg-black rounded-full border-4 border-black group cursor-pointer w-full">
                                        <div class="absolute top-0 left-0 h-full bg-yellow-400 rounded-l-full"
                                            style="width: 45%"></div>
                                        <div class="absolute top-1/2 -translate-y-1/2 h-8 w-8 bg-white border-4 border-black rounded-full shadow-[2px_2px_0_0_#000] hover:scale-110 transition-transform"
                                            style="left: calc(45% - 16px)"></div>
                                    </div>

                                    <div class="flex justify-center gap-3 mt-auto pt-4 -mb-8 relative z-30">
                                        <button
                                            class="w-10 h-10 bg-cyan-400 border-4 border-black rounded-full flex items-center justify-center hover:-translate-y-1 transition-transform shadow-[4px_4px_0_0_#000] active:shadow-none active:translate-y-1">
                                            <i class="ph-bold ph-skip-back text-sm"></i>
                                        </button>
                                        <button @click="playing = !playing"
                                            class="w-14 h-14 bg-pink-500 border-4 border-black rounded-full flex items-center justify-center -mt-3 hover:-translate-y-1 transition-transform shadow-[4px_4px_0_0_#000] active:shadow-none active:translate-y-1">
                                            <i class="ph-bold text-white text-xl"
                                                :class="playing ? 'ph-pause' : 'ph-play'"></i>
                                        </button>
                                        <button
                                            class="w-10 h-10 bg-cyan-400 border-4 border-black rounded-full flex items-center justify-center hover:-translate-y-1 transition-transform shadow-[4px_4px_0_0_#000] active:shadow-none active:translate-y-1">
                                            <i class="ph-bold ph-skip-forward text-sm"></i>
                                        </button>
                                    </div>
                                </div>
                                <!-- Spacer for buttons hanging out -->
                                <div class="h-8 bg-transparent"></div>
                            </div>
                        </div>
                    </template>

                </div>
            </template>

            <template x-if="win.id === 'Explorer'">
                <div class="flex flex-col h-full">
                    <!-- Tabs -->
                    <div class="flex border-b-2 border-black mb-2">
                        <button
                            class="px-2 py-1 text-xs font-bold border-r-2 border-black hover:bg-black hover:text-white"
                            @click="activeTab = 'files'">FILES</button>
                        <button
                            class="px-2 py-1 text-xs font-bold border-r-2 border-black hover:bg-black hover:text-white"
                            @click="activeTab = 'reactions'">REACTIONS</button>
                    </div>

                    <!-- FILES TAB -->
                    <div x-show="activeTab === 'files'" class="grid grid-cols-3 gap-2 p-2 overflow-auto">
                        <template x-for="cat in cats" :key="cat.name">
                            <div class="flex flex-col items-center gap-1 p-2 hover:bg-black hover:text-white cursor-pointer group"
                                @click="openCatProfile(cat)">
                                <div
                                    class="w-12 h-12 border-2 border-black group-hover:border-white overflow-hidden bg-white">
                                    <img :src="cat.avatar_url" class="w-full h-full object-cover">
                                </div>
                                <span class="text-[9px] uppercase font-bold text-center" x-text="cat.name"></span>
                            </div>
                        </template>
                    </div>

                    <!-- REACTIONS TAB -->
                    <div x-show="activeTab === 'reactions'"
                        class="p-2 space-y-4 overflow-auto bg-zinc-900 border-2 border-lime-400 m-2">
                        <div class="space-y-1 cursor-pointer hover:opacity-80" @click="triggerReaction('purr')">
                            <p class="font-mono text-lime-400 text-[10px]">>> RUN: CAT_PURR</p>
                            <pre class="ascii-cat cat-purr text-lime-400 text-xs">
 /\_/\ 
( o.o )  
 > ^ <</pre>
                        </div>

                        <div class="space-y-1 cursor-pointer hover:opacity-80" @click="triggerReaction('hiss')">
                            <p class="font-mono text-red-500 text-[10px]">>> RUN: CAT_HISS</p>
                            <pre class="ascii-cat cat-hiss text-red-500 text-xs">
 /\_/\ 
( >_< ) 
 > || <</pre>
                        </div>

                        <div class="space-y-1 cursor-pointer hover:opacity-80" @click="triggerReaction('chaos')">
                            <p class="font-mono text-fuchsia-500 text-[10px]">>> RUN: CAT_CHAOS</p>
                            <pre class="ascii-cat cat-chaos text-fuchsia-500 text-xs">
 /\_/\  
( x.x ) 
 > ðŸ’¥ <</pre>
                        </div>
                    </div>
                </div>
            </template>

            <template x-if="win.id === 'Settings'">
                <div class="flex flex-col gap-4 p-2">
                    <div>
                        <p class="font-bold text-[10px] uppercase mb-2">Display Mode</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="nb-button text-xs py-1" @click="theme = ''">Standard</button>
                            <button class="nb-button text-xs py-1" @click="theme = 'theme-inverted'">Inverted</button>
                        </div>
                    </div>
                    <div>
                        <p class="font-bold text-[10px] uppercase mb-2">Color Palette</p>
                        <div class="flex flex-wrap gap-2">
                            <button class="w-8 h-8 border-2 border-black bg-white" @click="theme = ''"></button>
                            <button class="w-8 h-8 border-2 border-black bg-pink-200"
                                @click="theme = 'theme-martini'"></button>
                            <button class="w-8 h-8 border-2 border-black bg-acid-green"
                                @click="theme = 'theme-acid'"></button>
                        </div>
                    </div>

                    <div>
                        <p class="font-bold text-[10px] uppercase mb-2">Player Skin</p>
                        <select x-model="playerSkin" class="w-full text-xs p-1 border-2 border-black font-mono">
                            <option value="classic">Classic (VHS)</option>
                            <option value="neobrutalist">Neubrutalist (Playful)</option>
                            <option value="matrix">Matrix (Cyberpunk)</option>
                            <option value="abstract">Abstract (Experimental)</option>
                        </select>
                    </div>

                    <div class="mt-4 border-t-2 border-black pt-4">
                        <button class="nb-button w-full text-xs font-black" @click="reboot()">REBOOT SYSTEM</button>
                    </div>
                </div>
            </template>

            <template x-if="win.id === 'About'">
                <div class="p-4 text-center flex flex-col items-center gap-4">
                    <div
                        class="w-20 h-20 bg-black text-white flex items-center justify-center border-4 border-double border-white shadow-hard">
                        <i class="ph-bold ph-cat text-4xl"></i>
                    </div>
                    <h2 class="font-black text-xl uppercase italic">CatPool OS</h2>
                    <p class="text-xs font-mono">VERSION 1.0.CAT<br>Â© 1997-2026 PURRCRETE SYSTEMS</p>
                    <p class="text-[10px] opacity-70">"Leisure Enhancing Bit-Stream"</p>
                </div>
            </template>
        </div>
    </div>
</template>

<!-- Dock -->
<div class="cat-dock">
    <div class="dock-item" :class="{ 'active': isWindowOpen('Player') }" @click="toggleWindow('Player')"
        title="CatPlayer">
        <i class="ph-bold ph-music-notes"></i>
    </div>
    <div class="dock-item" :class="{ 'active': isWindowOpen('Explorer') }" @click="toggleWindow('Explorer')"
        title="CatExplorer">
        <i class="ph-bold ph-folder-open"></i>
    </div>
    <div class="dock-item" :class="{ 'active': isWindowOpen('Settings') }" @click="toggleWindow('Settings')"
        title="System Settings">
        <i class="ph-bold ph-gear"></i>
    </div>
    <div class="dock-item" :class="{ 'active': isWindowOpen('About') }" @click="toggleWindow('About')"
        title="About CatPool">
        <i class="ph-bold ph-info"></i>
    </div>
</div>

</div>

<script>
    function catPoolOS() {
        return {
            theme: '',
            playerSkin: 'classic',
            activeTab: 'files',
            time: '',
            playing: true,
            activeWindow: null,
            maxZ: 10,
            dragging: null,
            startX: 0,
            startY: 0,

            windows: [
                { id: 'Player', title: 'CatPlayer â˜¼', open: true, x: 100, y: 100, z: 10, width: 400, height: 350, collapsed: false },
                { id: 'Explorer', title: 'CatExplorer', open: false, x: 200, y: 150, z: 5, width: 300, height: 400, collapsed: false },
                { id: 'Settings', title: 'Control Panel', open: false, x: 300, y: 200, z: 5, width: 250, height: 380, collapsed: false },
                { id: 'About', title: 'About CatPool', open: true, x: 600, y: 150, z: 1, width: 250, height: 300, collapsed: false }
            ],

            cats: [
                { name: 'Beans', avatar_url: '/static/images/cats/beans.png' },
                { name: 'Miso', avatar_url: '/static/images/cats/miso.png' },
                { name: 'Tofu', avatar_url: '/static/images/cats/tofu.png' },
                { name: 'Neon', avatar_url: '/static/images/cats/neon.png' },
                { name: 'Hex', avatar_url: '/static/images/cats/hex.png' },
                { name: 'Root', avatar_url: '/static/images/cats/root.png' }
            ],

            init() {
                this.updateTime();
                setInterval(() => this.updateTime(), 1000);
                this.activeWindow = 'Player';
                window.addEventListener('mousemove', (e) => this.doDrag(e));
                window.addEventListener('mouseup', () => this.stopDrag());
            },

            updateTime() {
                const now = new Date();
                const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
                const day = days[now.getDay()];
                const hours = now.getHours().toString().padStart(2, '0');
                const mins = now.getMinutes().toString().padStart(2, '0');
                const secs = now.getSeconds().toString().padStart(2, '0');
                this.time = `${day} ${hours}:${mins}:${secs}`;
            },

            toggleWindow(id) {
                const win = this.windows.find(w => w.id === id);
                if (win) {
                    win.open = !win.open;
                    if (win.open) this.bringToFront(id);
                }
            },

            closeWindow(id) {
                const win = this.windows.find(w => w.id === id);
                if (win) win.open = false;
            },

            toggleCollapse(id) {
                const win = this.windows.find(w => w.id === id);
                if (win) win.collapsed = !win.collapsed;
            },

            isWindowOpen(id) {
                const win = this.windows.find(w => w.id === id);
                return win ? win.open : false;
            },

            bringToFront(id) {
                this.activeWindow = id;
                this.maxZ++;
                const win = this.windows.find(w => w.id === id);
                if (win) win.z = this.maxZ;
            },

            focusDesktop() {
                this.activeWindow = null;
            },

            startDrag(e, win) {
                this.dragging = win;
                this.startX = e.clientX - win.x;
                this.startY = e.clientY - win.y;
                this.bringToFront(win.id);
            },

            doDrag(e) {
                if (this.dragging) {
                    this.dragging.x = e.clientX - this.startX;
                    this.dragging.y = e.clientY - this.startY;
                }
            },

            stopDrag() {
                this.dragging = null;
            },

            reboot() {
                if (confirm("SYTEM REBOOT REQUESTED. PROCEED?")) {
                    window.location.reload();
                }
            },

            openCatProfile(cat) {
                window.dispatchEvent(new CustomEvent('toast', {
                    detail: {
                        title: 'SYSTEM BIT',
                        message: `Accessing data for ${cat.name.toUpperCase()}...`,
                        type: 'info',
                        avatar: cat.avatar_url
                    }
                }));
            },

            triggerReaction(type) {
                window.dispatchEvent(new CustomEvent('toast', {
                    detail: {
                        title: `REACTION: ${type.toUpperCase()}`,
                        message: 'Reaction sequence broadcast to all users.',
                        type: 'success'
                    }
                }));
            }
        }
    }
</script>
{% endblock %}