{% extends "base.html" %}

{% block title %}Comms - NeoSpace{% endblock %}
{% block page_title %}Comms Grid{% endblock %}

{% block head %}
<style>
    /* See ui/css/styles.css for chat overrides */
</style>
<!-- Emoji Picker (CDN fallback due to complex ESM) -->

<!-- Emoji Picker (CDN fallback due to complex ESM) -->
<script type="module" src="/static/vendor/emoji-picker-element.js"></script>
{% endblock %}

{% block main_container %}
{% from "components/ui_macros.html" import button, input %}
{% from "components/tooltip.html" import tooltip %}
<div class="flex h-full overflow-hidden relative" x-data="{ contextOpen: false }">

    <!-- Chat Stream Area -->
    <div class="flex-1 flex flex-col h-full min-w-0 bg-bbs-bg relative">

        <!-- Room Header (Sticky) -->
        <div class="h-12 border-b-4 border-black bg-white flex items-center justify-between px-4 shrink-0 z-10">
            <div class="flex items-center gap-3">
                <div id="status-dot"
                    class="w-3 h-3 bg-acid-green border-4 border-black rounded-none shadow-[2px_2px_0_0_#000]"></div>
                <h2 id="current-room-name" class="font-black uppercase tracking-widest text-lg"># ...</h2>
            </div>
            <div class="flex items-center gap-2">
                <!-- Typing Indicator -->
                <div id="typing-indicator"
                    class="hidden text-xs font-mono font-bold text-gray-500 mr-2 flex items-center gap-1">
                    <span class="animate-pulse">Typing...</span>
                </div>
                {% call tooltip('Toggle Context', position='left') %}
                {{ button(None, variant='secondary', class='w-8 h-8 p-0 flex items-center justify-center shadow-hard-sm
                hover:bg-yellow-300', icon='ph-bold ph-sidebar-simple', attrs='@click="contextOpen = !contextOpen"
                aria-label="Toggle Context Sidebar"') }}
                {% endcall %}
            </div>
        </div>

        <!-- Messages Scroll -->
        <div id="messages-scroll" class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-4">
            <div id="messages" class="flex flex-col gap-4 pb-4">
                <!-- Socket Glue Injects Here -->
            </div>
        </div>

        <!-- Input Area (Sticky Bottom) -->
        <div class="p-4 bg-white border-t-4 border-black shrink-0 relative z-20">
            <form id="message-form" class="flex gap-2 relative">

                <!-- Tools -->
                {% call tooltip('Insert Emoji', position='top') %}
                {{ button(None, variant='secondary', id='emoji-btn', class='w-10 h-10 p-0 flex items-center
                justify-center shadow-hard-sm hover:bg-yellow-300 bg-gray-100', icon='ph-bold ph-smiley text-xl',
                attrs='type="button" aria-label="Insert Emoji"') }}
                {% endcall %}

                {% call tooltip('Upload Image', position='top') %}
                {{ button(None, variant='secondary', id='upload-btn', class='w-10 h-10 p-0 flex items-center
                justify-center shadow-hard-sm hover:bg-electric-blue bg-gray-100', icon='ph-bold ph-image text-xl',
                attrs='type="button" aria-label="Upload Image"') }}
                {% endcall %}

                {% call tooltip('Voice Message', position='top') %}
                {{ button(None, variant='secondary', id='record-btn', class='w-10 h-10 p-0 flex items-center
                justify-center shadow-hard-sm hover:bg-red-400 hover:text-white bg-gray-100 transition-colors',
                icon='ph-bold ph-microphone text-xl',
                attrs='type="button" aria-label="Record Voice Message"') }}
                {% endcall %}

                <!-- Input -->
                <div class="flex-1 relative">
                    {{ input('message', id='input', class='h-10 font-bold', placeholder='Broadcast message...',
                    attrs='autocomplete="off"') }}
                </div>

                <!-- Send -->
                {{ button('SEND', variant='primary', id='send-btn', class='h-10 px-6 bg-black text-white
                hover:bg-hot-pink hover:text-black', attrs='type="submit"') }}

                <!-- Hidden Inputs -->
                <input type="file" id="file-input" class="hidden" accept="image/*" />
            </form>

            <!-- Emoji Picker Overlay -->
            <div id="emoji-picker-container"
                class="hidden absolute bottom-full left-0 mb-2 z-50 border-4 border-black shadow-hard-xl bg-white">
                <emoji-picker></emoji-picker>
            </div>

            <!-- Recording Overlay -->
            <div id="recording-overlay"
                class="hidden absolute inset-0 bg-black/90 z-50 flex items-center px-4 gap-4 animate-fade-in">
                <div class="w-8 h-8 rounded-full bg-red-500 animate-pulse"></div>
                <canvas id="voice-canvas" class="flex-1 h-12 bg-black/50 rounded"></canvas>
                <div class="flex gap-2">
                    <button id="cancel-recording"
                        class="px-4 py-2 bg-gray-700 text-white font-bold border-2 border-white/20 hover:bg-gray-600 rounded">
                        CANCEL
                    </button>
                    <button id="stop-recording"
                        class="px-4 py-2 bg-red-500 text-white font-bold border-2 border-white/20 hover:bg-red-600 rounded flex items-center gap-2">
                        <i class="ph-bold ph-paper-plane-right"></i> SEND
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Pane (Right Sidebar) -->
    <div x-show="contextOpen" x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="translate-x-full" x-transition:enter-end="translate-x-0"
        x-transition:leave="transition ease-in duration-150" x-transition:leave-start="translate-x-0"
        x-transition:leave-end="translate-x-full"
        class="w-72 bg-white border-l-4 border-black flex flex-col shrink-0 z-20 absolute right-0 top-0 bottom-0 shadow-[-4px_0_0_0_rgba(0,0,0,0.1)] md:relative"
        style="display: none;"> <!-- Helper for initial state if Alpine slow -->

        <div class="h-12 border-b-4 border-black flex items-center justify-between px-4 bg-yellow-300">
            <span class="font-black uppercase tracking-widest text-xs">Context</span>
            {{ button(None, variant='ghost', icon='ph-bold ph-x', class='hover:text-red-500 border-none shadow-none',
            attrs='@click="contextOpen = false"') }}
        </div>

        <div class="p-4" id="context-content">
            <!-- Placeholder Content until JS logic ported -->
            <div class="nb-card p-4 text-center">
                <div
                    class="w-20 h-20 bg-black mx-auto mb-2 border-4 border-black shadow-hard-sm text-white flex items-center justify-center font-bold text-2xl">
                    ?</div>
                <p class="font-black uppercase">Select User</p>
                <p class="text-xs font-mono mt-1 text-gray-500">Click avatar in chat</p>
            </div>
        </div>
    </div>
</div>

<!-- Template for Socket Glue -->
<template id="message-template">
    <!-- Neubrutalist Message Bubble -->
    <article class="message flex w-full items-end gap-3 mb-2 group animate-fade-in" data-id="">
        <!-- Avatar -->
        <div
            class="message-avatar w-10 h-10 border-4 border-black bg-gray-200 shrink-0 shadow-hard-sm text-xs font-bold flex items-center justify-center cursor-pointer hover:bg-hot-pink transition-colors">
        </div>

        <div class="flex flex-col max-w-[80%] meta-info">
            <!-- Meta -->
            <div
                class="flex items-baseline gap-2 mb-1 opacity-0 group-hover:opacity-100 transition duration-300 select-none px-1">
                <span class="message-user font-black text-[10px] uppercase tracking-wide"></span>
                <span class="message-time text-[10px] text-gray-500 font-mono border border-black px-1 bg-white"></span>
            </div>

            <!-- Bubble -->
            <div class="nb-bubble p-3 border-4 border-black shadow-hard text-sm font-medium relative bg-white">
                <div class="message-content leading-relaxed"></div>
            </div>
        </div>
    </article>
</template>

<!-- Confirm Modal -->
<div class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm" id="confirm-modal">
    <div class="bg-white border-4 border-black p-6 w-80 shadow-hard-xl">
        <h2 class="text-xl font-black uppercase mb-2">Delete?</h2>
        <p class="font-mono text-sm mb-6">This action cannot be undone.</p>
        <div class="flex gap-3 justify-end">
            {{ button('Cancel', variant='secondary', id='modal-cancel', class='px-4 py-2 border-transparent
            hover:border-black') }}
            {{ button('Delete', variant='destructive', id='modal-confirm', class='px-6 py-2 bg-red-500 text-white
            hover:bg-red-600') }}
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}

<!-- <script src="/ui/js/socket_glue.js?v=5"></script> -->
<script src="/ui/js/voice.js"></script>
<script type="module" src="/ui/js/chat/ChatMain.js"></script>
<script>
    // Init Logic to handle Rooms via Query Params
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const room = urlParams.get('room') || 'general';

        // Update header
        const headerName = document.getElementById('current-room-name');
        if (headerName) headerName.textContent = '# ' + room;

        // Update Sidebar Active State (Visual)
        document.querySelectorAll('a[href*="room=' + room + '"]').forEach(el => {
            el.classList.add('bg-black', 'text-white', 'shadow-hard-sm');
            el.classList.remove('text-black', 'border-transparent');
            el.querySelector('i')?.classList.remove('text-gray-400');
            el.querySelector('i')?.classList.add('text-white');
        });

        // Initial Auth Check (Glue handles this too but good to be safe)
        fetch('/auth/me').then(r => r.json()).then(d => {
            if (!d.logged_in) window.location = '/auth/login';
        });

        // Port Context Logic (Simplified)
        document.getElementById('messages')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('message-avatar')) {
                // Open context pane (stub)
                const container = document.querySelector('[x-data]');
                if (container && container._x_dataStack) {
                    container._x_dataStack[0].contextOpen = true;
                }
            }
        });
    });
</script>
{% endblock %}