{% extends "base.html" %}

{% block title %}Comms - NeoSpace{% endblock %}
{% block page_title %}Comms Grid{% endblock %}

{% block head %}
<style>
    /* Chat Specific Overrides */
    .message-content img { max-width: 100%; border: 2px solid #000; box-shadow: 4px 4px 0px #000; }
    .message.own .nb-bubble { background-color: #a3e635; color: black; border-color: black; } /* Acid Green */
    .message:not(.own) .nb-bubble { background-color: white; color: black; }

    /* Project Concrete: Polish */
    @keyframes message-pop {
        0% { opacity: 0; transform: translateY(10px) scale(0.95); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .animate-fade-in { animation: message-pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    
    /* Organic Margins */
    .margin-1 { margin-left: 0px; }
    .margin-2 { margin-left: 4px; }
    .margin-3 { margin-left: 8px; }
    .margin-4 { margin-left: 12px; }
    
    /* Scribble Rotations */
    .scribble-1 { transform: rotate(-0.5deg); }
    .scribble-2 { transform: rotate(0.5deg); }
    .scribble-3 { transform: rotate(-1deg); }
    .scribble-4 { transform: rotate(1deg); }

    /* Avatar Glitch */
    .message-avatar:hover {
        animation: glitch-skew 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite;
        background-color: #FF00FF !important; /* Hot Pink */
        color: white;
    }
    @keyframes glitch-skew {
        0% { transform: skew(0deg); }
        20% { transform: skew(-10deg); }
        40% { transform: skew(10deg); }
        60% { transform: skew(-5deg); }
        80% { transform: skew(5deg); }
        100% { transform: skew(0deg); }
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        opacity: 0.5;
    }
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        filter: drop-shadow(4px 4px 0px #000);
    }
    .empty-state-text {
        font-family: monospace;
        font-weight: bold;
        text-transform: uppercase;
        background: black;
        color: white;
        padding: 0.5rem 1rem;
        transform: rotate(-2deg);
    }
</style>
    <!-- 3RD PARTY LIBS (Vendored) -->
    <script src="/static/vendor/alpine.min.js" defer></script>
    <script src="/static/vendor/htmx.min.js"></script>
    <script src="/static/vendor/tailwindcss.js"></script>

    <!-- UI Libs -->
    <link rel="stylesheet" href="/static/vendor/phosphor/phosphor-regular.css">
    <link rel="stylesheet" href="/static/vendor/phosphor/phosphor-bold.css">
    <link rel="stylesheet" href="/static/vendor/phosphor/phosphor-fill.css">
    
    <!-- Emoji Picker (CDN fallback due to complex ESM) -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
{% endblock %}

{% block main_container %}
<div class="flex h-full overflow-hidden relative" x-data="{ contextOpen: false }">
    
    <!-- Chat Stream Area -->
    <div class="flex-1 flex flex-col h-full min-w-0 bg-bbs-bg relative">
        
        <!-- Room Header (Sticky) -->
        <div class="h-12 border-b-2 border-black bg-white flex items-center justify-between px-4 shrink-0 z-10">
            <div class="flex items-center gap-3">
                <div id="status-dot" class="w-3 h-3 bg-acid-green border-2 border-black rounded-none shadow-[2px_2px_0_0_#000]"></div>
                <h2 id="current-room-name" class="font-black uppercase tracking-widest text-lg"># ...</h2>
            </div>
            <div class="flex items-center gap-2">
                 <!-- Typing Indicator -->
                 <div id="typing-indicator" class="hidden text-xs font-mono font-bold text-gray-500 mr-2 flex items-center gap-1">
                    <span class="animate-pulse">Typing...</span>
                 </div>
                 <button @click="contextOpen = !contextOpen" class="w-8 h-8 flex items-center justify-center border-2 border-black bg-white hover:bg-yellow-300 transition-colors shadow-hard-sm">
                    <i class="ph-bold ph-sidebar-simple"></i>
                </button>
            </div>
        </div>

        <!-- Messages Scroll -->
        <div id="messages-scroll" class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-4">
             <div id="messages" class="flex flex-col gap-4 pb-4">
                 <!-- Socket Glue Injects Here -->
             </div>
        </div>

        <!-- Input Area (Sticky Bottom) -->
        <div class="p-4 bg-white border-t-2 border-black shrink-0 relative z-20">
            <form id="message-form" class="flex gap-2 relative">
                
                <!-- Tools -->
                <button type="button" id="emoji-btn" class="w-10 h-10 border-2 border-black bg-gray-100 hover:bg-yellow-300 flex items-center justify-center transition-colors shadow-hard-sm">
                    <i class="ph-bold ph-smiley text-xl"></i>
                </button>
                <button type="button" id="upload-btn" class="w-10 h-10 border-2 border-black bg-gray-100 hover:bg-electric-blue flex items-center justify-center transition-colors shadow-hard-sm">
                    <i class="ph-bold ph-image text-xl"></i>
                </button>

                <!-- Input -->
                <div class="flex-1 relative">
                    <input id="input" type="text" class="nb-input h-10 font-bold" placeholder="Broadcast message..." autocomplete="off">
                </div>

                <!-- Send -->
                <button id="send-btn" type="submit" class="h-10 px-6 border-2 border-black bg-black text-white font-black uppercase hover:bg-hot-pink hover:text-black transition-colors shadow-hard active:translate-x-[2px] active:translate-y-[2px] active:shadow-none">
                    SEND
                </button>

                <!-- Hidden Inputs -->
                <input type="file" id="file-input" class="hidden" accept="image/*" />
            </form>
            
             <!-- Emoji Picker Overlay -->
             <div id="emoji-picker-container" class="hidden absolute bottom-full left-0 mb-2 z-50 border-2 border-black shadow-hard-xl bg-white">
                <emoji-picker></emoji-picker>
             </div>
        </div>
    </div>

    <!-- Context Pane (Right Sidebar) -->
    <div x-show="contextOpen" 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="translate-x-full"
         class="w-72 bg-white border-l-2 border-black flex flex-col shrink-0 z-20 absolute right-0 top-0 bottom-0 shadow-[-4px_0_0_0_rgba(0,0,0,0.1)] md:relative"
         style="display: none;"> <!-- Helper for initial state if Alpine slow -->
         
         <div class="h-12 border-b-2 border-black flex items-center justify-between px-4 bg-yellow-300">
            <span class="font-black uppercase tracking-widest text-xs">Context</span>
            <button @click="contextOpen = false" class="hover:text-red-500"><i class="ph-bold ph-x"></i></button>
         </div>

         <div class="p-4" id="context-content">
             <!-- Placeholder Content until JS logic ported -->
             <div class="nb-card p-4 text-center">
                 <div class="w-20 h-20 bg-black mx-auto mb-2 border-2 border-black shadow-hard-sm text-white flex items-center justify-center font-bold text-2xl">?</div>
                 <p class="font-black uppercase">Select User</p>
                 <p class="text-xs font-mono mt-1 text-gray-500">Click avatar in chat</p>
             </div>
         </div>
    </div>
</div>

<!-- Template for Socket Glue -->
<template id="message-template">
  <!-- Neubrutalist Message Bubble -->
  <article class="message flex w-full items-end gap-3 mb-2 group animate-fade-in" data-id="">
    <!-- Avatar -->
    <div class="message-avatar w-10 h-10 border-2 border-black bg-gray-200 shrink-0 shadow-hard-sm text-xs font-bold flex items-center justify-center cursor-pointer hover:bg-hot-pink transition-colors"></div>
    
    <div class="flex flex-col max-w-[80%] meta-info">
         <!-- Meta -->
         <div class="flex items-baseline gap-2 mb-1 opacity-0 group-hover:opacity-100 transition duration-300 select-none px-1">
            <span class="message-user font-black text-[10px] uppercase tracking-wide"></span>
            <span class="message-time text-[10px] text-gray-500 font-mono border border-black px-1 bg-white"></span>
         </div>
         
         <!-- Bubble -->
         <div class="nb-bubble p-3 border-2 border-black shadow-hard text-sm font-medium relative bg-white">
            <div class="message-content leading-relaxed"></div>
         </div>
    </div>
  </article>
</template>

<!-- Confirm Modal -->
<div class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm" id="confirm-modal">
    <div class="bg-white border-2 border-black p-6 w-80 shadow-hard-xl">
        <h2 class="text-xl font-black uppercase mb-2">Delete?</h2>
        <p class="font-mono text-sm mb-6">This action cannot be undone.</p>
        <div class="flex gap-3 justify-end">
            <button id="modal-cancel" class="px-4 py-2 text-black font-bold border-2 border-transparent hover:border-black uppercase text-sm">Cancel</button>
            <button id="modal-confirm" class="px-6 py-2 bg-red-500 border-2 border-black text-white font-black uppercase shadow-hard hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-none transition-all">Delete</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}

<!-- <script src="/ui/js/socket_glue.js?v=5"></script> -->
<script type="module" src="/ui/js/chat/ChatMain.js"></script>
<script>
    // Init Logic to handle Rooms via Query Params
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const room = urlParams.get('room') || 'general';
        
        // Update header
        const headerName = document.getElementById('current-room-name');
        if(headerName) headerName.textContent = '# ' + room;
        
        // Update Sidebar Active State (Visual)
        document.querySelectorAll('a[href*="room=' + room + '"]').forEach(el => {
            el.classList.add('bg-black', 'text-white', 'shadow-hard-sm');
            el.classList.remove('text-black', 'border-transparent');
            el.querySelector('i')?.classList.remove('text-gray-400');
            el.querySelector('i')?.classList.add('text-white');
        });

        // Initial Auth Check (Glue handles this too but good to be safe)
        fetch('/auth/me').then(r=>r.json()).then(d => {
            if(!d.logged_in) window.location = '/auth/login';
        });
        
        // Port Context Logic (Simplified)
        document.getElementById('messages')?.addEventListener('click', (e) => {
             if (e.target.classList.contains('message-avatar')) {
                 // Open context pane (stub)
                 const container = document.querySelector('[x-data]');
                 if(container && container._x_dataStack) {
                     container._x_dataStack[0].contextOpen = true;
                 }
             }
        });
    });
</script>
{% endblock %}
