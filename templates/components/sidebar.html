{% macro sidebar_nav(current_user=None, version='0.1.0') %}
<!-- Sidebar ("Index Card Stack") -->
<aside
    class="w-64 bg-white border-r-2 border-black flex flex-col z-40 h-full shadow-[4px_0_0_0_#000] transition-transform duration-300 absolute md:relative"
    :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'">

    <!-- Logo Section -->
    <div class="h-16 flex items-center justify-center shrink-0 border-b-2 border-black bg-white">
        <div class="flex items-center gap-3">
            <div
                class="w-8 h-8 bg-black text-white flex items-center justify-center font-bold border-4 border-transparent">
                N
            </div>
            <span class="text-xl font-black tracking-tighter uppercase italic transform -skew-x-6">NeoSpace</span>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="flex-1 overflow-y-auto py-4 px-4 space-y-2 font-mono">
        <!-- Helper Macro -->
        {% macro nav_link(href, icon, label, badge=None, class='', boost=True) %}
        <a href="{{ href }}" {% if not boost %}hx-boost="false" {% endif %}
            class="{{ class }} group flex items-center gap-3 px-3 py-2 border-4 border-transparent hover:border-black hover:bg-acid-green hover:shadow-hard-sm hover:-translate-y-1 hover:-translate-x-1 active:translate-y-0 active:translate-x-0 active:shadow-none transition-all duration-100 text-black font-bold text-sm uppercase">
            <i class="{{ icon }} text-lg"></i>
            <span>{{ label }}</span>
            {% if badge %}
            <span class="ml-auto w-2 h-2 bg-red-500 rounded-full border border-black"></span>
            {% endif %}
        </a>
        {% endmacro %}

        {{ nav_link('/wall', 'ph-bold ph-user-square', 'Identity', class='sidebar-link') }}
        {{ nav_link('/feed/home', 'ph-bold ph-waves', 'Feed', class='sidebar-link') }}
        {{ nav_link('/directory', 'ph-bold ph-users', 'Network', class='sidebar-link') }}
        {{ nav_link('/codeground', 'ph-bold ph-code', 'Codeground', class='sidebar-link') }}

        <!-- Review Category -->
        <div class="px-4 py-2 mt-4 mb-1 flex items-center justify-between">
            <span class="text-[10px] font-black uppercase tracking-widest text-gray-500">Review</span>
        </div>
        {{ nav_link('/components', 'ph-bold ph-paint-brush', 'Components', class='sidebar-link', boost=False) }}
        {{ nav_link('/penguin', 'ph-bold ph-bird', 'Penguin UI', class='sidebar-link') }}

        <!-- Room Category -->
        <div class="px-4 py-2 mt-4 mb-1 flex items-center justify-between">
            <span class="text-[10px] font-black uppercase tracking-widest text-gray-500">Room</span>
        </div>

        <!-- Regular Chat (Channels) -->
        <div x-data="{ 
            rooms: [],
            currentRoom: new URLSearchParams(window.location.search).get('room') || 'general',
            init() {
                fetch('/rooms').then(r => r.json()).then(data => {
                    if(data.rooms) this.rooms = data.rooms;
                });
            }
        }" class="mb-2">
            <template x-for="room in rooms" :key="room.id">
                <a :href="'/app?room=' + room.name"
                    class="sidebar-link group flex items-center gap-2 px-4 py-1.5 border-l-4 transition-all font-mono font-bold text-sm active:bg-black/10"
                    :class="currentRoom === room.name 
                       ? 'border-black bg-black text-white' 
                       : 'border-transparent hover:border-black hover:bg-black/5 text-black'">
                    <i class="ph-bold ph-hash"
                        :class="currentRoom === room.name ? 'text-white' : 'text-gray-400 group-hover:text-black'"></i>
                    <span x-text="room.name"></span>
                </a>
            </template>
        </div>

        <!-- Features Category -->
        <div class="px-4 py-2 mt-4 mb-1 flex items-center justify-between">
            <span class="text-[10px] font-black uppercase tracking-widest text-gray-500">Features</span>
        </div>
        {% if False %}{{ nav_link('/feed/home', 'ph-bold ph-waves', 'Stream Listening', class='sidebar-link') }}{% endif
        %}
        {{ nav_link('/lobby', 'ph-bold ph-users-three', 'Visual Lobby', class='sidebar-link') }}
        {{ nav_link('/messages', 'ph-bold ph-chat-centered-text', 'Communications', class='sidebar-link') }}
        {{ nav_link('/notifications/center', 'ph-bold ph-bell-ringing', 'Live Wire', class='sidebar-link') }}

        <!-- Studio Category -->
        <div class="px-4 py-2 mt-4 mb-1 flex items-center justify-between">
            <span class="text-[10px] font-black uppercase tracking-widest text-gray-500">Studio</span>
        </div>
        {{ nav_link('/song', 'ph-bold ph-music-notes-simple', 'The Song', class='sidebar-link', boost=False) }}
        {{ nav_link('/catsound_player', 'ph-bold ph-cat', 'Cat Orchestra', class='sidebar-link') }}
        {{ nav_link('#', 'ph-bold ph-microphone-stage', 'Voice Notes', class='sidebar-link opacity-50
        cursor-not-allowed', badge=False) }}

        <div class="h-0.5 bg-black my-4 opacity-10 mx-4"></div>

        <!-- System / Admin -->
        {{ nav_link('/internals', 'ph-bold ph-cpu', 'System', badge=True, class='sidebar-link', boost=False) }}
        {{ nav_link('/dashboard', 'ph-bold ph-shield', 'Admin', class='sidebar-link') }}
    </nav>

    <!-- Sidebar Footer (Music Player & Profile) -->
    <div class="p-4 border-t-2 border-black flex flex-col gap-4 bg-white">

        <!-- Music Player (Tape Deck Style) -->
        <div class="nb-card p-2 flex items-center gap-3 bg-red-50" x-data="{ 
            playing: false, 
            audio: new Audio('/static/audio/ui_click.wav'),
            init() { this.audio.loop = true; this.audio.volume = 0.5; },
            toggle() { this.playing = !this.playing; this.playing ? this.audio.play() : this.audio.pause(); }
        }">
            <button @click="toggle()"
                class="w-8 h-8 border-4 border-black flex items-center justify-center transition-colors active:scale-95 transform"
                :class="playing ? 'bg-acid-green' : 'bg-white hover:bg-gray-100'">
                <i class="ph-bold text-lg" :class="playing ? 'ph-pause' : 'ph-play'"></i>
            </button>
            <div class="flex-1 min-w-0">
                <span class="text-[10px] font-bold uppercase tracking-widest block mb-1">Frequency</span>
                <div class="flex gap-0.5 items-end h-3">
                    <div class="w-1 bg-black"
                        :style="{ height: playing ? '100%' : '30%', animation: 'equalize 0.8s infinite', animationPlayState: playing ? 'running' : 'paused' }">
                    </div>
                    <div class="w-1 bg-black"
                        :style="{ height: playing ? '100%' : '50%', animation: 'equalize 1.1s infinite', animationPlayState: playing ? 'running' : 'paused', animationDelay: '0.1s' }">
                    </div>
                    <div class="w-1 bg-black"
                        :style="{ height: playing ? '100%' : '40%', animation: 'equalize 0.9s infinite', animationPlayState: playing ? 'running' : 'paused', animationDelay: '0.2s' }">
                    </div>
                    <div class="w-1 bg-black"
                        :style="{ height: playing ? '100%' : '20%', animation: 'equalize 1.2s infinite', animationPlayState: playing ? 'running' : 'paused', animationDelay: '0.3s' }">
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile -->
        <div class="flex items-center gap-3 p-2 border-4 border-transparent hover:border-black transition-colors cursor-pointer active:bg-gray-100"
            x-data="{ 
                 user: { username: 'Loading...', id: '---' }, 
                 avatar: null,
                 init() {
                     fetch('/auth/me').then(r => r.json()).then(d => {
                         if(d.logged_in) {
                             this.user = d;
                             // Fetch avatar
                             fetch('/profile?user_id=' + d.id).then(r => r.json()).then(p => {
                                 if(p.avatar_path) this.avatar = p.avatar_path;
                             });
                         }
                     });
                 }
             }">
            <div class="w-8 h-8 bg-black text-white flex items-center justify-center font-bold text-xs border-4 border-black shadow-hard-sm bg-cover bg-center"
                :style="avatar ? 'background-image: url(' + avatar + '); color: transparent;' : ''">
                <span x-text="user.username ? user.username.charAt(0).toUpperCase() : 'U'"></span>
            </div>
            <div class="overflow-hidden">
                <p class="text-xs font-bold text-black uppercase truncate" x-text="user.username"></p>
                <p class="text-[10px] text-gray-500 font-mono truncate">ID: <span x-text="user.id"></span></p>
            </div>
        </div>
    </div>
</aside>
{% endmacro %}