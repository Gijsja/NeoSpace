<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Code Playground - LocalBBS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'bbs-bg': '#0a0f1a',
              'bbs-surface': 'rgba(30, 41, 59, 0.8)',
              'bbs-border': 'rgba(71, 85, 105, 0.5)',
              'bbs-accent': '#60a5fa',
            },
            fontFamily: { 
              sans: ['Inter', 'system-ui', 'sans-serif'],
              mono: ['JetBrains Mono', 'Fira Code', 'monospace']
            },
          }
        }
      }
    </script>
    <style>
        .code-editor {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            tab-size: 2;
        }
    </style>
</head>
<body class="bg-bbs-bg text-slate-200 min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950">

    <!-- Navigation -->
    <nav class="bg-bbs-surface backdrop-blur-xl border-b border-bbs-border px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="/ui/views/app.html" class="text-slate-400 hover:text-white transition">
                <i class="ph-bold ph-arrow-left text-xl"></i>
            </a>
            <h1 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400 flex items-center gap-2">
                <i class="ph-bold ph-code text-emerald-400"></i> Code Playground
            </h1>
        </div>
        <div class="flex items-center gap-3">
            <select id="framework-select" class="bg-slate-800/50 border border-bbs-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-bbs-accent">
                <option value="p5">p5.js (2D Art)</option>
                <option value="three">Three.js (3D)</option>
                <option value="tone">Tone.js (Audio)</option>
                <option value="vanilla">Vanilla JS</option>
            </select>
            <button id="run-btn" class="px-5 py-2 bg-gradient-to-r from-emerald-500 to-cyan-500 hover:from-emerald-600 hover:to-cyan-600 rounded-lg text-white font-semibold transition-all shadow-lg active:scale-95 flex items-center gap-2">
                <i class="ph-bold ph-play"></i> Run
            </button>
            <button id="stop-btn" class="px-4 py-2 bg-red-600/20 hover:bg-red-600/30 border border-red-500/50 rounded-lg text-red-400 font-medium transition flex items-center gap-2">
                <i class="ph-bold ph-stop"></i> Stop
            </button>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex h-[calc(100vh-68px)]">
        
        <!-- Editor Panel -->
        <div class="w-1/2 border-r border-bbs-border flex flex-col">
            <div class="px-4 py-2 bg-slate-800/30 border-b border-bbs-border flex items-center justify-between">
                <span class="text-xs text-slate-500 uppercase tracking-wide flex items-center gap-1">
                    <i class="ph-bold ph-file-js"></i> sketch.js
                </span>
                <span class="text-xs text-slate-500" id="char-count">0 chars</span>
            </div>
            <textarea id="code-editor" class="code-editor flex-1 bg-transparent p-4 resize-none focus:outline-none text-slate-300 placeholder-slate-600" spellcheck="false" placeholder="// Write your code here..."></textarea>
        </div>

        <!-- Preview Panel -->
        <div class="w-1/2 flex flex-col bg-black relative">
            <div class="px-4 py-2 bg-slate-800/30 border-b border-bbs-border flex items-center justify-between">
                <span class="text-xs text-slate-500 uppercase tracking-wide flex items-center gap-1">
                    <i class="ph-bold ph-eye"></i> Preview
                </span>
                <span class="text-xs px-2 py-0.5 rounded bg-emerald-500/20 text-emerald-400 font-medium flex items-center gap-1">
                    <i class="ph-bold ph-shield-check"></i> Sandboxed
                </span>
            </div>
            <div class="flex-1 relative overflow-hidden" id="preview-container">
                <iframe id="sandbox-frame" class="w-full h-full border-0" sandbox="allow-scripts"></iframe>
                <div id="preview-overlay" class="absolute inset-0 flex items-center justify-center bg-black/50 text-slate-400">
                    <div class="text-center">
                        <i class="ph-duotone ph-play-circle text-6xl mb-2 opacity-50"></i>
                        <p>Click <strong>Run</strong> to execute</p>
                    </div>
                </div>
            </div>
            <div id="console-output" class="h-32 bg-slate-900 border-t border-bbs-border overflow-y-auto p-3 font-mono text-xs text-slate-400"></div>
        </div>
    </div>

    <script>
        const editor = document.getElementById('code-editor');
        const sandboxFrame = document.getElementById('sandbox-frame');
        const runBtn = document.getElementById('run-btn');
        const stopBtn = document.getElementById('stop-btn');
        const frameworkSelect = document.getElementById('framework-select');
        const previewOverlay = document.getElementById('preview-overlay');
        const consoleOutput = document.getElementById('console-output');
        const charCount = document.getElementById('char-count');

        // Framework CDN URLs
        const frameworkCDN = {
            'p5': 'https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js',
            'three': 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js',
            'tone': 'https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js',
            'vanilla': null
        };

        // Starter templates
        const templates = {
            'p5': `function setup() {
  createCanvas(400, 400);
  background(20);
}

function draw() {
  // Glowing circles
  noStroke();
  fill(100, 150, 255, 50);
  circle(mouseX, mouseY, 50);
}`,
            'three': `const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, 400/400, 0.1, 1000);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(400, 400);
document.body.appendChild(renderer.domElement);

const geometry = new THREE.BoxGeometry();
const material = new THREE.MeshBasicMaterial({ color: 0x60a5fa, wireframe: true });
const cube = new THREE.Mesh(geometry, material);
scene.add(cube);
camera.position.z = 3;

function animate() {
  requestAnimationFrame(animate);
  cube.rotation.x += 0.01;
  cube.rotation.y += 0.01;
  renderer.render(scene, camera);
}
animate();`,
            'tone': `const synth = new Tone.Synth().toDestination();

// Play a note on click
document.body.onclick = () => {
  synth.triggerAttackRelease("C4", "8n");
};

document.body.innerHTML = '<div style="color:white;padding:50px;text-align:center;font-family:sans-serif;"><h1>ðŸŽµ Click anywhere to play</h1></div>';`,
            'vanilla': `// Vanilla JavaScript
const canvas = document.createElement('canvas');
canvas.width = 400;
canvas.height = 400;
document.body.appendChild(canvas);
const ctx = canvas.getContext('2d');

ctx.fillStyle = '#0a0f1a';
ctx.fillRect(0, 0, 400, 400);

ctx.font = '24px sans-serif';
ctx.fillStyle = '#60a5fa';
ctx.textAlign = 'center';
ctx.fillText('Hello, LocalBBS!', 200, 200);`
        };

        // Load template on framework change
        frameworkSelect.onchange = () => {
            editor.value = templates[frameworkSelect.value] || '';
            updateCharCount();
        };

        // Initial template
        editor.value = templates['p5'];
        updateCharCount();

        function updateCharCount() {
            charCount.textContent = `${editor.value.length} chars`;
        }
        editor.oninput = updateCharCount;

        function log(msg, type = 'log') {
            const colors = { log: 'text-slate-400', error: 'text-red-400', warn: 'text-yellow-400' };
            consoleOutput.innerHTML += `<div class="${colors[type] || 'text-slate-400'}">${msg}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function runCode() {
            const framework = frameworkSelect.value;
            const userCode = editor.value;
            const cdnUrl = frameworkCDN[framework];

            // Clear previous
            consoleOutput.innerHTML = '';
            previewOverlay.classList.add('hidden');
            log(`[${new Date().toLocaleTimeString()}] Running ${framework}...`);

            // Build sandboxed HTML
            const html = `
<!DOCTYPE html>
<html>
<head>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #0a0f1a; }
        canvas { display: block; }
    </style>
    ${cdnUrl ? `<script src="${cdnUrl}"><\/script>` : ''}
</head>
<body>
    <script>
        // Capture console for parent
        const _log = console.log;
        const _err = console.error;
        const _warn = console.warn;
        console.log = (...args) => { parent.postMessage({type:'log', msg: args.join(' ')}, '*'); _log.apply(console, args); };
        console.error = (...args) => { parent.postMessage({type:'error', msg: args.join(' ')}, '*'); _err.apply(console, args); };
        console.warn = (...args) => { parent.postMessage({type:'warn', msg: args.join(' ')}, '*'); _warn.apply(console, args); };
        window.onerror = (msg, src, line) => { parent.postMessage({type:'error', msg: \`\${msg} (line \${line})\`}, '*'); };

        // Kill switch: stop after 30 seconds
        setTimeout(() => {
            parent.postMessage({type:'warn', msg: '[Timeout] Execution stopped after 30s'}, '*');
            window.stop?.();
        }, 30000);

        try {
            ${userCode}
        } catch (e) {
            console.error(e.message);
        }
    <\/script>
</body>
</html>`;

            sandboxFrame.srcdoc = html;
        }

        function stopCode() {
            sandboxFrame.srcdoc = '';
            previewOverlay.classList.remove('hidden');
            log('[Stopped]', 'warn');
        }

        // Listen for console messages from sandbox
        window.addEventListener('message', (e) => {
            if (e.data && e.data.type) {
                log(e.data.msg, e.data.type);
            }
        });

        runBtn.onclick = runCode;
        stopBtn.onclick = stopCode;

        // Keyboard shortcut: Ctrl+Enter to run
        editor.onkeydown = (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                runCode();
            }
        };
    </script>
</body>
</html>
