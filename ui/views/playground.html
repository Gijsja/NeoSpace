<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>The Sandbox - NeoSpace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/ui/css/styles.css">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'bbs-bg': '#0f172a',
              'bbs-surface': '#1e293b',
              'bbs-border': '#334155',
              'bbs-accent': '#3b82f6',
            },
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            }
          }
        }
      }
    </script>
    <style>
      .cm-editor { height: 100%; font-family: 'JetBrains Mono', monospace; font-size: 14px; }
      .cm-scroller { overflow: auto; }
    </style>
  </head>
  <body class="bg-bbs-bg text-slate-200 h-screen flex flex-col overflow-hidden">
    <!-- Header -->
    <nav class="h-14 border-b border-bbs-border bg-bbs-surface flex items-center justify-between px-4 shrink-0">
      <div class="flex items-center gap-4">
        <a href="/ui/views/app.html" class="flex items-center gap-2 text-slate-400 hover:text-white transition">
           <i class="ph-bold ph-arrow-left"></i> Back
        </a>
        <div class="h-6 w-px bg-bbs-border"></div>
        <div class="flex items-center gap-2">
            <i class="ph-duotone ph-cube text-bbs-accent text-xl"></i>
            <h1 class="font-bold text-lg tracking-tight">The Sandbox</h1>
        </div>
        <div id="script-title" class="text-sm px-3 py-1 rounded bg-black/20 text-slate-300 border border-transparent hover:border-bbs-border focus:outline-none transition" contenteditable="true" spellcheck="false">
            Untitled Sketch
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        <span id="save-status" class="text-xs text-slate-500 italic transition-opacity opacity-0">Saved</span>
        <button id="btn-load" class="flex items-center gap-2 px-3 py-1.5 bg-bbs-surface border border-bbs-border hover:bg-slate-700 rounded text-sm transition font-medium">
             <i class="ph-bold ph-folder-open"></i> Open
        </button>
        <button id="btn-save" class="flex items-center gap-2 px-3 py-1.5 bg-bbs-surface border border-bbs-border hover:bg-slate-700 rounded text-sm transition font-medium">
             <i class="ph-bold ph-floppy-disk"></i> Save
        </button>
        <button id="btn-share" class="flex items-center gap-2 px-3 py-1.5 bg-bbs-surface border border-bbs-border hover:bg-slate-700 rounded text-sm transition font-medium text-blue-400 border-blue-500/30">
             <i class="ph-bold ph-export"></i> Share
        </button>
        <button id="btn-run" class="flex items-center gap-2 px-4 py-1.5 bg-bbs-accent text-white hover:bg-blue-600 rounded text-sm transition font-bold shadow-glow">
             <i class="ph-bold ph-play"></i> Run
        </button>
      </div>
    </nav>
    
    <!-- Load Modal -->
    <div id="load-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200">
        <div class="bg-bbs-surface border border-bbs-border rounded-xl shadow-2xl w-[500px] max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-bbs-border flex justify-between items-center">
                <h3 class="font-bold text-lg">My Scripts</h3>
                <button id="close-modal" class="text-slate-400 hover:text-white"><i class="ph-bold ph-x"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-1" id="script-list">
                <!-- Scripts injected here -->
                <div class="p-4 text-center text-slate-500" id="loading-scripts">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Main Workspace -->
    <main class="flex-1 flex overflow-hidden">
        <!-- Editor Params -->
        <div class="w-1/2 flex flex-col border-r border-bbs-border relative group">
            <div id="editor-container" class="flex-1 bg-[#0d1117] overflow-hidden"></div>
            <!-- Settings Overlay -->
            <div class="absolute bottom-4 right-4 z-10">
                 <select id="mode-select" class="bg-bbs-surface border border-bbs-border rounded px-2 py-1 text-xs text-slate-300">
                    <option value="p5">p5.js (Global)</option>
                    <option value="three">Three.js (Module)</option>
                    <option value="vanilla">Vanilla JS</option>
                 </select>
            </div>
        </div>
        
        <!-- Preview -->
        <div class="w-1/2 flex flex-col bg-black relative">
            <iframe id="runner-frame" class="flex-1 w-full h-full border-none bg-white" sandbox="allow-scripts allow-pointer-lock allow-same-origin"></iframe>
        </div>
    </main>

    <!-- CodeMirror + Logic -->
    <script type="module">
        import {EditorView, basicSetup} from "https://esm.sh/codemirror@6.0.1"
        import {javascript} from "https://esm.sh/@codemirror/lang-javascript@6.0.1"
        import {oneDark} from "https://esm.sh/@codemirror/theme-one-dark@6.0.1"
        import {keymap} from "https://esm.sh/@codemirror/view@6.0.1"
        import {indentWithTab} from "https://esm.sh/@codemirror/commands@6.0.1"

        // --- Editor Setup ---
        const parent = document.getElementById('editor-container');
        
        // Initial Template
        const TEMPLATES = {
            p5: `function setup() {
  createCanvas(windowWidth, windowHeight);
  background(20);
}

function draw() {
  fill(0, 10);
  rect(0, 0, width, height);
  
  fill(0, 255, 136);
  noStroke();
  circle(mouseX, mouseY, 50);
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}`,
            three: `// Three.js Template
import * as THREE from 'https://esm.sh/three';

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const geometry = new THREE.BoxGeometry();
const material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
const cube = new THREE.Mesh(geometry, material);
scene.add(cube);

camera.position.z = 5;

function animate() {
	requestAnimationFrame(animate);
	cube.rotation.x += 0.01;
	cube.rotation.y += 0.01;
	renderer.render(scene, camera);
}
animate();`,
            vanilla: `document.body.style.background = '#111';
document.body.style.color = '#0f0';
document.body.style.fontFamily = 'monospace';
document.body.innerHTML = '<h1>Hello World</h1>';`
        };

        let currentScriptId = null;

        const view = new EditorView({
            doc: TEMPLATES.p5,
            extensions: [
                basicSetup,
                keymap.of([indentWithTab]),
                javascript(),
                oneDark,
                EditorView.updateListener.of((u) => {
                    if (u.docChanged) {
                        // Could auto-run or mark dirty
                        document.getElementById('save-status').style.opacity = '0';
                    }
                })
            ],
            parent: parent
        });

        // --- Runner Logic ---
        const btnRun = document.getElementById('btn-run');
        const frame = document.getElementById('runner-frame');
        const modeSelect = document.getElementById('mode-select');
        const btnSave = document.getElementById('btn-save');
        const btnShare = document.getElementById('btn-share');
        const titleEl = document.getElementById('script-title');
        const saveStatus = document.getElementById('save-status');

        function runCode() {
            const code = view.state.doc.toString();
            const mode = modeSelect.value;
            
            let html = '';
            
            if (mode === 'p5') {
                html = `
<!DOCTYPE html>
<html>
<head>
    <style>body { margin: 0; overflow: hidden; }</style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"><\/script>
</head>
<body>
    <script>
    try {
        ${code}
    } catch (e) {
        document.body.innerHTML = '<pre style="color:red; padding:10px">' + e.toString() + '</pre>';
    }
    <\/script>
</body>
</html>`;
            } else if (mode === 'three') {
                html = `
<!DOCTYPE html>
<html>
<head><style>body { margin: 0; overflow: hidden; }</style></head>
<body>
    <script type="module">
    try {
        ${code}
    } catch (e) {
        document.body.innerHTML = '<pre style="color:red; padding:10px">' + e.toString() + '</pre>';
    }
    <\/script>
</body>
</html>`;
            } else {
                 html = `<!DOCTYPE html><html><body><script>${code}<\/script></body></html>`;
            }
            
            frame.srcdoc = html;
        }

        btnRun.addEventListener('click', runCode);
        
        // Auto-run on load
        runCode();
        
        // --- Persistence Logic ---
        btnSave.addEventListener('click', async () => {
             const title = titleEl.innerText;
             const content = view.state.doc.toString();
             const type = modeSelect.value;
             
             btnSave.disabled = true;
             btnSave.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Saving...';
             
             try {
                 const res = await fetch('/scripts/save', {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({
                         id: currentScriptId,
                         title,
                         content,
                         script_type: type
                     })
                 });
                 const data = await res.json();
                 
                 if (data.ok) {
                     currentScriptId = data.id;
                     saveStatus.textContent = 'Saved';
                     saveStatus.style.opacity = '1';
                     
                     // Update URL to include ID if new
                     const url = new URL(window.location);
                     url.searchParams.set('id', data.id);
                     window.history.replaceState({}, '', url);
                 } else {
                     alert('Error saving: ' + data.error);
                 }
             } catch(e) {
                 alert('Network error');
             } finally {
                 btnSave.disabled = false;
                 btnSave.innerHTML = '<i class="ph-bold ph-floppy-disk"></i> Save';
             }
        });
        
        // --- Sharing Logic ---
        const socket = io();
        
        btnShare.addEventListener('click', async () => {
             if(!currentScriptId) {
                 alert("Please save your script before sharing!");
                 return;
             }
             
             if(confirm("Post this script to the chat?")) {
                 socket.emit('send_message', { 
                     content: `script:${currentScriptId}` 
                 });
                 alert("Posted to chat!");
             }
        });
        
        // Listen for mode change to swap templates (if empty or confirmed)
        modeSelect.addEventListener('change', () => {
             // For now just swap, in real app maybe warn user?
             const mode = modeSelect.value;
             const tpl = TEMPLATES[mode];
             
             const transaction = view.state.update({
                 changes: {from: 0, to: view.state.doc.length, insert: tpl}
             });
             view.dispatch(transaction);
             runCode();
        });
        
        // Load Script from URL
        const urlParams = new URLSearchParams(window.location.search);
        
        async function loadScript(id) {
             const r = await fetch('/scripts/get?id=' + id);
             const d = await r.json();
             if (d.ok) {
                const s = d.script;
                currentScriptId = s.id;
                titleEl.innerText = s.title;
                modeSelect.value = s.script_type || 'p5';
                
                const transaction = view.state.update({
                     changes: {from: 0, to: view.state.doc.length, insert: s.content}
                });
                view.dispatch(transaction);
                runCode();
                
                // Update URL without reload
                const url = new URL(window.location);
                url.searchParams.set('id', id);
                window.history.replaceState({}, '', url);
             }
        }

        const loadId = urlParams.get('id');
        if (loadId) loadScript(loadId);

        // --- Load Modal Logic ---
        const modal = document.getElementById('load-modal');
        const btnLoad = document.getElementById('btn-load');
        const btnCloseModal = document.getElementById('close-modal');
        const scriptList = document.getElementById('script-list');

        function toggleModal(show) {
            modal.style.opacity = show ? '1' : '0';
            modal.style.pointerEvents = show ? 'auto' : 'none';
            if (show) fetchScripts();
        }

        btnLoad.addEventListener('click', () => toggleModal(true));
        btnCloseModal.addEventListener('click', () => toggleModal(false));

        async function fetchScripts() {
            scriptList.innerHTML = '<div class="p-4 text-center text-slate-500"><i class="ph ph-spinner animate-spin text-xl"></i></div>';
            try {
                const res = await fetch('/scripts/list');
                const data = await res.json();
                
                if (data.scripts && data.scripts.length > 0) {
                    scriptList.innerHTML = '';
                    data.scripts.forEach(s => {
                        const el = document.createElement('div');
                        el.className = "flex items-center justify-between p-3 rounded hover:bg-slate-700/50 cursor-pointer group transition";
                        el.innerHTML = `
                            <div>
                                <div class="font-medium text-slate-200">${s.title}</div>
                                <div class="text-xs text-slate-500">${s.script_type} â€¢ ${new Date(s.last_modified).toLocaleDateString()}</div>
                            </div>
                            <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition">
                                <button class="p-1.5 hover:text-red-400 delete-script" data-id="${s.id}" title="Delete"><i class="ph-bold ph-trash"></i></button>
                            </div>
                        `;
                        // Click to load
                        el.addEventListener('click', (e) => {
                            if (!e.target.closest('.delete-script')) {
                                loadScript(s.id);
                                toggleModal(false);
                            }
                        });
                        // Delete
                        el.querySelector('.delete-script').addEventListener('click', async (e) => {
                            e.stopPropagation();
                            if(confirm('Delete script?')) {
                                await fetch('/scripts/delete', {
                                    method: 'POST', 
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({id: s.id})
                                });
                                fetchScripts(); // Reload list
                            }
                        });
                        scriptList.appendChild(el);
                    });
                } else {
                    scriptList.innerHTML = '<div class="p-8 text-center text-slate-500">No scripts found.<br>Save your first sketch!</div>';
                }
            } catch(e) {
                scriptList.innerHTML = '<div class="p-4 text-center text-red-400">Error loading scripts</div>';
            }
        }

    </script>
  </body>
</html>
