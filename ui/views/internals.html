<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>System Internals - NeoSpace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'bbs-bg': '#0f172a',
              'bbs-surface': '#1e293b',
              'bbs-border': '#475569',
              'bbs-accent': '#3b82f6',
              'term-green': '#00ff88',
              'term-amber': '#ffb700',
            },
            fontFamily: {
              mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
            }
          }
        }
      }
    </script>
    <style>
      /* CRT scanline effect */
      .scanlines::after {
        content: "";
        position: absolute;
        inset: 0;
        background: repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.1) 0px,
          rgba(0, 0, 0, 0.1) 1px,
          transparent 1px,
          transparent 2px
        );
        pointer-events: none;
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        const logContainer = document.getElementById('log-container');
        const driftEl = document.getElementById('drift-value');
        const syncDot = document.getElementById('sync-dot');
        const syncText = document.getElementById('sync-text');
        
        // --- LOG LOGIC ---
        function appendLog(direction, type, data) {
            const row = document.createElement('div');
            const ts = new Date().toISOString().split('T')[1].slice(0, -1); // HH:MM:SS.mmm
            
            let color = 'text-slate-400';
            if (direction === 'IN') color = 'text-cyan-400';
            if (direction === 'OUT') color = 'text-purple-400';
            
            // Format data object
            let dataStr = JSON.stringify(data);
            if (dataStr.length > 50) dataStr = dataStr.substring(0, 50) + '...';
            
            row.innerHTML = `
                <span class="text-term-green/50">[${ts}]</span> 
                <span class="${color}">${direction === 'IN' ? '‚ÜêIN' : '‚ÜíOUT'}</span> 
                <span class="text-slate-400">${type}</span> 
                <span class="text-term-green">${dataStr}</span>
            `;
            
            logContainer.appendChild(row);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Prune old logs
            if (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }
        
        // --- SOCKET HOOKS ---
        // Capture specific events we know about (since socket.io client doesn't expose a global 'all' easily without patching)
        const EVENTS = ['connect', 'disconnect', 'message', 'typing', 'stop_typing', 'backfill'];
        
        EVENTS.forEach(evt => {
            socket.on(evt, (data) => {
                appendLog('IN', evt, data || {});
            });
        });
        
        // Capture outgoing (monkey patch emit)
        const originalEmit = socket.emit;
        socket.emit = function(event, ...args) {
            if (event !== 'latency_check') { // ignore internal noise
                appendLog('OUT', event, args[0] || {});
            }
            return originalEmit.apply(this, arguments);
        };
        
        // --- CONNECTION STATUS ---
        socket.on('connect', () => {
             syncDot.className = "w-3 h-3 rounded-full bg-term-green animate-pulse";
             syncText.textContent = "SYNCED";
             syncText.className = "text-term-green font-bold";
        });
        
        socket.on('disconnect', () => {
             syncDot.className = "w-3 h-3 rounded-full bg-red-500 animate-pulse";
             syncText.textContent = "OFFLINE";
             syncText.className = "text-red-500 font-bold";
        });
        
        // --- DRIFT / LATENCY CHECK ---
        // Throttled to 5s to avoid self-DDoS (per Technical Director's screaming)
        setInterval(() => {
            if (socket.connected) {
                const start = Date.now();
                socket.volatile.emit('latency_check', {ts: start}, () => { 
                    const rtt = Date.now() - start;
                    driftEl.textContent = `${rtt}ms (OK)`;
                    if (rtt > 100) driftEl.className = "text-term-amber";
                    else driftEl.className = "text-term-green";
                });
            }
        }, 5000);
        
        // Manual triggers
        document.getElementById('btn-reconnect').addEventListener('click', () => {
            socket.disconnect();
            setTimeout(() => socket.connect(), 500);
        });
        
        // Copy Diagnostics
        document.getElementById('btn-copy').addEventListener('click', async () => {
            const diagnostics = {
                timestamp: new Date().toISOString(),
                connected: socket.connected,
                transport: socket.io?.engine?.transport?.name || 'unknown',
                logs: Array.from(logContainer.children).slice(-20).map(el => el.textContent),
                userAgent: navigator.userAgent
            };
            
            try {
                await navigator.clipboard.writeText(JSON.stringify(diagnostics, null, 2));
                const btn = document.getElementById('btn-copy');
                btn.textContent = '‚úì Copied!';
                setTimeout(() => btn.textContent = 'üìã Copy Diagnostics', 2000);
            } catch(e) {
                alert('Failed to copy');
            }
        });
      });
    </script>
  </head>
  <body class="bg-black text-term-green font-mono h-screen flex flex-col overflow-hidden">
    <!-- Header -->
    <header class="flex items-center justify-between px-4 py-2 bg-black border-b border-term-green/30 shrink-0">
      <div class="flex items-center gap-4">
        <a href="/ui/views/app.html" class="text-term-amber hover:text-white transition">‚Üê EXIT</a>
        <span class="text-term-green/50">|</span>
        <span class="text-term-green text-sm">SYSTEM INTERNALS v1.0</span>
      </div>
      <div class="flex items-center gap-3 text-sm">
        <span class="text-term-green/70">SERVER:</span>
        <span class="text-term-green">‚óè CONNECTED</span>
      </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
      <!-- LEFT: Socket Monitor -->
      <div class="w-2/3 flex flex-col border-r border-term-green/20">
        <div class="px-3 py-2 bg-black border-b border-term-green/20 text-term-green/70 text-xs uppercase tracking-wide">
          Socket Traffic Monitor
        </div>
        <div class="flex-1 overflow-auto p-3 text-xs scanlines relative bg-[#0a0a0f]">
          <div class="space-y-1 font-mono" id="log-container">
            <!-- Dynamic logs will appear here -->
             <div><span class="text-term-green/50">[SYSTEM]</span> <span class="text-term-green">Initializing Connection Doctor...</span></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: State & Tools -->
      <div class="w-1/3 flex flex-col bg-[#0a0a0f]">
        <!-- Sync Status -->
        <div class="p-4 border-b border-term-green/20">
          <div class="text-term-green/70 text-xs uppercase tracking-wide mb-3">Sync Status</div>
            <div class="flex items-center gap-2 mb-3">
            <span id="sync-dot" class="w-3 h-3 rounded-full bg-term-green animate-pulse"></span>
            <span id="sync-text" class="text-term-green font-bold">Waiting...</span>
          </div>
          <div class="text-xs space-y-1">
            <div class="flex justify-between"><span class="text-term-green/50">Client State:</span><span>Online</span></div>
            <div class="flex justify-between"><span class="text-term-green/50">Server State:</span><span>Listening</span></div>
            <div class="flex justify-between"><span class="text-term-green/50">Drift:</span><span class="text-term-green" id="drift-value">--</span></div>
          </div>
        </div>

        <!-- Invariants -->
        <div class="p-4 border-b border-term-green/20">
          <div class="text-term-green/70 text-xs uppercase tracking-wide mb-3">Core Invariants</div>
          <div class="text-xs space-y-2">
            <div class="flex items-center gap-2"><span class="text-term-green">‚úì</span> Server is source of truth</div>
            <div class="flex items-center gap-2"><span class="text-term-green">‚úì</span> Messages never disappear</div>
            <div class="flex items-center gap-2"><span class="text-term-green">‚úì</span> Ordering is deterministic</div>
            <div class="flex items-center gap-2"><span class="text-term-green">‚úì</span> Backfill is complete</div>
            <div class="flex items-center gap-2"><span class="text-term-green">‚úì</span> Ownership is permanent</div>
          </div>
        </div>

        <!-- Actions -->
        <div class="p-4 flex-1">
          <div class="text-term-green/70 text-xs uppercase tracking-wide mb-3">Nuclear Options</div>
          <div class="space-y-2">
            <button class="w-full px-3 py-2 text-sm bg-term-amber/20 hover:bg-term-amber/30 border border-term-amber/50 rounded text-term-amber transition text-left">
              ‚ö° Force Backfill
            </button>
            <button id="btn-reconnect" class="w-full px-3 py-2 text-sm bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded text-red-400 transition text-left">
              üîÑ Reconnect Socket
            </button>
            <button id="btn-copy" class="w-full px-3 py-2 text-sm bg-slate-700/50 hover:bg-slate-700 border border-slate-600 rounded text-slate-300 transition text-left">
              üìã Copy Diagnostics
            </button>
          </div>
        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-term-green/20 text-xs text-term-green/50">
          <div>NeoSpace Core v1.0.0</div>
          <div>Epoch: E1 (Frozen)</div>
        </div>
      </div>
    </div>
  </body>
</html>
