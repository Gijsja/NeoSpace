<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Wall - LocalBBS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'bbs-bg': '#0a0f1a',
              'bbs-surface': 'rgba(30, 41, 59, 0.8)',
              'bbs-border': 'rgba(71, 85, 105, 0.5)',
              'bbs-accent': '#60a5fa',
              'bbs-accent-glow': 'rgba(96, 165, 250, 0.4)',
            },
            fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
            animation: {
              'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
            },
            keyframes: {
              pop: {
                '0%': { transform: 'scale(0.9)', opacity: '0' },
                '100%': { transform: 'scale(1)', opacity: '1' }
              }
            },
            boxShadow: {
              'glow': '0 0 15px rgba(96, 165, 250, 0.5)',
            }
          }
        }
      }
    </script>
    <!-- Mobile Drag & Drop Polyfill -->
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
    <script>
        // Init polyfill
        if (typeof MobileDragDrop !== 'undefined') {
            MobileDragDrop.polyfill({
                dragImageTranslateOverride: MobileDragDrop.scrollBehaviourDragImageTranslateOverride
            });
            // Fix for scroll issues on mobile during drag
            window.addEventListener( 'touchmove', function() {}, {passive: false});
        }
    </script>
    <script src="/ui/js/voice.js"></script>
    <script src="/ui/js/wall.js"></script>
  </head>
  <body class="bg-bbs-bg text-slate-200 min-h-screen font-sans" id="body-el">
    <!-- Back navigation -->
    <nav class="fixed top-4 left-4 z-50">
      <a href="/ui/views/app.html" class="flex items-center gap-2 px-3 py-2 bg-bbs-surface/80 backdrop-blur border border-bbs-border rounded-lg text-sm text-slate-300 hover:text-white transition shadow-lg">
        <i class="ph-bold ph-arrow-left"></i> Back to Chat
      </a>
    </nav>

    <!-- Loading State -->
    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-bbs-bg z-40">
        <div class="text-2xl font-bold animate-pulse text-slate-500 flex items-center gap-2">
            <i class="ph-bold ph-spinner animate-spin"></i> Loading Wall...
        </div>
    </div>

    <!-- Profile Wall 2.0 Container -->
    <div id="wall-container" class="relative min-h-screen overflow-hidden hidden" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
      
      <!-- Hero Identity Block -->
      <div class="relative max-w-6xl mx-auto pt-16 px-6 pb-8 mb-6 z-10">
        <div class="flex flex-col md:flex-row items-start gap-8 md:gap-12">
            
            <!-- Avatar (Large & Distinctive) -->
            <div class="relative group shrink-0">
                <div id="avatar-container" class="w-32 h-32 md:w-48 md:h-48 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 border-2 border-white/10 shadow-2xl flex items-center justify-center overflow-hidden bg-cover bg-center transition-transform duration-500 hover:scale-[1.02] hover:shadow-glow hover:rotate-1">
                    <span id="avatar-initial" class="text-6xl font-black text-white/10">?</span>
                </div>
                <!-- Online Dot -->
                <div id="online-indicator" class="absolute -bottom-2 -right-2 w-6 h-6 bg-emerald-500 border-4 border-bbs-bg rounded-full shadow-lg hidden" title="Online"></div>
                <!-- Edit Avatar (Owner) -->
                <button id="edit-avatar-btn" class="absolute bottom-2 right-2 p-2 bg-black/50 hover:bg-bbs-accent text-white rounded-lg backdrop-blur opacity-0 group-hover:opacity-100 transition hidden pointer-events-auto">
                     <i class="ph-bold ph-camera"></i>
                </button>
            </div>

            <!-- Identity Info -->
            <div class="flex-1 min-w-0 pt-2 space-y-5">
                <div>
                    <h1 class="text-4xl md:text-6xl font-black tracking-tight text-white mb-1 leading-none drop-shadow-lg" id="display-name">Username</h1>
                    <div class="flex items-center gap-3">
                        <p class="text-lg text-slate-400 font-mono tracking-wide" id="username-handle">@handle</p>
                        <button id="edit-profile-btn" class="px-3 py-1 bg-white/5 hover:bg-white/10 border border-white/5 rounded text-xs font-bold text-slate-300 transition hidden">
                            Edit Profile
                        </button>
                    </div>
                </div>

                <!-- Status Line -->
                <div class="relative group max-w-2xl bg-black/20 backdrop-blur rounded-xl p-4 border border-white/5 hover:bg-black/30 transition">
                    <div class="flex items-start gap-4">
                        <span id="status-emoji" class="text-3xl pt-0.5 filter drop-shadow">ðŸ‘‹</span>
                        <div class="flex-1">
                            <p id="status-message" class="text-xl md:text-2xl text-slate-200 font-medium leading-snug">
                                Setting up my space...
                            </p>
                            <p class="text-xs text-slate-500 mt-2 font-mono uppercase tracking-wider" id="status-label">Current Status</p>
                        </div>
                    </div>
                </div>
                
                <!-- Voice Intro Player (Dynamic) -->
                <div id="voice-intro-section" class="hidden max-w-md">
                     <!-- Injected by VoicePlayer -->
                </div>
            </div>

            <!-- "Now" Block (Ephemeral) -->
            <div class="w-full md:w-72 bg-bbs-surface/40 backdrop-blur-md rounded-2xl p-6 border border-white/10 shadow-xl hover:border-bbs-accent/30 transition group relative overflow-hidden">
                <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition">
                     <i class="ph-duotone ph-clock text-6xl rotate-12"></i>
                </div>
                
                <div class="flex items-center justify-between mb-4 relative z-10">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-amber-400 animate-pulse"></span> Now
                    </h3>
                    <span id="now-activity-type-icon" class="text-bbs-accent text-lg">
                        <i class="ph-fill ph-star"></i>
                    </span>
                </div>
                
                <p id="now-activity" class="text-white font-medium text-lg leading-relaxed relative z-10 italic">
                    Just chilling...
                </p>
                
                 <!-- Update Now Trigger (Owner) -->
                 <button id="edit-now-btn" class="w-full mt-4 py-2 text-xs font-bold bg-white/5 hover:bg-white/10 text-slate-300 border border-white/5 rounded transition hidden relative z-10">
                    Update Status
                 </button>
            </div>
        </div>
      </div>
      
      <!-- Content Container -->
      <div class="max-w-6xl mx-auto px-6 relative z-10">

        <!-- Pinned Scripts -->
        <div id="pinned-scripts-section" class="mb-6 hidden">
            <h3 class="text-xs text-slate-500 uppercase tracking-wide mb-3 flex items-center gap-1">
                <i class="ph-bold ph-code"></i> Pinned Scripts
            </h3>
            <div id="pinned-scripts-grid">
                <!-- Script cards injected here -->
            </div>
        </div>

        <!-- Content Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pb-12">
          
          <!-- STICKER BOARD -->
          <div class="col-span-2 bg-bbs-surface/30 backdrop-blur rounded-xl border border-bbs-border/50 min-h-[400px] relative overflow-hidden group" id="sticker-canvas">
            <!-- Canvas Background / Drop Target -->
            
            <div class="absolute top-3 left-3 z-20 flex gap-2">
                <div class="text-xs text-slate-500 uppercase tracking-wide flex items-center gap-1 bg-black/20 px-2 py-1 rounded backdrop-blur">
                    <i class="ph-bold ph-sticker"></i> Sticker Board
                </div>
            </div>

            <!-- Stickers Palette (Visible to logged in users) -->
            <div id="sticker-palette" class="hidden absolute bottom-4 left-4 right-4 bg-bbs-surface/90 border border-bbs-border rounded-xl p-3 backdrop-blur z-30 shadow-2xl overflow-x-auto flex gap-4 scrollbar-hide">
                <!-- Populated by JS -->
            </div>
            
            <!-- Stickers are appended here by JS -->
          </div>

          <!-- INFO / STATS -->
          <div class="space-y-6">
              <div class="bg-bbs-surface/30 backdrop-blur rounded-xl p-4 border border-bbs-border/50">
                <h3 class="text-xs text-slate-500 uppercase tracking-wide mb-3 flex items-center gap-1">
                    <i class="ph-bold ph-info"></i> Info
                </h3>
                <div class="space-y-3 text-sm text-slate-400">
                    <div class="flex justify-between items-center border-b border-white/5 pb-2">
                        <span>Member Since</span>
                        <span id="member-since" class="text-slate-200 font-mono">2026</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Status</span>
                        <span class="px-2 py-0.5 rounded bg-emerald-500/20 text-emerald-400 text-xs font-bold">Respected</span>
                    </div>
                </div>
              </div>

               <!-- TOP FRIENDS (Mock for now) -->
              <div class="bg-bbs-surface/30 backdrop-blur rounded-xl p-4 border border-bbs-border/50">
                <h3 class="text-xs text-slate-500 uppercase tracking-wide mb-3 flex items-center gap-1">
                    <i class="ph-bold ph-users"></i> Top Friends
                </h3>
                <div class="grid grid-cols-4 gap-2">
                    <div class="aspect-square rounded-full bg-slate-700/50 flex items-center justify-center text-xs">?</div>
                    <div class="aspect-square rounded-full bg-slate-700/50 flex items-center justify-center text-xs">?</div>
                    <div class="aspect-square rounded-full bg-slate-700/50 flex items-center justify-center text-xs">?</div>
                    <div class="aspect-square rounded-full bg-slate-700/50 flex items-center justify-center text-xs">?</div>
                </div>
              </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-bbs-surface border border-bbs-border rounded-xl w-full max-w-md shadow-2xl overflow-hidden animate-pop">
            <div class="p-4 border-b border-bbs-border flex justify-between items-center bg-slate-800/50">
                <h2 class="font-bold text-white flex items-center gap-2">
                    <i class="ph-bold ph-pencil-simple text-bbs-accent"></i> Edit Profile
                </h2>
                <button type="button" class="close-modal text-slate-400 hover:text-white transition">
                    <i class="ph-bold ph-x text-lg"></i>
                </button>
            </div>
            <form id="edit-form" class="p-4 space-y-4 max-h-[80vh] overflow-y-auto">
                
                <!-- Avatar -->
                <div class="flex items-center gap-4 bg-slate-800/30 p-3 rounded-lg border border-white/5">
                    <div class="w-16 h-16 rounded-full bg-slate-700 bg-cover bg-center shrink-0 border-2 border-bbs-border shadow-inner" id="preview-avatar"></div>
                    <label class="flex-1 cursor-pointer">
                        <span class="block text-sm font-medium text-slate-300 mb-1">Update Avatar</span>
                        <input type="file" id="avatar-input" accept="image/*" class="block w-full text-xs text-slate-400 file:mr-2 file:py-1.5 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-bbs-accent/20 file:text-bbs-accent hover:file:bg-bbs-accent/30 transition" />
                    </label>
                </div>

                <!-- Voice Intro Recorder -->
                <div class="bg-slate-800/30 p-3 rounded-lg border border-white/5">
                    <label class="block text-xs uppercase text-slate-500 font-bold mb-2">Voice Intro</label>
                    <div class="flex gap-2 items-center mb-2">
                        <button type="button" id="record-btn" class="px-3 py-1.5 bg-rose-500 hover:bg-rose-600 text-white text-xs font-bold rounded flex items-center gap-1 transition">
                            <i class="ph-bold ph-microphone"></i> Record
                        </button>
                        <button type="button" id="stop-btn" class="px-3 py-1.5 bg-slate-600 hover:bg-slate-500 text-white text-xs font-bold rounded flex items-center gap-1 transition hidden">
                            <i class="ph-bold ph-stop"></i> Stop
                        </button>
                    </div>
                    <canvas id="recorder-canvas" width="200" height="40" class="w-full h-10 bg-slate-900 rounded mb-2 border border-white/5"></canvas>
                    <button type="button" id="upload-voice-btn" class="w-full py-1.5 bg-bbs-accent hover:bg-blue-600 text-white text-xs font-bold rounded disabled:opacity-50 disabled:cursor-not-allowed transition" disabled>
                        Upload Selection
                    </button>
                    <p id="voice-status" class="text-[10px] text-slate-500 mt-1 text-center h-4"></p>
                </div>

                <div>
                    <label class="block text-xs uppercase text-slate-500 font-bold mb-1.5">Status Line</label>
                    <div class="flex gap-2">
                         <input type="text" name="status_emoji" id="input-status-emoji" class="w-16 bg-bbs-bg border border-bbs-border rounded-lg px-3 py-2 text-white text-center text-xl focus:border-bbs-accent focus:outline-none focus:ring-1 focus:ring-bbs-accent transition" placeholder="ðŸ‘‹" maxlength="4" />
                         <input type="text" name="status_message" id="input-status-msg" class="flex-1 bg-bbs-bg border border-bbs-border rounded-lg px-3 py-2 text-white focus:border-bbs-accent focus:outline-none focus:ring-1 focus:ring-bbs-accent transition" placeholder="What's your vibe today?" maxlength="100" />
                    </div>
                </div>

                <div class="bg-black/20 p-3 rounded-lg border border-white/5">
                     <label class="block text-xs uppercase text-slate-500 font-bold mb-1.5 flex items-center gap-2">
                        <i class="ph-bold ph-clock"></i> The "Now" Block
                     </label>
                     <div class="grid grid-cols-3 gap-2 mb-2">
                        <select name="now_activity_type" id="input-now-type" class="col-span-1 bg-bbs-bg border border-bbs-border rounded-lg px-2 py-2 text-white text-xs focus:border-bbs-accent focus:outline-none">
                            <option value="thinking">Thinking</option>
                            <option value="listening">Listening</option>
                            <option value="working">Working</option>
                            <option value="playing">Playing</option>
                            <option value="reading">Reading</option>
                             <option value="watching">Watching</option>
                        </select>
                        <input type="text" name="now_activity" id="input-now-activity" class="col-span-2 bg-bbs-bg border border-bbs-border rounded-lg px-3 py-2 text-white text-sm focus:border-bbs-accent focus:outline-none focus:ring-1 focus:ring-bbs-accent transition" placeholder="e.g. Listening to Jazz..." maxlength="50" />
                     </div>
                </div>

                <div>
                    <label class="block text-xs uppercase text-slate-500 font-bold mb-1.5">Display Name</label>
                    <input type="text" name="display_name" id="input-name" class="w-full bg-bbs-bg border border-bbs-border rounded-lg px-3 py-2 text-white focus:border-bbs-accent focus:outline-none focus:ring-1 focus:ring-bbs-accent transition" required maxlength="50" />
                </div>

                <div>
                    <label class="block text-xs uppercase text-slate-500 font-bold mb-1.5">Bio (Legacy)</label>
                    <textarea name="bio" id="input-bio" rows="2" class="w-full bg-bbs-bg border border-bbs-border rounded-lg px-3 py-2 text-white focus:border-bbs-accent focus:outline-none focus:ring-1 focus:ring-bbs-accent transition resize-none" maxlength="500"></textarea>
                </div>

                <!-- Sprint 11: Audio Anthem -->
                <div class="bg-gradient-to-r from-purple-900/30 to-pink-900/30 p-3 rounded-lg border border-purple-500/20">
                    <label class="block text-xs uppercase text-slate-500 font-bold mb-1.5 flex items-center gap-2">
                        <i class="ph-bold ph-music-notes text-purple-400"></i> Profile Anthem
                    </label>
                    <input type="url" name="anthem_url" id="input-anthem-url" 
                           class="w-full bg-bbs-bg border border-bbs-border rounded-lg px-3 py-2 text-white focus:border-purple-400 focus:outline-none focus:ring-1 focus:ring-purple-400 transition mb-2" 
                           placeholder="https://example.com/song.mp3" />
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="checkbox" name="anthem_autoplay" id="input-anthem-autoplay" 
                               class="rounded bg-bbs-bg border-bbs-border text-purple-400 focus:ring-offset-0 focus:ring-0 w-4 h-4" checked />
                        <span class="text-sm text-slate-300 group-hover:text-white transition">Autoplay for visitors</span>
                    </label>
                    <p class="text-[10px] text-slate-500 mt-2">Direct link to MP3/audio file. Will loop on your wall.</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase text-slate-500 font-bold mb-1.5">Theme</label>
                        <select name="theme_preset" id="input-theme" class="w-full bg-bbs-bg border border-bbs-border rounded-lg px-3 py-2 text-white focus:border-bbs-accent focus:outline-none appearance-none">
                            <option value="default">Default</option>
                            <option value="dark">Midnight</option>
                            <option value="retro">Cyber Retro</option>
                            <option value="zen">Forest Zen</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs uppercase text-slate-500 font-bold mb-1.5">Accent Color</label>
                        <div class="flex gap-2 items-center">
                            <input type="color" name="accent_color" id="input-accent" class="w-full h-[38px] bg-bbs-bg border border-bbs-border rounded-lg cursor-pointer p-1" />
                        </div>
                    </div>
                </div>

                <div class="space-y-3 pt-3 border-t border-bbs-border/50">
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="checkbox" name="is_public" id="input-public" class="rounded bg-bbs-bg border-bbs-border text-bbs-accent focus:ring-offset-0 focus:ring-0 w-4 h-4" />
                        <span class="text-sm text-slate-300 group-hover:text-white transition">Public Profile</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="checkbox" name="show_online_status" id="input-online" class="rounded bg-bbs-bg border-bbs-border text-bbs-accent focus:ring-offset-0 focus:ring-0 w-4 h-4" />
                        <span class="text-sm text-slate-300 group-hover:text-white transition">Show Online Status</span>
                    </label>
                </div>

                 <div class="flex justify-end gap-3 pt-4 border-t border-bbs-border/50 mt-2">
                    <button type="button" class="close-modal px-4 py-2 text-sm text-slate-400 hover:text-white transition font-medium">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-bbs-accent hover:bg-blue-600 text-white text-sm font-bold rounded-lg transition shadow-glow flex items-center gap-2">
                        <i class="ph-bold ph-check"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Audio Anthem Player (Hidden) -->
    <audio id="anthem-player" preload="auto" loop></audio>
    
    <!-- Anthem Mute Toggle -->
    <button id="anthem-toggle" class="fixed bottom-4 right-4 z-50 w-12 h-12 bg-purple-600/80 hover:bg-purple-500 backdrop-blur rounded-full flex items-center justify-center text-white shadow-lg transition-all duration-300 hover:scale-110 hidden" title="Toggle Music">
        <i class="ph-bold ph-speaker-high text-xl" id="anthem-icon"></i>
    </button>


    <script>
        // DOM Elements
        const wallContainer = document.getElementById('wall-container');
        const loadingEl = document.getElementById('loading');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        
        // State
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id'); // If null, assume current user
        let currentUserData = null;
        let stickerManager = null;
        let voiceRecorder = null; // VoiceRecorder instance

        // Theme Definitions
        const themes = {
            'default': 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)',
            'dark': 'linear-gradient(to bottom, #000000, #111111)',
            'retro': 'linear-gradient(45deg, #2b0a3d, #c53c8d)',
            'zen': 'linear-gradient(to bottom, #1a2f23, #2f4f4f)'
        };

        async function fetchProfile() {
            const endpoint = userId ? `/profile?user_id=${userId}` : '/profile';
            try {
                const res = await fetch(endpoint);
                if (res.status === 401) {
                    window.location.href = '/auth/login';
                    return;
                }
                const data = await res.json();
                
                if (data.error) {
                    loadingEl.innerHTML = `<div class="text-red-400 font-bold">${data.error}</div>`;
                    return;
                }

                currentUserData = data;
                renderProfile(data);
                
                // Init Stickers
                if (!stickerManager) {
                    // containerId, isHost, currentUserId, targetUserId
                    stickerManager = new StickerManager(
                        'sticker-canvas', 
                        data.is_own, 
                        data.viewer_id, 
                        data.user_id
                    );
                    
                    // Show palette if logged in
                    if (data.viewer_id) {
                        setupPalette();
                    }
                }
                stickerManager.setStickers(data.stickers);
                
                loadingEl.classList.add('hidden');
                wallContainer.classList.remove('hidden');
            } catch (err) {
                console.error(err);
                loadingEl.innerHTML = `<div class="text-red-400 font-bold">Failed to load profile (Network Error).</div>`;
            }
        }

        function renderProfile(data) {
            document.title = `${data.display_name}'s Wall`;
            
            // Text fields
            document.getElementById('display-name').textContent = data.display_name;
            document.getElementById('username-handle').textContent = `@${data.username}`;
            // document.getElementById('bio-text').textContent = data.bio || ""; // Bio moved/deprecated for Status?
            
            // Status & Now
            document.getElementById('status-message').textContent = data.status_message || "Just setting up my space...";
            document.getElementById('status-emoji').textContent = data.status_emoji || "ðŸ‘‹";
            document.getElementById('now-activity').textContent = data.now_activity || "Just chilling...";
            
            // Icon mapping for "Now" type
            const activityIcons = {
                'listening': 'ph-headphones',
                'working': 'ph-laptop',
                'playing': 'ph-game-controller',
                'reading': 'ph-book-open',
                'thinking': 'ph-brain',
                'watching': 'ph-monitor-play'
            };
            const iconClass = activityIcons[data.now_activity_type] || 'ph-star';
            document.getElementById('now-activity-type-icon').innerHTML = `<i class="ph-fill ${iconClass}"></i>`;

            document.getElementById('member-since').textContent = new Date(data.member_since).toLocaleDateString(undefined, { year: 'numeric', month: 'short' });

            // Avatar
            const avatarEl = document.getElementById('avatar-container');
            const initialEl = document.getElementById('avatar-initial');
            if (data.avatar_path) {
                avatarEl.style.backgroundImage = `url('${data.avatar_path}')`;
                initialEl.classList.add('hidden');
            } else {
                avatarEl.style.backgroundImage = '';
                initialEl.classList.remove('hidden');
                initialEl.textContent = data.display_name.charAt(0).toUpperCase();
            }

            // Voice Intro
            const voiceSection = document.getElementById('voice-intro-section');
            if (data.voice_intro_path) {
                voiceSection.classList.remove('hidden');
                // Parse waveform JSON safely
                let waveform = [];
                try {
                    waveform = JSON.parse(data.voice_waveform_json || '[]');
                } catch(e) {}
                
                new VoicePlayer('voice-intro-section', data.voice_intro_path, waveform);
            } else {
                voiceSection.classList.add('hidden');
                voiceSection.innerHTML = ''; 
            }

            // Audio Anthem (Sprint 11)
            setupAnthem(data.anthem_url, data.anthem_autoplay);

            // Theme & Accent
            if (themes[data.theme_preset]) {
                document.getElementById('wall-container').style.background = themes[data.theme_preset];
            }
            document.documentElement.style.setProperty('--color-accent', data.accent_color);
            
            // Interaction
            if (data.is_own) {
                // Show edit controls
                ['edit-avatar-btn', 'edit-profile-btn', 'edit-now-btn'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.classList.remove('hidden');
                        el.onclick = openEditModal; // For now all open main modal
                    }
                });
            }
            
            if (data.show_online_status) {
                document.getElementById('online-indicator').classList.remove('hidden');
            }
            
            // Pinned Scripts
            renderPinnedScripts(data.pinned_scripts);
        }

        // --- Edit Logic ---

        function openEditModal() {
            if (!currentUserData) return;
            const d = currentUserData;
            
            document.getElementById('input-name').value = d.display_name;
            document.getElementById('input-bio').value = d.bio;
            
            // New Fields
            if(document.getElementById('input-status-msg')) document.getElementById('input-status-msg').value = d.status_message || "";
            if(document.getElementById('input-status-emoji')) document.getElementById('input-status-emoji').value = d.status_emoji || "ðŸ‘‹";
            if(document.getElementById('input-now-activity')) document.getElementById('input-now-activity').value = d.now_activity || "";
            if(document.getElementById('input-now-type')) document.getElementById('input-now-type').value = d.now_activity_type || "thinking";

            document.getElementById('input-theme').value = d.theme_preset;
            document.getElementById('input-accent').value = d.accent_color;
            document.getElementById('input-public').checked = d.is_public !== false; 
            document.getElementById('input-online').checked = d.show_online_status !== false;
            
            // Anthem fields
            if(document.getElementById('input-anthem-url')) document.getElementById('input-anthem-url').value = d.anthem_url || '';
            if(document.getElementById('input-anthem-autoplay')) document.getElementById('input-anthem-autoplay').checked = d.anthem_autoplay !== false;

            // Preview current avatar
            const prev = document.getElementById('preview-avatar');
            if (d.avatar_path) prev.style.backgroundImage = `url('${d.avatar_path}')`;
            else {
                prev.style.backgroundImage = '';
                prev.textContent = d.display_name.charAt(0);
                prev.classList.add('flex', 'items-center', 'justify-center', 'text-xl', 'font-bold', 'text-white');
            }
            
            // Reset Voice UI
            document.getElementById('voice-status').textContent = '';
            document.getElementById('upload-voice-btn').disabled = true;

            editModal.classList.remove('hidden');
        }

        document.querySelectorAll('.close-modal').forEach(b => {
            b.onclick = () => {
                editModal.classList.add('hidden');
                if (voiceRecorder) voiceRecorder.stop(); // Ensure recording stops if modal closed
            };
        });

        // --- Voice Recorder Logic ---
        let voiceBlob = null;
        let voiceWaveform = null;
        
        const recordBtn = document.getElementById('record-btn');
        const stopBtn = document.getElementById('stop-btn');
        const uploadVoiceBtn = document.getElementById('upload-voice-btn');
        const voiceStatus = document.getElementById('voice-status');
        
        recordBtn.onclick = async () => {
            if (!voiceRecorder) {
                voiceRecorder = new VoiceRecorder('recorder-canvas');
            }
            
            try {
                await voiceRecorder.start();
                recordBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                voiceStatus.textContent = "Recording...";
                uploadVoiceBtn.disabled = true;
            } catch (err) {
                voiceStatus.textContent = "Mic access denied.";
            }
        };
        
        stopBtn.onclick = async () => {
             const result = await voiceRecorder.stop();
             if (result) {
                 voiceBlob = result.blob;
                 voiceWaveform = result.waveform;
                 
                 recordBtn.classList.remove('hidden');
                 stopBtn.classList.add('hidden');
                 voiceStatus.textContent = "Recording captured. Ready to upload.";
                 uploadVoiceBtn.disabled = false;
             }
        };
        
        uploadVoiceBtn.onclick = async () => {
             if (!voiceBlob) return;
             
             voiceStatus.textContent = "Uploading...";
             
             const formData = new FormData();
             formData.append('voice', voiceBlob);
             formData.append('waveform', JSON.stringify(voiceWaveform));
             
             try {
                 const res = await fetch('/profile/voice/upload', {
                     method: 'POST',
                     body: formData
                 });
                 const data = await res.json();
                 
                 if (data.ok) {
                     voiceStatus.textContent = "Uploaded successfully!";
                     voiceStatus.classList.add('text-emerald-400');
                     currentUserData.voice_intro_path = data.voice_path;
                     currentUserData.voice_waveform_json = JSON.stringify(voiceWaveform);
                     renderProfile(currentUserData); // Update bg loop
                 } else {
                     voiceStatus.textContent = "Upload failed.";
                 }
             } catch(e) {
                 voiceStatus.textContent = "Error uploading.";
             }
        };

        // Handle Avatar Upload independently or as part of submit?
        // Let's do instant upload for avatar to simplify
        document.getElementById('avatar-input').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('avatar', file);
            
            const prev = document.getElementById('preview-avatar');
            prev.innerHTML = '<i class="ph-bold ph-spinner animate-spin text-white"></i>';

            try {
                const res = await fetch('/profile/avatar', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.ok) {
                    // Update preview
                    prev.style.backgroundImage = `url('${data.avatar_path}')`;
                    prev.innerHTML = '';
                    // Also update main view live
                    currentUserData.avatar_path = data.avatar_path;
                    renderProfile(currentUserData);
                } else {
                    alert(data.error || "Upload failed");
                    prev.innerHTML = 'âŒ';
                }
            } catch (err) {
                console.error(err);
                alert("Upload error");
            }
        };

        editForm.onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(editForm);
            const payload = Object.fromEntries(formData.entries());
            
            // checkbox handling
            payload.is_public = formData.get('is_public') === 'on';
            payload.show_online_status = formData.get('show_online_status') === 'on';
            payload.anthem_autoplay = formData.get('anthem_autoplay') === 'on';

            try {
                const res = await fetch('/profile/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.ok) {
                    editModal.classList.add('hidden');
                    fetchProfile(); // Reload
                } else {
                    alert(data.error || "Update failed");
                }
            } catch (err) {
                alert("Update error");
            }
        };

        // =============================================
        // AUDIO ANTHEM (Sprint 11)
        // =============================================
        let anthemMuted = false;
        const anthemPlayer = document.getElementById('anthem-player');
        const anthemToggle = document.getElementById('anthem-toggle');
        const anthemIcon = document.getElementById('anthem-icon');
        
        function setupAnthem(url, autoplay) {
            if (!url) {
                anthemToggle.classList.add('hidden');
                anthemPlayer.pause();
                anthemPlayer.src = '';
                return;
            }
            
            anthemPlayer.src = url;
            anthemToggle.classList.remove('hidden');
            
            if (autoplay) {
                // Try to play (may be blocked by browser policy)
                anthemPlayer.play().then(() => {
                    updateAnthemIcon(false);
                }).catch(() => {
                    // Autoplay blocked - show as muted, user can click to play
                    anthemMuted = true;
                    updateAnthemIcon(true);
                });
            } else {
                anthemMuted = true;
                updateAnthemIcon(true);
            }
        }
        
        function updateAnthemIcon(muted) {
            if (muted) {
                anthemIcon.className = 'ph-bold ph-speaker-x text-xl';
                anthemToggle.classList.add('bg-slate-600/80');
                anthemToggle.classList.remove('bg-purple-600/80');
            } else {
                anthemIcon.className = 'ph-bold ph-speaker-high text-xl';
                anthemToggle.classList.remove('bg-slate-600/80');
                anthemToggle.classList.add('bg-purple-600/80');
            }
        }
        
        anthemToggle.onclick = () => {
            anthemMuted = !anthemMuted;
            if (anthemMuted) {
                anthemPlayer.pause();
            } else {
                anthemPlayer.play().catch(() => {});
            }
            updateAnthemIcon(anthemMuted);
        };

        function setupPalette() {
            const palette = document.getElementById('sticker-palette');
            palette.classList.remove('hidden');
            
            // From global STICKERS_PRESETS in wall.js
            if (window.STICKERS_PRESETS) {
                palette.innerHTML = '';
                window.STICKERS_PRESETS.forEach(char => {
                    const el = document.createElement('div');
                    el.className = 'text-3xl hover:scale-125 transition cursor-grab active:cursor-grabbing p-2 shrink-0';
                    el.innerText = char;
                    el.draggable = true;
                    el.ondragstart = (e) => {
                        // Pass to manager logic if needed, or just let manager handle dragstart globally?
                        // Actually global dragstart might be tricky if not on canvas.
                        // Let's attach handler manually here since they are outside canvas
                        // But wait, manager.handleDragStart listens on elements. Pallete items are new.
                        // We need a way to hook into the manager's drag start logic for new items.
                        // Implemented: Manager expects e.target.innerText for new items.
                    };
                    // Re-attaching the same handler logic?
                    el.addEventListener('dragstart', (e) => {
                       // We need to manually construct the data transfer here
                       e.dataTransfer.setData('text/plain', JSON.stringify({
                            type: 'new',
                            sticker: char,
                            offsetX: 20, // Center approx
                            offsetY: 20
                        }));
                    });
                    
                    palette.appendChild(el);
                });
            }
        }
        
        // =============================================
        // PINNED SCRIPTS RENDERING (Masonry)
        // =============================================
        function renderPinnedScripts(scripts) {
            if (!scripts || scripts.length === 0) {
                document.getElementById('pinned-scripts-section').classList.add('hidden');
                return;
            }
            
            const section = document.getElementById('pinned-scripts-section');
            const grid = document.getElementById('pinned-scripts-grid');
            section.classList.remove('hidden');
            grid.innerHTML = '';
            
            // Switch grid to masonry columns via CSS class if not already set
            grid.className = 'columns-1 md:columns-3 gap-6 space-y-6';
            
            scripts.forEach(script => {
                const card = document.createElement('div');
                
                // Random aspect ratio for masonry effect (Tall, Square, Wide)
                // We'll use a pseudo-random determined by script ID so it's stable
                const heights = ['h-64', 'h-80', 'h-56'];
                const heightClass = heights[script.id % heights.length];
                
                card.className = `glass-panel-interactive rounded-xl overflow-hidden relative group ${heightClass} break-inside-avoid transition-all duration-300 hover:shadow-glow-md mb-6 w-full`;
                
                // HTML structure for immersive card
                card.innerHTML = `
                    <!-- Header Overlay -->
                    <div class="absolute top-0 left-0 right-0 p-3 flex justify-between items-start z-20 pointer-events-none bg-gradient-to-b from-black/80 to-transparent">
                        <h4 class="font-bold text-white text-shadow-sm truncate pr-2">${script.title}</h4>
                        <span class="text-[10px] uppercase font-mono bg-black/50 px-1.5 py-0.5 rounded text-slate-300 border border-white/10 backdrop-blur">${script.script_type}</span>
                    </div>

                    <!-- Script Container -->
                    <div class="script-container absolute inset-0 bg-slate-900 z-10">
                        <!-- Placeholder / Play Trigger -->
                         <div class="placeholder absolute inset-0 flex items-center justify-center cursor-pointer group-hover:bg-white/5 transition z-20">
                             <div class="w-12 h-12 rounded-full bg-bbs-accent/20 border border-bbs-accent/50 flex items-center justify-center backdrop-blur group-hover:scale-110 transition shadow-glow">
                                <i class="ph-fill ph-play text-bbs-accent text-xl"></i>
                             </div>
                             <div class="absolute bottom-4 left-0 right-0 text-center text-xs text-slate-400 opacity-0 group-hover:opacity-100 transition">
                                Click to Run
                             </div>
                        </div>
                    </div>
                `;
                
                const placeholder = card.querySelector('.placeholder');
                placeholder.onclick = (e) => {
                    e.stopPropagation();
                    activateScript(card, script);
                };
                
                grid.appendChild(card);
            });
        }
        
        async function activateScript(card, script) {
            const container = card.querySelector('.script-container');
            const placeholder = card.querySelector('.placeholder');
            
            // Loading state
            placeholder.innerHTML = '<i class="ph-bold ph-spinner animate-spin text-bbs-accent text-2xl"></i>';
            
            // Fetch content if not provided in list (we need full content)
            // The profile endpoint might perform optimization and not send full content for huge scripts
            // But currently it does include full content via join if we check mutations/profile.py
            // Actually get_pinned_scripts returns id, title, script_type... 
            // We need to fetch full content!
            
            try {
                const res = await fetch(`/scripts/get?id=${script.id}`);
                const data = await res.json();
                
                if (!data.ok) {
                    placeholder.innerHTML = '<span class="text-red-400 text-xs">Failed</span>';
                    return;
                }
                
                const fullScript = data.script;
                const mode = fullScript.script_type || 'p5';
                
                // Construct Iframe
                const iframe = document.createElement('iframe');
                iframe.className = "w-full h-full border-none bg-black absolute inset-0 z-30 animate-fade-in";
                iframe.setAttribute('sandbox', 'allow-scripts');
                
               // Generate iframe content with autosize
                let html = '';
                if (mode === 'p5') {
                    html = `<!DOCTYPE html>
<html>
<head>
    <style>body { margin: 0; overflow: hidden; }</style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"><\/script>
</head>
<body>
    <script>
    // Force P5 to fit container
    function windowResized() {
       if (typeof resizeCanvas === 'function') resizeCanvas(window.innerWidth, window.innerHeight);
    }
    
    try {
        ${fullScript.content}
        
        // Inject auto-resize if not present
        if (!${fullScript.content.includes('setup')}) {
            // If they wrote raw p5 without setup (global mode), wrapper might be needed
            // But assuming standard p5 instance mode or global mode:
            // We'll leave it to user code, but default p5 canvas matches display size usually
        }
    } catch (e) {
        document.body.innerHTML = '<pre style="color:red; padding:10px; font-size:10px;">' + e.toString() + '</pre>';
    }
    <\/script>
</body>
</html>`;
                } else if (mode === 'three') {
                    html = `<!DOCTYPE html>
<html>
<head><style>body { margin: 0; overflow: hidden; }</style></head>
<body>
    <script type="module">
    try {
        ${fullScript.content}
    } catch (e) {
        document.body.innerHTML = '<pre style="color:red; padding:10px; font-size:10px;">' + e.toString() + '</pre>';
    }
    <\/script>
</body>
</html>`;
                } else {
                    html = `<!DOCTYPE html><html><body style="margin:0;overflow:hidden;color:#fff;font-family:monospace;font-size:12px;"><script>${fullScript.content}<\/script></body></html>`;
                }
                
                // Clear placeholder and inject iframe
                container.innerHTML = '';
                container.appendChild(iframe);
                
                // Write content safely using srcdoc (avoids cross-origin issues with sandbox)
                iframe.srcdoc = html;
                
                // Add "Stop" button overlay on hover
                const stopBtn = document.createElement('button');
                stopBtn.className = "absolute top-3 right-3 z-40 bg-black/50 hover:bg-red-500/80 text-white p-1 rounded backdrop-blur opacity-0 group-hover:opacity-100 transition";
                stopBtn.innerHTML = '<i class="ph-bold ph-stop"></i>';
                stopBtn.title = "Stop Script";
                stopBtn.onclick = (e) => {
                    e.stopPropagation();
                    // Re-render this card to reset
                    renderPinnedScripts([script]); // This is a bit heavy-handed, actually better to just reset this card's innerHTML
                    // But simpler for now to revert to renderPinnedScripts logic for single item? 
                    // Let's just reload the whole list to be safe or re-call render for that item.
                    // For now, reload page section:
                    fetchProfile();
                };
                card.appendChild(stopBtn);
                
            } catch (err) {
                 placeholder.innerHTML = '<span class="text-red-400 text-xs">Error</span>';
                 console.error(err);
            }
        }
        
        // Close preview modal
        document.getElementById('close-preview').onclick = () => {
            document.getElementById('script-preview-modal').classList.add('hidden');
            document.getElementById('preview-iframe').srcdoc = ''; // Stop execution
        };

        // Init
        fetchProfile();

    </script>
  </body>
</html>
