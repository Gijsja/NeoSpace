<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LocalBBS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/ui/css/styles.css" />
    <!-- Phosphor Icons CDN -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'bbs-bg': '#0a0f1a',
              'bbs-surface': 'rgba(30, 41, 59, 0.8)',
              'bbs-surface-solid': '#1e293b',
              'bbs-border': 'rgba(71, 85, 105, 0.5)',
              'bbs-accent': '#60a5fa',
              'bbs-accent-glow': 'rgba(96, 165, 250, 0.4)',
              'bbs-success': '#34d399',
              'bbs-warning': '#fbbf24',
              'bbs-danger': '#f87171',
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
              mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
            },
            animation: {
              'fade-in-up': 'fadeInUp 0.3s ease-out',
              'pop': 'pop 0.2s ease-out',
              'wiggle': 'wiggle 0.3s ease-in-out',
              'glow-pulse': 'glowPulse 2s ease-in-out infinite',
            },
            keyframes: {
              fadeInUp: {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
              pop: {
                '0%': { transform: 'scale(0.95)' },
                '50%': { transform: 'scale(1.02)' },
                '100%': { transform: 'scale(1)' },
              },
              wiggle: {
                '0%, 100%': { transform: 'rotate(-1deg)' },
                '50%': { transform: 'rotate(1deg)' },
              },
              glowPulse: {
                '0%, 100%': { boxShadow: '0 0 5px rgba(96, 165, 250, 0.3)' },
                '50%': { boxShadow: '0 0 20px rgba(96, 165, 250, 0.6)' },
              },
            },
            boxShadow: {
              'glow': '0 0 15px rgba(96, 165, 250, 0.5)',
              'glow-lg': '0 0 30px rgba(96, 165, 250, 0.6)',
              'inner-glow': 'inset 0 0 20px rgba(96, 165, 250, 0.1)',
            },
          }
        }
      }
    </script>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body class="bg-bbs-bg text-slate-200 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 min-h-screen">
    <!-- Toast container -->
    <div class="toast-container" id="toast-container" aria-live="polite"></div>

    <!-- Three-pane dashboard -->
    <div class="flex h-screen">
      
      <!-- LEFT SIDEBAR: Rooms & Navigation -->
      <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 transform -translate-x-full transition-transform duration-300 md:translate-x-0 md:static md:w-56 bg-bbs-surface backdrop-blur-xl border-r border-bbs-border flex flex-col shrink-0 shadow-inner-glow">
        <div class="p-4 border-b border-bbs-border flex justify-between items-center">
          <h1 class="text-lg font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 flex items-center gap-2">
            <i class="ph-bold ph-broadcast text-bbs-accent"></i> LocalBBS
          </h1>
          <button id="close-sidebar" class="md:hidden text-slate-400 hover:text-white" aria-label="Close sidebar">
            <i class="ph ph-x text-lg"></i>
          </button>
        </div>
        <nav class="flex-1 overflow-y-auto p-2">
          <div class="mb-4">
            <h2 class="text-xs font-semibold text-slate-500 uppercase tracking-wide px-2 mb-2 flex items-center gap-1">
              <i class="ph ph-hash"></i> Channels
            </h2>
            <ul id="channel-list" class="space-y-1">
              <li><a href="#" data-room="general" class="room-link active flex items-center gap-2 px-3 py-2 rounded-lg bg-bbs-accent/20 text-bbs-accent text-sm font-medium transition-all duration-200 hover:scale-[1.02] active:scale-95">
                <i class="ph ph-hash-straight"></i> general
              </a></li>
              <li><a href="#" data-room="random" class="room-link flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-700/50 text-slate-400 text-sm transition-all duration-200 hover:scale-[1.02] hover:text-slate-200 active:scale-95">
                <i class="ph ph-hash-straight"></i> random
              </a></li>
              <li><a href="#" data-room="generative-art" class="room-link flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-700/50 text-slate-400 text-sm transition-all duration-200 hover:scale-[1.02] hover:text-slate-200 active:scale-95">
                <i class="ph ph-hash-straight"></i> generative-art
              </a></li>
            </ul>
          </div>
          <div>
            <h2 class="text-xs font-semibold text-slate-500 uppercase tracking-wide px-2 mb-2 flex items-center gap-1">
              <i class="ph ph-chats-circle"></i> Direct Messages
            </h2>
            <ul id="dm-list" class="space-y-1">
              <li><a href="/ui/views/messages.html" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-700/50 text-slate-400 text-sm transition-all duration-200 hover:scale-[1.02] hover:text-slate-200 active:scale-95">
                <i class="ph ph-chat-teardrop-dots text-bbs-accent"></i> Open Messages
              </a></li>
            </ul>
          </div>
          <div class="mt-4">
            <h2 class="text-xs font-semibold text-slate-500 uppercase tracking-wide px-2 mb-2 flex items-center gap-1">
              <i class="ph ph-users-three"></i> Community
            </h2>
            <ul class="space-y-1">
              <li><a href="/ui/views/directory.html" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-700/50 text-slate-400 text-sm transition-all duration-200 hover:scale-[1.02] hover:text-slate-200 active:scale-95">
                <i class="ph ph-address-book"></i> User Directory
              </a></li>
            </ul>
          </div>
        </nav>
        <div class="p-3 border-t border-bbs-border">
          <button id="btn-create-room" class="w-full px-3 py-2.5 text-sm bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-lg text-white font-semibold transition-all duration-200 shadow-glow hover:shadow-glow-lg active:scale-95 flex items-center justify-center gap-2">
            <i class="ph-bold ph-plus"></i> Create Room
          </button>
        </div>
      </aside>

      <!-- CENTER: Main Content Area -->
      <main class="flex-1 flex flex-col min-w-0">
        <!-- Header -->
        <header class="flex items-center justify-between px-3 md:px-5 py-3 bg-bbs-surface backdrop-blur-xl border-b border-bbs-border shrink-0">
          <div class="flex items-center gap-3">
             <button id="open-sidebar" class="md:hidden text-slate-400 hover:text-white p-1" aria-label="Open sidebar">
                <i class="ph ph-list text-xl"></i>
             </button>
            <span id="current-room-name" class="text-slate-200 font-semibold text-lg flex items-center gap-2 truncate max-w-[150px] md:max-w-none">
              <i class="ph ph-hash-straight text-bbs-accent"></i> general
            </span>
            <span class="unread-badge hidden bg-bbs-danger text-white text-xs font-bold px-2 py-0.5 rounded-full animate-pop" id="unread-badge">0</span>
          </div>
          <div class="flex items-center gap-4">
            <div class="relative group">
              <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-bbs-accent transition-colors"></i>
              <input type="search" id="search-input" placeholder="Search messages..." class="w-48 pl-9 pr-8 py-2 text-sm bg-slate-800/50 border border-bbs-border rounded-lg focus:outline-none focus:border-bbs-accent focus:ring-2 focus:ring-bbs-accent-glow placeholder-slate-500 transition-all duration-200" />
              <button type="button" class="search-clear absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300 hidden transition-colors" id="search-clear" aria-label="Clear search">
                <i class="ph ph-x"></i>
              </button>
            </div>
            <div class="flex items-center gap-2 text-sm text-slate-400 bg-slate-800/30 px-3 py-1.5 rounded-full">
              <span class="w-2 h-2 rounded-full bg-slate-500 transition-colors" id="status-dot"></span>
              <span id="status-text">Connecting...</span>
            </div>
            <a href="/auth/logout" class="flex items-center gap-1.5 text-sm text-slate-400 hover:text-bbs-danger transition-all duration-200 hover:scale-105 active:scale-95">
              <i class="ph ph-sign-out"></i> Logout
            </a>
          </div>
        </header>

        <!-- Messages area -->
        <div class="flex-1 overflow-y-auto p-4" id="messages-scroll" role="log" aria-label="Chat messages">
          <div class="messages-container space-y-2" id="messages"></div>
        </div>

        <!-- Drag & Drop Overlay -->
        <div id="drag-overlay" class="absolute inset-0 bg-bbs-bg/90 z-50 hidden flex flex-col items-center justify-center border-2 border-dashed border-bbs-accent m-4 rounded-xl backdrop-blur-sm pointer-events-none">
          <div class="text-6xl mb-4">ðŸ“‚</div>
          <h3 class="text-2xl font-bold text-white mb-2">Drop it like it's hot</h3>
          <p class="text-slate-400">Upload to chat</p>
        </div>

        <!-- Input area -->
        <footer class="p-4 bg-bbs-surface border-t border-bbs-border shrink-0 relative">
          <!-- Emoji Picker Container -->
          <div id="emoji-picker-container" class="absolute bottom-full left-4 mb-2 hidden z-50 shadow-2xl rounded-lg overflow-hidden border border-bbs-border">
            <emoji-picker class="dark"></emoji-picker>
          </div>

          <!-- Typing indicator -->
          <div id="typing-indicator" class="hidden text-sm text-slate-500 mb-2 flex items-center gap-2">
            <span class="typing-dots flex gap-1">
              <span class="w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce" style="animation-delay: 0ms;"></span>
              <span class="w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce" style="animation-delay: 150ms;"></span>
              <span class="w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce" style="animation-delay: 300ms;"></span>
            </span>
            <span id="typing-users">Someone is typing...</span>
          </div>
          <form class="flex gap-3" id="message-form">
            <input type="file" id="file-input" class="hidden" accept="image/*" />
            <button type="button" id="emoji-btn" class="p-2.5 text-slate-400 hover:text-yellow-400 hover:bg-slate-700/50 rounded-lg transition-all duration-200 hover:scale-110 active:scale-95" title="Insert Emoji" aria-label="Insert Emoji">
              <i class="ph ph-smiley text-xl"></i>
            </button>
            <button type="button" id="upload-btn" class="p-2.5 text-slate-400 hover:text-emerald-400 hover:bg-slate-700/50 rounded-lg transition-all duration-200 hover:scale-110 active:scale-95" title="Upload Image" aria-label="Upload Image">
              <i class="ph ph-image text-xl"></i>
            </button>
            <input type="text" id="input" placeholder="Type a message or drag & drop an imageâ€¦" autocomplete="off" class="flex-1 px-4 py-2.5 bg-slate-800/50 border border-bbs-border rounded-lg focus:outline-none focus:border-bbs-accent focus:ring-2 focus:ring-bbs-accent-glow placeholder-slate-500 transition-all duration-200" />
            <button type="submit" class="px-6 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 rounded-lg text-white font-semibold transition-all duration-200 shadow-glow hover:shadow-glow-lg active:scale-95 flex items-center gap-2" id="send-btn">
              <i class="ph-bold ph-paper-plane-tilt"></i> Send
            </button>
          </form>
        </footer>
      </main>

      <!-- RIGHT SIDEBAR: Context Panel -->
      <aside id="context-panel" class="hidden lg:flex w-72 bg-bbs-surface backdrop-blur-xl border-l border-bbs-border flex-col shrink-0 shadow-inner-glow">
        <div class="p-4 border-b border-bbs-border">
          <h2 class="text-sm font-semibold text-slate-300 flex items-center gap-2">
            <i class="ph ph-user-circle"></i> Your Profile
          </h2>
        </div>
        <div class="p-4 flex flex-col items-center">
          <!-- Mini Profile Card -->
          <div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 flex items-center justify-center text-3xl font-bold mb-3 shadow-glow ring-2 ring-bbs-accent/30 animate-glow-pulse">U</div>
          <div class="text-center mb-5">
            <h3 class="font-bold text-lg" id="profile-name">Username</h3>
            <p class="text-sm text-slate-400 flex items-center justify-center gap-1">
              <i class="ph ph-star text-yellow-400"></i> Local Creator
            </p>
          </div>
          <!-- Mode Toggles -->
          <div class="w-full space-y-2.5">
            <button id="btn-code-mode" class="w-full px-4 py-2.5 text-sm bg-emerald-600/20 hover:bg-emerald-600/30 border border-emerald-600/50 rounded-lg text-emerald-400 font-semibold transition-all duration-200 flex items-center justify-center gap-2 hover:scale-[1.02] hover:shadow-lg active:scale-95">
              <i class="ph-bold ph-lightning"></i> Code Mode
            </button>
            <button id="btn-wall" class="w-full px-4 py-2.5 text-sm bg-purple-600/20 hover:bg-purple-600/30 border border-purple-600/50 rounded-lg text-purple-400 font-semibold transition-all duration-200 flex items-center justify-center gap-2 hover:scale-[1.02] hover:shadow-lg active:scale-95">
              <i class="ph-bold ph-house"></i> My Wall
            </button>
            <button id="btn-internals" class="w-full px-4 py-2.5 text-sm bg-amber-600/20 hover:bg-amber-600/30 border border-amber-600/50 rounded-lg text-amber-400 font-semibold transition-all duration-200 flex items-center justify-center gap-2 hover:scale-[1.02] hover:shadow-lg active:scale-95">
              <i class="ph-bold ph-gear-six"></i> System Internals
            </button>
            <button id="btn-directory" class="w-full px-4 py-2.5 text-sm bg-blue-600/20 hover:bg-blue-600/30 border border-blue-600/50 rounded-lg text-blue-400 font-semibold transition-all duration-200 flex items-center justify-center gap-2 hover:scale-[1.02] hover:shadow-lg active:scale-95">
              <i class="ph-bold ph-users-three"></i> Directory
            </button>
          </div>
        </div>
        <!-- Quick Stats -->
        <div class="mt-auto p-4 border-t border-bbs-border">
          <div class="text-xs text-slate-500 space-y-2">
            <div class="flex justify-between items-center">
              <span class="flex items-center gap-1"><i class="ph ph-chat-dots"></i> Messages</span>
              <span class="text-slate-300 font-semibold bg-slate-700/50 px-2 py-0.5 rounded">42</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="flex items-center gap-1"><i class="ph ph-users"></i> Online</span>
              <span class="text-emerald-400 font-semibold flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span> 3 users
              </span>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Message template (for safe DOM creation) -->
    <template id="message-template">
      <article class="message group bg-bbs-surface hover:bg-slate-700/50 rounded-lg p-3 flex gap-3 transition" data-id="">
        <div class="message-avatar w-9 h-9 rounded-full flex items-center justify-center font-semibold text-sm text-white shrink-0"></div>
        <div class="message-body flex-1 min-w-0">
          <div class="message-header flex items-baseline gap-2 mb-1">
            <span class="message-user font-semibold text-slate-200"></span>
            <span class="message-time text-xs text-slate-500"></span>
            <span class="message-edited text-xs text-slate-500 italic hidden">(edited)</span>
          </div>
          <div class="message-content text-slate-300"></div>
          <div class="inline-editor hidden mt-2">
            <input type="text" class="edit-input w-full px-3 py-1.5 bg-bbs-bg border border-bbs-accent rounded text-sm focus:outline-none" placeholder="Edit message..." />
            <div class="inline-editor-actions flex gap-2 mt-2">
              <button type="button" class="btn-save px-3 py-1 text-sm bg-green-600 hover:bg-green-700 rounded text-white transition">Save</button>
              <button type="button" class="btn-cancel px-3 py-1 text-sm bg-slate-600 hover:bg-slate-500 rounded text-slate-200 transition">Cancel</button>
            </div>
          </div>
        </div>
        <div class="message-actions hidden group-hover:flex gap-1 shrink-0">
          <button type="button" class="btn-edit px-2 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded text-slate-300 transition">Edit</button>
          <button type="button" class="btn-delete px-2 py-1 text-xs bg-red-600/20 hover:bg-red-600 border border-red-600/50 rounded text-red-400 hover:text-white transition">Delete</button>
        </div>
      </article>
    </template>

    <!-- Confirmation modal -->
    <div class="modal-overlay hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50" id="confirm-modal" role="dialog" aria-modal="true">
      <div class="modal bg-bbs-surface rounded-lg p-6 w-80 shadow-xl">
        <h2 class="text-lg font-semibold mb-3" id="modal-title">Delete Message</h2>
        <p class="text-slate-400 mb-6">Are you sure you want to delete this message? This cannot be undone.</p>
        <div class="flex gap-2 justify-end">
          <button type="button" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-slate-200 transition" id="modal-cancel">Cancel</button>
          <button type="button" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-white transition" id="modal-confirm">Delete</button>
        </div>
      </div>
    </div>

    <!-- Scroll to bottom button -->
    <button type="button" class="scroll-bottom-btn fixed bottom-24 right-80 w-10 h-10 rounded-full bg-bbs-accent hover:bg-blue-600 text-white flex items-center justify-center shadow-lg opacity-0 pointer-events-none transition z-40" id="scroll-bottom">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </button>

    <!-- Navigation Script -->
    <script>
      // Current room state
      let currentRoom = 'general';
      
      // Room selection
      document.querySelectorAll('.room-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const room = link.dataset.room;
          if (room === currentRoom) return;
          
          // Update visual state
          document.querySelectorAll('.room-link').forEach(l => {
            l.classList.remove('active', 'bg-bbs-accent/20', 'text-bbs-accent');
            l.classList.add('text-slate-400');
          });
          link.classList.add('active', 'bg-bbs-accent/20', 'text-bbs-accent');
          link.classList.remove('text-slate-400');
          
          // Update header
          const prefix = room.startsWith('dm-') ? '' : '# ';
          const displayName = room.startsWith('dm-') ? room.replace('dm-', '') : room;
          document.getElementById('current-room-name').textContent = prefix + displayName;
          
          // Update current room and clear messages (placeholder for real room switching)
          currentRoom = room;
          document.getElementById('messages').innerHTML = '';
          console.log('Switched to room:', room);
          
          // TODO: In real implementation, emit socket event to join room
          // socket.emit('join_room', { room });
        });
      });
      
      // Mode Toggle Navigation
      document.getElementById('btn-code-mode').addEventListener('click', () => {
        window.location.href = '/ui/views/playground.html';
      });
      document.getElementById('btn-wall').addEventListener('click', () => {
        window.location.href = '/ui/views/wall.html';
      });
      document.getElementById('btn-internals').addEventListener('click', () => {
        window.location.href = '/ui/views/internals.html';
      });
      document.getElementById('btn-directory').addEventListener('click', () => {
        window.location.href = '/ui/views/directory.html';
      });
      
          // Fetch current user info
        fetch('/auth/me')
        .then(res => res.json())
        .then(data => {
            if (data.logged_in) {
                document.getElementById('profile-name').textContent = data.username;
                localStorage.setItem('localbbs_username', data.username); // Keep for legacy socket glue
                // Update avatar color
                const avatar = document.querySelector('.rounded-full.bg-gradient-to-br');
                if (data.avatar_color) {
                     // Could map class color here, for now simpler logic
                     avatar.textContent = data.username.charAt(0).toUpperCase();
                }
            } else {
                window.location.href = '/auth/login';
            }
        });

      // Mobile Menu Logic
      const sidebar = document.getElementById('sidebar');
      const openBtn = document.getElementById('open-sidebar');
      const closeBtn = document.getElementById('close-sidebar');

      openBtn.addEventListener('click', () => {
        sidebar.classList.remove('-translate-x-full');
      });

      closeBtn.addEventListener('click', () => {
        sidebar.classList.add('-translate-x-full');
      });
      // Close on link click (mobile)
      sidebar.querySelectorAll('a').forEach(l => {
         l.addEventListener('click', () => {
            if (window.innerWidth < 768) { // md breakpoint
                sidebar.classList.add('-translate-x-full');
            }
         });
      });

    </script>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="/ui/js/socket_glue.js?v=2" defer></script>
  </body>
</html>
